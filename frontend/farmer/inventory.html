<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Inventory Management | Caravan of Flavours</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <script src="../assets/js/custom-ui.js?v=1.6"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF7E21',
                        'primary-hover': '#E66D1A',
                        'bg-dark': '#0C0A09',
                        'bg-dashboard': '#14110F',
                        'card-bg': '#1C1917',
                        'border-color': '#292524',
                    }
                }
            }
        }
    </script>
</head>

<body style="background: #fafaf9; color: #1c1917; font-family: 'Outfit', sans-serif;">
    <aside
        style="width: 200px; background: white; border-right: 1px solid #e7e5e4; position: fixed; height: 100vh; padding: 24px; z-index: 50; overflow-y: auto;">
        <div class="logo" style="margin-bottom: 40px; display: flex; align-items: center; gap: 14px;">
            <img src="../assets/images/logo.png" alt="Logo" style="height: 42px; width: auto; object-fit: contain;">
            <div style="display: flex; flex-direction: column;">
                <h3
                    style="font-size: 18px; color: #1c1917; font-weight: 700; line-height: 1.1; letter-spacing: -0.02em;">
                    Caravan</h3>
                <small
                    style="font-size: 10px; color: #a8a29e; letter-spacing: 0.1em; font-weight: 700; text-transform: uppercase;">Of
                    Flavours</small>
            </div>
        </div>

        <nav style="display: flex; flex-direction: column; gap: 4px;">
            <a href="farmer-dashboard.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:layout-dashboard.svg?color=%231c1917" width="18" alt="">
                Dashboard
            </a>
            <a href="inventory.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: white; background: #FF7E21; font-weight: 700; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:package.svg?color=white" width="18" alt="">
                Inventory
            </a>
            <a href="orders.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:shopping-cart.svg?color=%231c1917" width="18" alt="">
                Orders
            </a>
            <a href="auctions.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:gavel.svg?color=%231c1917" width="18" alt="">
                Auctions
            </a>
            <a href="analysis.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:bar-chart-3.svg?color=%231c1917" width="18" alt="">
                Analysis
            </a>
            <a href="profile.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:user.svg?color=%231c1917" width="18" alt="">
                Profile
            </a>
        </nav>

        <div style="position: absolute; bottom: 24px; left: 24px; right: 24px;">
            <button onclick="logout()"
                style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #ff0000; background: transparent; border: 2px solid #ff0000; width: 100%; cursor: pointer; font-weight: 700; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:log-out.svg?color=%23ff0000" width="18"
                    style="transform: rotate(180deg);" alt="">
                Sign Out
            </button>
        </div>
    </aside>

    <main style="margin-left: 200px; padding: 32px 40px;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
            <div>
                <h1 style="font-size: 24px; font-weight: 700; color: #1c1917;">Inventory</h1>
                <p style="font-size: 14px; color: #1c1917; margin-top: 4px;">Manage your spice stock levels and
                    listings.</p>
            </div>

            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="position: relative;">
                    <button onclick="toggleThresholdSettings()"
                        class="bg-white border border-[#e7e5e4] hover:bg-stone-50 text-[#1c1917] px-4 py-3 rounded-xl font-bold text-sm flex items-center gap-2 transition-all">
                        <img src="https://api.iconify.design/lucide:settings-2.svg?color=%231c1917" width="18" alt="">
                        Update Threshold
                    </button>
                    <!-- Threshold Settings Panel -->
                    <div id="threshold-panel"
                        class="hidden absolute right-0 mt-2 w-72 bg-white border border-[#e7e5e4] rounded-24 shadow-2xl p-6 z-50">
                        <button onclick="toggleThresholdSettings()"
                            class="absolute top-4 right-4 text-stone-400 hover:text-stone-600 transition-colors">
                            <img src="https://api.iconify.design/lucide:x.svg?color=%23a8a29e" width="16" alt="Close">
                        </button>
                        <h3 class="text-sm font-bold text-[#1c1917] mb-2 uppercase tracking-wider">Low Stock
                            Notification</h3>
                        <p class="text-xs text-stone-500 mb-4">Set the quantity level that triggers a "Low Stock"
                            warning.</p>

                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] font-bold text-stone-400 uppercase">Threshold (kg)</label>
                                <input type="number" id="threshold-input"
                                    class="w-full bg-[#fafaf9] border border-[#e7e5e4] rounded-xl px-4 py-2 text-sm outline-none focus:border-primary mt-1">
                            </div>
                            <button onclick="saveThreshold()" id="save-threshold-btn"
                                class="w-full bg-[#1c1917] text-white py-2.5 rounded-xl text-sm font-bold hover:bg-stone-800 transition-all">
                                Update Limit
                            </button>
                        </div>
                    </div>
                </div>

                <button
                    class="bg-primary hover:bg-primary-hover text-white px-6 py-3 rounded-xl font-bold text-sm flex items-center gap-2 transition-all shadow-lg shadow-primary/20"
                    onclick="openAddProductModal()">
                    <img src="https://api.iconify.design/lucide:plus.svg?color=white" width="18" alt="">
                    Add Product
                </button>
            </div>
        </header>

        <!-- Product Table Container -->
        <div
            style="background: white; border: 1px solid #e7e5e4; border-radius: 20px; padding: 0; overflow: hidden; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
            <div
                style="padding: 24px; border-bottom: 1px solid #e7e5e4; display: flex; flex-direction: column; gap: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-weight: 700; font-size: 16px;">Product List</h3>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="filter-count" class="text-[10px] font-bold text-stone-400 uppercase">All
                            Products</span>
                    </div>
                </div>

                <div style="display: flex; gap: 16px; align-items: center; justify-content: space-between;">
                    <!-- Search Input (Reduced size) -->
                    <div style="position: relative; width: 320px;">
                        <img src="https://api.iconify.design/lucide:search.svg?color=%23a8a29e"
                            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px;"
                            alt="">
                        <input type="text" id="inventory-search" placeholder="Search products..."
                            oninput="handleSearch(this.value)"
                            class="w-full bg-[#fafaf9] border border-[#e7e5e4] rounded-xl pl-10 pr-4 py-2.5 text-sm outline-none focus:border-primary transition-all">
                    </div>

                    <!-- Filter Buttons (Increased size) -->
                    <div
                        style="display: flex; background: #fafaf9; padding: 6px; border-radius: 14px; border: 1px solid #e7e5e4; gap: 4px;">
                        <button onclick="setFilter('all')" id="filter-all" class="filter-btn active-filter">All
                            Products</button>
                        <button onclick="setFilter('low')" id="filter-low" class="filter-btn">Low Stock</button>
                        <button onclick="setFilter('out')" id="filter-out" class="filter-btn">Out of Stock</button>
                    </div>
                </div>
            </div>

            <style>
                .filter-btn {
                    padding: 10px 24px;
                    font-size: 13px;
                    font-weight: 700;
                    border-radius: 10px;
                    transition: all 0.2s;
                    color: #78716c;
                    cursor: pointer;
                    border: none;
                    background: transparent;
                    white-space: nowrap;
                }

                .filter-btn:hover {
                    color: #1c1917;
                    background: rgba(0, 0, 0, 0.02);
                }

                .filter-btn.active-filter {
                    background: white;
                    color: #1c1917;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                }
            </style>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #fafaf9; border-bottom: 1px solid #e7e5e4;">
                        <th
                            style="text-align: left; padding: 16px 24px; font-size: 11px; color: #1c1917; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;">
                            Product</th>
                        <th
                            style="text-align: center; padding: 16px 24px; font-size: 11px; color: #1c1917; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;">
                            Stock Level</th>
                        <!-- Description column removed -->
                        <th
                            style="text-align: center; padding: 16px 24px; font-size: 11px; color: #1c1917; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;">
                            Price</th>
                        <th
                            style="text-align: center; padding: 16px 24px; font-size: 11px; color: #1c1917; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;">
                            Actions</th>
                    </tr>
                </thead>
                <tbody id="product-table-body">
                    <!-- Products will be loaded here dynamically -->
                    <tr>
                        <td colspan="5" style="padding: 60px; text-align: center; color: #1c1917;">
                            <div class="flex flex-col items-center gap-3">
                                <img src="https://api.iconify.design/lucide:loader-2.svg"
                                    class="w-8 h-8 animate-spin text-primary" alt="">
                                <p class="text-sm font-medium">Loading inventory...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div
                style="padding: 20px 24px; border-top: 1px solid #e7e5e4; display: flex; justify-content: space-between; align-items: center; background: #fafaf9;">
                <span id="pagination-info" style="font-size: 13px; color: #1c1917;">Showing 0-0 of 0 products</span>
                <div style="display: flex; gap: 4px;">
                    <button id="prev-btn" onclick="prevPage()"
                        style="padding: 6px 12px; border: 1px solid #e7e5e4; background: white; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">Prev</button>
                    <button id="next-btn" onclick="nextPage()"
                        style="padding: 6px 12px; border: 1px solid #e7e5e4; background: white; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">Next</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal and Form (Same logic as current dash) -->
    <div id="product-modal"
        class="fixed inset-0 z-[100] hidden items-center justify-center p-6 bg-black/60 backdrop-blur-sm">
        <div
            class="bg-white border border-stone-200 rounded-[32px] p-8 max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 id="modal-title" class="text-2xl font-bold text-stone-900">Add New Product</h3>
                    <p id="modal-subtitle" class="text-stone-500 text-sm mt-1">List your fresh harvest for the world to
                        see.</p>
                </div>
                <button onclick="closeProductModal()"
                    class="w-10 h-10 rounded-full hover:bg-stone-100 flex items-center justify-center transition-all">
                    <img src="https://api.iconify.design/lucide:x.svg?color=%231c1917" class="w-6 h-6" alt="Close">
                </button>
            </div>

            <form id="add-product-form" onsubmit="submitProduct(event)" class="space-y-6">
                <input type="hidden" name="product_id" id="edit-product-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2 md:col-span-2">
                        <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-wider">Product
                            Name</label>
                        <input type="text" name="product_name" placeholder="e.g. Ground Turmeric"
                            class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm focus:border-primary outline-none transition-all">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-wider">Price (<span
                                class="currency-code"></span>/kg)</label>
                        <div class="relative">
                            <span
                                class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 currency-symbol">$</span>
                            <input type="number" step="0.01" name="price" placeholder="25.00" min="0.01"
                                onkeydown="return ['e', 'E', '+', '-'].includes(event.key) ? false : true"
                                class="w-full bg-stone-50 border border-stone-200 rounded-xl pl-8 pr-4 py-3 text-sm focus:border-primary outline-none transition-all">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-wider">Quantity
                            (kg)</label>
                        <div class="flex gap-2">
                            <input type="number" step="any" name="quantity" placeholder="100.0" min="0"
                                onkeydown="return ['e', 'E', '+', '-'].includes(event.key) ? false : true"
                                class="flex-1 bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm focus:border-primary outline-none transition-all">
                            <input type="hidden" name="unit" value="kg">
                        </div>
                    </div>
                </div>

                <!-- Description field removed -->

                <div class="space-y-2">
                    <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-wider">Product
                        Image</label>
                    <div id="image-dropzone" onclick="document.getElementById('product-image').click()"
                        class="relative h-80 border-2 border-dashed border-stone-200 rounded-2xl p-8 flex flex-col items-center justify-center gap-3 cursor-pointer hover:border-primary/50 hover:bg-orange-50/10 transition-all group">
                        <input type="file" id="product-image" name="image" accept="image/*,.svg" class="hidden"
                            onchange="previewImage(this)">
                        <div id="preview-container"
                            class="hidden absolute inset-0 bg-white rounded-2xl overflow-hidden">
                            <img id="image-preview" src="#" alt="Preview" class="w-full h-full object-contain">
                        </div>
                        <div id="upload-placeholder" class="text-center">
                            <img src="https://api.iconify.design/lucide:image.svg"
                                class="w-8 h-8 mx-auto mb-2 text-stone-400 group-hover:text-primary transition-colors"
                                alt="">
                            <p class="text-sm font-semibold text-stone-600">Click to upload image</p>
                            <p class="text-[10px] text-stone-400 uppercase mt-1">Required: JPG, PNG, WEBP, SVG</p>
                        </div>
                    </div>
                </div>

                <div class="pt-4 flex gap-4">
                    <button type="button" onclick="closeProductModal()"
                        class="flex-1 px-8 py-4 rounded-2xl border border-stone-200 text-stone-600 font-bold text-sm hover:bg-stone-50 transition-all">CANCEL</button>
                    <button type="submit" id="submit-btn"
                        class="flex-[2] bg-primary hover:bg-primary-hover text-white py-4 rounded-2xl font-bold text-sm tracking-widest transition-all shadow-lg hover:shadow-primary/20 flex items-center justify-center gap-3">
                        SAVE PRODUCT
                        <img src="https://api.iconify.design/lucide:check.svg?color=white" class="w-5 h-5" alt="">
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        async function logout() {
            try {
                await fetch('../../backend/api/auth/logout.php');
                window.location.href = '../auth/login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showModal() {
            const modal = document.getElementById('product-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function openAddProductModal() {
            // Reset Modal state for "ADD" mode
            document.getElementById('modal-title').textContent = 'Add New Product';
            document.getElementById('modal-subtitle').textContent = 'List your fresh harvest for the world to see.';
            document.getElementById('submit-btn').innerHTML = 'SAVE PRODUCT <img src="https://api.iconify.design/lucide:check.svg?color=white" class="w-5 h-5" alt="">';
            document.getElementById('edit-product-id').value = '';

            const form = document.getElementById('add-product-form');
            form.reset();

            // Reset preview
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');

            showModal();
        }

        function closeProductModal() {
            const modal = document.getElementById('product-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
            document.getElementById('add-product-form').reset();
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const container = document.getElementById('preview-container');
            const placeholder = document.getElementById('upload-placeholder');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    container.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.onload = () => {
            // Initialize currency in background - don't await!
            // It will trigger auto-refresh when done.
            CurrencyManager.init();
            // Load content immediately
            loadProducts();
        };

        let allProducts = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let lowStockThreshold = 100; // Default
        let currentFilter = 'all'; // all, low, out
        let searchQuery = '';

        function handleSearch(val) {
            searchQuery = val.toLowerCase();
            currentPage = 1;
            renderProducts();
        }

        function setFilter(filter) {
            currentFilter = filter;
            currentPage = 1;

            // Update UI
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active-filter'));
            document.getElementById(`filter-${filter}`).classList.add('active-filter');

            renderProducts();
        }

        function toggleThresholdSettings() {
            const panel = document.getElementById('threshold-panel');
            panel.classList.toggle('hidden');
        }

        async function saveThreshold() {
            const btn = document.getElementById('save-threshold-btn');
            const newThreshold = document.getElementById('threshold-input').value;

            if (!newThreshold || newThreshold < 1) {
                showToast('Please enter a valid threshold (min 1).', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Updating...';

            try {
                // Fetch current profile to get names/emails required by update-profile.php
                const profileRes = await fetch('../../backend/api/auth/get-profile.php');
                const profileData = await profileRes.json();

                if (!profileData.success) throw new Exception('Profile fetch failed');

                const formData = new FormData();
                formData.append('full_name', profileData.data.full_name);
                formData.append('low_stock_threshold', newThreshold);

                const response = await fetch('../../backend/api/auth/update-profile.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Low stock threshold updated!', 'success');
                    lowStockThreshold = parseInt(newThreshold);
                    toggleThresholdSettings();
                    loadProducts(); // Reload to refresh highlighting
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Threshold update error:', error);
                showToast('Connection failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Update Limit';
            }
        }

        async function loadProducts() {
            const tableBody = document.getElementById('product-table-body');
            try {
                // Fetch stats to get current threshold
                const statsResponse = await fetch('../../backend/api/analytics/get-farmer-stats.php');
                const statsResult = await statsResponse.json();
                if (statsResult.success) {
                    lowStockThreshold = statsResult.stats.low_stock_threshold || 100;
                    document.getElementById('threshold-input').value = lowStockThreshold;
                }

                // Ensure table is showing loading state if called again
                if (!tableBody.querySelector('.animate-spin')) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" style="padding: 60px; text-align: center;">
                                <div class="flex flex-col items-center gap-3">
                                    <img src="https://api.iconify.design/lucide:loader-2.svg" class="w-8 h-8 animate-spin text-primary">
                                    <p class="text-sm font-medium text-stone-500">Syncing inventory...</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }

                const response = await fetch('../../backend/api/products/get-farmer-products.php');
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    allProducts = result.data;
                    renderProducts();
                } else {
                    renderEmptyInventory();
                }
            } catch (error) {
                console.error('Fetch error:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="padding: 60px; text-align: center;">
                            <div class="flex flex-col items-center gap-4">
                                <img src="https://api.iconify.design/lucide:alert-circle.svg?color=%23ef4444" class="w-12 h-12 opacity-40">
                                <div class="text-center">
                                    <p class="font-bold text-stone-900">Connection Failed</p>
                                    <p class="text-xs text-stone-500 mt-1">Unable to reach the inventory server</p>
                                </div>
                                <button onclick="loadProducts()" class="bg-primary text-white px-6 py-2 rounded-lg font-bold text-xs uppercase tracking-widest hover:bg-primary-hover transition-all shadow-lg shadow-primary/20 mt-2">RETRY SYNC</button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function renderProducts() {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = '';

            const symbol = CurrencyManager.getSymbol();

            // Apply Filters and Search
            let filtered = allProducts.filter(p => {
                const matchesSearch = p.product_name.toLowerCase().includes(searchQuery) ||
                    p.id.toString().includes(searchQuery);

                let matchesFilter = true;
                if (currentFilter === 'low') {
                    matchesFilter = parseFloat(p.quantity) < lowStockThreshold && parseFloat(p.quantity) > 0;
                } else if (currentFilter === 'out') {
                    matchesFilter = parseFloat(p.quantity) <= 0;
                }

                return matchesSearch && matchesFilter;
            });

            const totalItems = filtered.length;

            // Update filter count text
            const countEl = document.getElementById('filter-count');
            if (searchQuery || currentFilter !== 'all') {
                countEl.textContent = `Found ${totalItems} product${totalItems !== 1 ? 's' : ''}`;
            } else {
                countEl.textContent = `All Products (${allProducts.length})`;
            }

            if (totalItems === 0) {
                renderEmptySearchResults();
                updatePaginationInfo(0, 0, 0);
                return;
            }

            // Calculate slice range
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const currentProducts = filtered.slice(startIndex, endIndex);

            currentProducts.forEach(product => {
                const imageUrl = product.image_url ? `../../${product.image_url}` : 'https://placehold.co/400x400/1c1917/FF7E21?text=Spice';
                const status = getStatus(product.quantity);

                // Row Highlight Color
                let rowBg = 'transparent';
                if (parseFloat(product.quantity) <= 0) {
                    rowBg = '#fef2f2'; // Red tint for Out of Stock
                } else if (parseFloat(product.quantity) < lowStockThreshold) {
                    rowBg = '#fffbeb'; // Yellow tint for Low Stock
                }

                const row = `
                    <tr style="border-bottom: 1px solid #f5f5f4; background: ${rowBg}; transition: all 0.2s;" class="hover:opacity-80 group">
                        <td style="padding: 16px 24px;">
                            <div style="display: flex; align-items: center; gap: 14px;">
                                <div style="width: 44px; height: 44px; border-radius: 10px; overflow: hidden; background: #f5f5f4; border: 1px solid #e7e5e4;">
                                    <img src="${imageUrl}" class="w-full h-full object-cover" alt="">
                                </div>
                                <div>
                                    <div style="font-weight: 700; font-size: 14px; color: #1c1917;">${product.product_name}</div>
                                    <div style="font-size: 11px; color: #a8a29e;">REF: ${product.id.toString().padStart(6, '0')}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 16px 24px; text-align: center;">
                            <div class="flex flex-col items-center gap-1">
                                <span style="font-size: 14px; font-weight: 700; color: #1c1917;">
                                    ${product.unit === 'g' ? (product.quantity / 1000).toFixed(2) : parseFloat(product.quantity)} <small style="color: #a8a29e; font-weight: 400;">kg</small>
                                </span>
                                <span style="font-size: 9px; font-bold; padding: 2px 8px; border-radius: 99px; background: ${status.bg}; color: ${status.text}; white-space: nowrap;">
                                    ${status.label}
                                </span>
                            </div>
                        </td>
                        <!-- Description cell removed -->
                        <td style="padding: 16px 24px; font-size: 14px; font-weight: 700; color: #1c1917; text-align: center;">
                            <div style="font-weight: 700; color: #1c1917; font-size: 14px;">
                                ${CurrencyManager.format(product.price)}
                            </div>
                        </td>
                        <td style="padding: 16px 24px; text-align: center;">
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <button onclick="editProduct(this.dataset.id)" data-id="${product.id}" style="background: #f5f5f4; border: none; cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='#e7e5e4'" onmouseout="this.style.background='#f5f5f4'">
                                    <img src="https://api.iconify.design/lucide:edit-2.svg?color=%231c1917" width="16" alt="Edit">
                                </button>
                                <button onclick="deleteProduct(this.dataset.id)" data-id="${product.id}" style="background: #fef2f2; border: none; cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='#fef2f2'">
                                    <img src="https://api.iconify.design/lucide:trash-2.svg?color=%23ff0000" width="16" alt="Delete">
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            updatePaginationControls(totalItems, startIndex + 1, endIndex);
        }

        function updatePaginationInfo(start, end, total) {
            const info = document.getElementById('pagination-info');
            if (total === 0) {
                info.textContent = 'Showing 0 products';
            } else {
                info.textContent = `Showing ${start}-${end} of ${total} products`;
            }
        }

        function updatePaginationControls(total, start, end) {
            updatePaginationInfo(start, end, total);

            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            prevBtn.disabled = currentPage === 1;
            prevBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
            prevBtn.style.cursor = currentPage === 1 ? 'not-allowed' : 'pointer';

            const totalPages = Math.ceil(total / itemsPerPage);
            nextBtn.disabled = currentPage >= totalPages;
            nextBtn.style.opacity = currentPage >= totalPages ? '0.5' : '1';
            nextBtn.style.cursor = currentPage >= totalPages ? 'not-allowed' : 'pointer';
        }

        function nextPage() {
            const totalPages = Math.ceil(allProducts.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderProducts();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderProducts();
            }
        }

        function renderEmptySearchResults() {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="padding: 80px 24px; text-align: center;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                            <div style="background: #fafaf9; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <img src="https://api.iconify.design/lucide:search-x.svg?color=%23a8a29e" width="32" alt="">
                            </div>
                            <div>
                                <h3 style="font-size: 16px; font-weight: 700; color: #1c1917;">No products found</h3>
                                <p style="font-size: 14px; color: #a8a29e; margin-top: 4px;">Try adjusting your search or filters.</p>
                            </div>
                            <button onclick="resetFilters()" class="text-primary font-bold text-sm hover:underline">Clear all filters</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function resetFilters() {
            document.getElementById('inventory-search').value = '';
            searchQuery = '';
            setFilter('all');
        }

        function renderEmptyInventory() {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="padding: 60px; text-align: center;">
                        <img src="https://api.iconify.design/lucide:package-open.svg?color=%23a8a29e" class="w-12 h-12 mx-auto mb-4 opacity-20" alt="">
                        <p style="color: #1c1917; font-size: 14px;">Your inventory is empty</p>
                        <button onclick="openAddProductModal()" style="margin-top: 16px; color: #FF7E21; font-weight: 700; font-size: 13px;">Add your first product</button>
                    </td>
                </tr>
            `;
        }

        async function editProduct(id) {
            const product = allProducts.find(p => p.id == id);
            if (!product) return;

            document.getElementById('modal-title').textContent = 'Edit Product';
            document.getElementById('modal-subtitle').textContent = 'Update your product details and availability.';
            document.getElementById('submit-btn').innerHTML = 'UPDATE PRODUCT <img src="https://api.iconify.design/lucide:check.svg?color=white" class="w-5 h-5" alt="">';

            const form = document.getElementById('add-product-form');
            form.product_id.value = product.id;
            form.product_name.value = product.product_name;

            // Convert Price for Display with magnitude-aware snapping
            const rate = (window.CurrencyManager && window.CurrencyManager.settings && window.CurrencyManager.settings.rate) ? window.CurrencyManager.settings.rate : 1;
            let val = (parseFloat(product.price) * rate);

            form.price.value = parseFloat(val.toFixed(2));

            form.quantity.value = product.quantity;
            form.unit.value = product.unit || 'kg';
            // form.description.value = product.description; // Removed
            // form.category.value = product.category || 'Whole Spices'; // Removed

            // Handle preview
            const preview = document.getElementById('image-preview');
            const container = document.getElementById('preview-container');
            const placeholder = document.getElementById('upload-placeholder');

            if (product.image_url) {
                preview.src = '../../' + product.image_url;
                container.classList.remove('hidden');
                placeholder.classList.add('hidden');
                document.getElementById('product-image').required = false; // Not required when editing
            } else {
                container.classList.add('hidden');
                placeholder.classList.remove('hidden');
                // document.getElementById('product-image').required = true;
            }

            showModal();
        }

        async function deleteProduct(id) {
            console.log('deleteProduct called for ID:', id, typeof id);

            try {
                if (typeof showConfirm !== 'function') {
                    console.error('showConfirm is not defined! Check path to custom-ui.js');
                    if (confirm('Are you sure you want to delete? (Fallback)')) {
                        // proceed (fallback logic if needed, or just return to debug)
                    } else {
                        return;
                    }
                } else {
                    if (!await showConfirm('Are you sure you want to delete this product? This action cannot be undone.')) return;
                }

                // Convert ID to match potential backend expectation (int/string mix)
                // If it was numeric before stringification, convert it back?
                // Depending on backend, often safe to send as is, but let's be robust
                // const payloadId = isNaN(id) ? id : Number(id); 
                // Actually, let's stick to what we have but log it.

                const response = await fetch('../../backend/api/products/delete-product.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: id })
                });

                const result = await response.json();
                console.log('Delete result:', result);

                if (result.success) {
                    loadProducts();
                    if (typeof showToast === 'function') showToast('Product deleted successfully', 'success');
                } else {
                    if (typeof showToast === 'function') showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                if (typeof showToast === 'function') showToast('Connection error: ' + error.message, 'error');
            }
        }
        window.deleteProduct = deleteProduct;

        function getStatus(qty) {
            qty = parseFloat(qty);
            if (qty >= lowStockThreshold) return { label: 'IN STOCK', bg: 'rgba(16, 185, 129, 0.1)', text: '#10B981' };
            if (qty > 0) return { label: 'LOW STOCK', bg: 'rgba(234, 179, 8, 0.1)', text: '#eab308' };
            return { label: 'OUT OF STOCK', bg: 'rgba(239, 68, 68, 0.1)', text: '#ff0000' };
        }

        async function submitProduct(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            // Validation
            const name = formData.get('product_name');
            const price = formData.get('price');
            const qty = formData.get('quantity');
            const unit = formData.get('unit');
            // const desc = formData.get('description'); // Removed
            const imageInput = document.getElementById('product-image');
            const productId = formData.get('product_id');

            if (!name || !name.trim()) {
                showToast('Please enter the product name.', 'error');
                return;
            }
            if (!price || !price.trim()) {
                showToast('Please enter the price.', 'error');
                return;
            }
            if (!qty || !qty.trim()) {
                showToast('Please enter the quantity.', 'error');
                return;
            }
            if (parseFloat(qty) < 0) {
                showToast('Quantity cannot be negative.', 'error');
                return;
            }
            if (parseFloat(price) <= 0) {
                showToast('Price must be greater than zero.', 'error');
                return;
            }
            /* if (!desc || !desc.trim()) {
                showToast('Please enter the description.', 'error');
                return;
            } */
            if (!productId && (!imageInput.files || imageInput.files.length === 0)) {
                showToast('Please upload a product image.', 'error');
                return;
            }

            // Send the raw price. The server will handle conversion to USD for storage.
            formData.set('price', price);

            const btn = form.querySelector('button[type="submit"]');
            const apiUrl = productId ? '../../backend/api/products/update-product.php' : '../../backend/api/products/add-product.php';

            btn.disabled = true;
            btn.innerHTML = productId ? 'UPDATING...' : 'SAVING...';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    // Instant Sync: Update local currency rates immediately from the response
                    if (result.rates && window.CurrencyManager) {
                        window.CurrencyManager.updateRates(result.rates);
                    }
                    closeProductModal();
                    loadProducts();
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showToast('Connection error', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = productId ? 'UPDATE PRODUCT' : 'ADD PRODUCT';
            }
        }
    </script>
    <script src="../assets/js/main.js?v=2.2"></script>
</body>

</html>