<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders | Caravan of Flavours</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <script src="../assets/js/custom-ui.js?v=1.8"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF7E21',
                        'primary-hover': '#E66D1A',
                        'bg-dark': '#0C0A09',
                    }
                }
            }
        }
    </script>
</head>

<body style="background: #fafaf9; color: #1c1917; font-family: 'Outfit', sans-serif;">
    <aside
        style="width: 200px; background: white; border-right: 1px solid #e7e5e4; position: fixed; height: 100vh; padding: 24px; z-index: 50; overflow-y: auto;">
        <div class="logo" style="margin-bottom: 40px; display: flex; align-items: center; gap: 14px;">
            <img src="../assets/images/logo.png" alt="Logo" style="height: 42px; width: auto; object-fit: contain;">
            <div style="display: flex; flex-direction: column;">
                <h3
                    style="font-size: 18px; color: #1c1917; font-weight: 700; line-height: 1.1; letter-spacing: -0.02em;">
                    Caravan</h3>
                <small
                    style="font-size: 10px; color: #a8a29e; letter-spacing: 0.1em; font-weight: 700; text-transform: uppercase;">Of
                    Flavours</small>
            </div>
        </div>

        <nav style="display: flex; flex-direction: column; gap: 4px;">
            <a href="customer-dashboard.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:layout-dashboard.svg?color=%231c1917" width="18" alt="">
                Dashboard
            </a>
            <a href="catalog.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:book-open.svg?color=%231c1917" width="18" alt="">
                Catalog
            </a>
            <a href="orders.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: white; background: #FF7E21; font-weight: 700; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:shopping-bag.svg?color=white" width="18" alt="">
                Orders
            </a>
            <a href="cart.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:shopping-cart.svg?color=%231c1917" width="18" alt="">
                Cart
            </a>
            <a href="bulk-orders.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:boxes.svg?color=%231c1917" width="18" alt="">
                Bulk Order
            </a>
            <a href="auctions.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:gavel.svg?color=%231c1917" width="18" alt="">
                Auctions
            </a>
            <a href="market-analytics.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:trending-up.svg?color=%231c1917" width="18" alt="">
                Analytics
            </a>

            <a href="profile.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:user.svg?color=%231c1917" width="18" alt="">
                Profile
            </a>
        </nav>

        <div style="position: absolute; bottom: 24px; left: 24px; right: 24px;">
            <button onclick="logout()"
                style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #ff0000; background: transparent; border: 2px solid #ff0000; width: 100%; cursor: pointer; font-weight: 700; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:log-out.svg?color=%23ff0000" width="18"
                    style="transform: rotate(180deg);" alt="">
                Sign Out
            </button>
        </div>
        <script>
            async function logout() {
                try {
                    await fetch('../../backend/api/auth/logout.php');
                    window.location.href = '../auth/login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
        </script>
    </aside>

    <main style="margin-left: 200px; padding: 32px 40px;">
        <header style="margin-bottom: 56px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 style="font-size: 32px; font-weight: 700; color: #1c1917; letter-spacing: -0.02em;">Order History
                </h1>
                <p style="font-size: 15px; color: #1c1917; margin-top: 4px;">Track your spice harvests from farm to
                    table.</p>
            </div>
        </header>

        <div class="flex gap-4 overflow-x-auto pb-6 mb-6 no-scrollbar" id="filter-container">
            <button onclick="filterOrders('all')"
                class="filter-btn active px-6 py-2 rounded-full text-sm font-bold bg-stone-900 text-white transition-all whitespace-nowrap">All</button>
            <button onclick="filterOrders('ordered')"
                class="filter-btn px-6 py-2 rounded-full text-sm font-bold bg-white text-stone-500 hover:bg-stone-100 transition-all whitespace-nowrap">Ordered</button>
            <button onclick="filterOrders('shipped')"
                class="filter-btn px-6 py-2 rounded-full text-sm font-bold bg-white text-stone-500 hover:bg-stone-100 transition-all whitespace-nowrap">Shipped</button>
            <button onclick="filterOrders('delivered')"
                class="filter-btn px-6 py-2 rounded-full text-sm font-bold bg-white text-stone-500 hover:bg-stone-100 transition-all whitespace-nowrap">Delivered</button>
            <button onclick="filterOrders('cancelled')"
                class="filter-btn px-6 py-2 rounded-full text-sm font-bold bg-white text-stone-500 hover:bg-stone-100 transition-all whitespace-nowrap">Cancelled</button>
        </div>

        <div id="orders-list" class="space-y-6">
            <!-- Loading State -->
            <div class="py-40 text-center">
                <img src="https://api.iconify.design/lucide:loader-2.svg"
                    class="w-10 h-10 animate-spin mx-auto text-primary mb-4">
                <p class="text-stone-400 font-bold uppercase tracking-widest text-[10px]">Syncing with local farms...
                </p>
            </div>
        </div>
    </main>

    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>

    <!-- Review Modal (Unchanged) -->
    <div id="reviewModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[40px] w-full max-w-lg relative shadow-2xl animate-in zoom-in-95 duration-200"
            onclick="event.stopPropagation()">
            <button onclick="closeReviewModal()" class="absolute top-8 right-8 text-stone-400 hover:text-stone-600">
                <img src="https://api.iconify.design/lucide:x.svg" width="28">
            </button>
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-stone-900 tracking-tight">Rate your Harvest</h2>
                <p id="review-product-name"
                    class="text-stone-500 mt-2 text-sm font-semibold uppercase tracking-widest text-primary"></p>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-widest mb-4">Your
                        Rating</label>
                    <div class="flex gap-4 justify-center bg-stone-50 p-6 rounded-3xl border border-stone-100">
                        <template id="star-template">
                            <button class="star-btn transition-all transform hover:scale-110">
                                <img src="https://api.iconify.design/lucide:star.svg?color=%23d6d3d1" width="32"
                                    class="star-icon">
                            </button>
                        </template>
                        <div id="stars-container" class="flex gap-2"></div>
                    </div>
                </div>

                <div>
                    <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-widest mb-2">Share your
                        experience</label>
                    <textarea id="review-text" rows="4" placeholder="How was the quality, aroma, and flavor?"
                        class="w-full px-5 py-4 bg-stone-50 border border-stone-100 rounded-2xl focus:border-primary outline-none transition-all text-sm font-semibold resize-none"></textarea>
                </div>

                <button onclick="submitReview()" id="submit-review-btn"
                    class="w-full bg-stone-900 hover:bg-black text-white py-5 rounded-[24px] font-bold text-sm tracking-widest shadow-2xl transition-all transform hover:-translate-y-1">
                    PUBLISH REVIEW
                </button>
            </div>
        </div>
    </div>

    <!-- Tracking Modal -->
    <div id="trackModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-[32px] w-full max-w-lg relative shadow-2xl animate-in zoom-in-95 duration-200"
            onclick="event.stopPropagation()">
            <button onclick="closeTrackModal()" class="absolute top-8 right-8 text-stone-400 hover:text-stone-600">
                <img src="https://api.iconify.design/lucide:x.svg" width="24">
            </button>
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-stone-900 tracking-tight mb-1">Track Order</h2>
                <p id="track-order-id" class="text-xs font-bold text-stone-400 uppercase tracking-widest"></p>
            </div>

            <div class="relative pl-8 border-l-2 border-stone-100 space-y-10" id="track-timeline">
                <!-- Timeline items injected here -->
            </div>
        </div>
    </div>

    <script>
        let currentReviewData = null;
        let currentRating = 5;
        let allOrders = [];
        let currentFilter = 'all';

        async function loadOrders() {
            try {
                const response = await fetch('../../backend/api/orders/get-customer-orders.php');
                const result = await response.json();

                if (result.success) {
                    allOrders = result.orders;
                    filterOrders(currentFilter);
                } else {
                    renderOrders([]); // Show empty state on error/unauthorized
                }
            } catch (error) { console.error(error); }
        }

        function filterOrders(status) {
            currentFilter = status;

            // Update UI buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.innerText.toLowerCase() === status.toLowerCase()) {
                    btn.classList.remove('bg-white', 'text-stone-500', 'hover:bg-stone-100');
                    btn.classList.add('bg-stone-900', 'text-white');
                } else {
                    btn.classList.add('bg-white', 'text-stone-500', 'hover:bg-stone-100');
                    btn.classList.remove('bg-stone-900', 'text-white');
                }
            });

            const filtered = status === 'all'
                ? allOrders
                : allOrders.filter(o => {
                    return window.normalizeStatus(o.status || o.STATUS) === status;
                });

            renderOrders(filtered);
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-list');
            if (orders.length > 0) {
                container.innerHTML = orders.map(order => {
                    const date = new Date(order.order_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                    // Normalize status (check both lower and upper case keys for robustness)
                    const statusKey = window.normalizeStatus(order.status || order.STATUS);

                    // Map statuses to literal labels as requested
                    const statusMap = {
                        'ordered': 'Ordered',
                        'shipped': 'Shipped',
                        'delivered': 'Delivered',
                        'cancelled': 'Cancelled'
                    };
                    const displayStatus = statusMap[statusKey] || statusKey.charAt(0).toUpperCase() + statusKey.slice(1);

                    const statusColors = {
                        'ordered': 'bg-blue-100 text-blue-700',
                        'shipped': 'bg-indigo-100 text-indigo-700',
                        'delivered': 'bg-emerald-100 text-emerald-700',
                        'cancelled': 'bg-rose-100 text-rose-700'
                    };

                    const orderJson = encodeURIComponent(JSON.stringify(order));

                    return `
                        <div class="bg-white border border-stone-200 rounded-[40px] p-8 hover:shadow-xl transition-all duration-300 group">
                            <div class="flex flex-col md:flex-row gap-8 items-center">
                                <!-- Image -->
                                <div class="w-full md:w-28 h-28 rounded-[24px] bg-stone-50 overflow-hidden flex-shrink-0 border border-stone-100 relative group-hover:shadow-lg transition-all">
                                    <div class="absolute inset-0 bg-black/5 group-hover:bg-transparent transition-all z-10"></div>
                                    <img src="${order.image_url ? '../../' + order.image_url : 'https://images.unsplash.com/photo-1596040033229-a9821ebd05ed?auto=format&fit=crop&w=400&q=80'}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-700">
                                </div>
                                
                                <!-- Middle Details -->
                                <div class="flex-1 w-full self-center flex flex-col justify-center">
                                    <!-- Status Indicator (Pill) -->
                                    <div class="mb-3">
                                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest inline-block ${statusColors[statusKey] || 'bg-amber-100 text-amber-700'}">
                                            ${displayStatus || 'Ordered'}
                                        </span>
                                    </div>
                                    
                                    <h3 class="font-bold text-2xl text-stone-900 leading-none mb-2 tracking-tight">${order.product_name}</h3>
                                    <p class="text-[11px] font-bold text-stone-400 uppercase tracking-widest mb-4">Harvest from ${order.farmer_name}</p>
                                    
                                    <p class="text-[10px] font-bold text-stone-300 uppercase tracking-widest flex items-center gap-2">
                                        ORDERED ON <span class="text-stone-400">${date.toUpperCase()}</span>
                                    </p>
                                </div>

                                <!-- Right Side: Price & Actions aligned horizontally -->
                                <div class="flex items-center gap-10 self-center h-full pl-8 border-l border-stone-100/50 md:border-l-0">
                                    <!-- Price Block (Left of Button) -->
                                    <div class="text-right flex flex-col justify-center h-full">
                                        <p class="font-bold text-3xl text-stone-900 leading-none mb-1">${(window.CurrencyManager.formatHistorical ? window.CurrencyManager.formatHistorical(order.total_price, order.exchange_rate, order.currency_code) : (window.CurrencyManager.format(order.total_price)))}</p>
                                        <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest text-right">${order.quantity} ${order.unit || 'kg'}</p>
                                    </div>
                                    
                                    <!-- Track Button (Right Side, Colored) -->
                                    <div class="flex items-center gap-3">
                                        ${order.payment_status === 'pending' ?
                            `<a href="payment.html?order_id=${order.id}" class="px-8 py-3.5 bg-primary text-white font-bold text-[11px] rounded-[24px] hover:bg-primary-hover transition-all uppercase tracking-[0.2em] shadow-lg shadow-orange-100">
                                                PAY NOW
                                            </a>`
                            : `
                                            ${(statusKey === 'delivered') ?
                                `<button onclick="openReviewModal('${order.id}', '${order.product_id}', '${order.product_name}')" class="px-5 py-3 bg-stone-900 text-white font-bold text-[10px] rounded-xl hover:bg-black transition-all uppercase tracking-widest shadow-lg hover:shadow-xl hover:-translate-y-0.5">Rate</button>`
                                : ''}
                                                
                                            ${statusKey === 'cancelled' ? `
                                                <div class="px-10 py-3.5 bg-rose-50 text-rose-600 font-bold text-[11px] rounded-[24px] uppercase tracking-[0.2em] text-center border border-rose-100 cursor-default">
                                                    CANCELLED
                                                </div>
                                            ` : `
                                                <button onclick="openTrackModal('${orderJson}')" class="px-10 py-3.5 bg-white border-2 border-stone-100 text-stone-900 font-bold text-[11px] rounded-[24px] hover:border-stone-900 transition-all uppercase tracking-[0.2em] shadow-sm hover:shadow-md">
                                                    TRACK
                                                </button>
                                            `}

                                            ${(statusKey === 'ordered') ?
                                `<button onclick="cancelOrder('${order.id}', ${order.total_price}, ${order.exchange_rate}, '${order.currency_code}')" class="px-10 py-3.5 bg-white border-2 border-red-100 text-red-500 font-bold text-[11px] rounded-[24px] hover:border-red-500 transition-all uppercase tracking-[0.2em] shadow-sm hover:shadow-md">
                                                CANCEL
                                            </button>`
                                : ''}
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="py-40 text-center">
                        <div class="w-24 h-24 bg-stone-50 rounded-full flex items-center justify-center mx-auto mb-6">
                            <img src="https://api.iconify.design/lucide:shopping-bag.svg?color=%23d6d3d1" class="w-10 h-10 opacity-50">
                        </div>
                        <h3 class="text-xl font-bold text-stone-900 mb-2">No ${currentFilter === 'all' ? 'Past Orders' : currentFilter + ' orders'}</h3>
                        <p class="text-stone-400 font-medium ${currentFilter === 'all' ? 'mb-8' : ''}">Your spice journey hasn't started yet.</p>
                        ${currentFilter === 'all' ? `
                        <a href="catalog.html" class="inline-block bg-primary hover:bg-[#E66D1A] text-white px-8 py-4 rounded-[24px] font-bold text-sm tracking-widest shadow-xl shadow-orange-200 hover:-translate-y-1 transition-all">EXPLORE CATALOG</a>
                        ` : ''}
                    </div>
                `;
            }
        }

        function openTrackModal(orderJson) {
            const order = JSON.parse(decodeURIComponent(orderJson));
            document.getElementById('track-order-id').innerText = `ORD-${order.id.toString().padStart(5, '0')}`;
            document.getElementById('trackModal').classList.remove('hidden');

            const timeline = document.getElementById('track-timeline');
            const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString() : 'Pending';

            // Requested Flow: Order Placed -> Shipped -> Delivered
            // We map internal 'processing' status to 'Order Placed' step
            const steps = [
                { id: 'placed', label: 'Order Placed', date: formatDate(order.order_date), active: true },
                { id: 'shipped', label: 'Shipped', date: formatDate(order.shipped_at), active: ['shipped', 'delivered'].includes(order.status) },
                { id: 'delivered', label: 'Delivered', date: formatDate(order.delivered_at), active: order.status === 'delivered' }
            ];

            timeline.innerHTML = steps.map((step, index) => `
                <div class="relative">
                    <div class="absolute -left-[41px] top-0 w-5 h-5 rounded-full border-2 ${step.active ? 'bg-primary border-primary' : 'bg-white border-stone-200'} flex items-center justify-center z-10">
                        ${step.active ? '<div class="w-1.5 h-1.5 bg-white rounded-full"></div>' : ''}
                    </div>
                    <div>
                        <h4 class="text-sm font-bold ${step.active ? 'text-stone-900' : 'text-stone-400'} uppercase tracking-wider">${step.label}</h4>
                        <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest mt-1">${step.active ? step.date : ''}</p>
                    </div>
                </div>
            `).join('');
        }

        function closeTrackModal() {
            document.getElementById('trackModal').classList.add('hidden');
        }

        function openReviewModal(orderId, productId, name) {
            currentReviewData = { order_id: orderId, product_id: productId };
            document.getElementById('review-product-name').innerText = name;
            document.getElementById('reviewModal').classList.remove('hidden');
            initStars();
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.add('hidden');
        }

        function initStars() {
            const container = document.getElementById('stars-container');
            container.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const btn = document.createElement('button');
                btn.className = 'star-btn transition-all transform hover:scale-110';
                btn.innerHTML = `<img src="https://api.iconify.design/lucide:star.svg?color=${i <= currentRating ? '%23FF7E21' : '%23d6d3d1'}" width="36" class="star-icon">`;
                btn.onclick = () => {
                    currentRating = i;
                    updateStars();
                };
                container.appendChild(btn);
            }
        }

        function updateStars() {
            const stars = document.querySelectorAll('.star-icon');
            stars.forEach((star, i) => {
                star.src = `https://api.iconify.design/lucide:star.svg?color=${i < currentRating ? '%23FF7E21' : '%23d6d3d1'}`;
            });
        }

        async function submitReview() {
            const btn = document.getElementById('submit-review-btn');
            const text = document.getElementById('review-text').value;

            btn.disabled = true;
            btn.innerText = "PUBLISHING...";

            try {
                const response = await fetch('../../backend/api/orders/submit-review.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...currentReviewData,
                        rating: currentRating,
                        review_text: text
                    })
                });
                const result = await response.json();
                if (result.success) {
                    showToast('Thank you! Your feedback helps our farmers maintain the highest quality.', 'success');
                    closeReviewModal();
                    loadOrders();
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) { console.error(error); }
            finally {
                btn.disabled = false;
                btn.innerText = "PUBLISH REVIEW";
            }
        }

        window.onload = async () => {
            await CurrencyManager.init();
            loadOrders();
        };

        async function cancelOrder(orderId, amount, rate, code) {
            const confirmed = await window.showConfirm("Are you sure you want to cancel this order?");
            if (!confirmed) return;

            try {
                const response = await fetch('../../backend/api/orders/cancel-order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });
                const result = await response.json();

                if (result.success) {
                    const formattedAmount = window.CurrencyManager.formatHistorical(amount, rate, code);
                    if (typeof window.showAlert === 'function') {
                        await window.showAlert(`Your refund of ${formattedAmount} will be credited within 7 business days.`, 'Cancellation Successful');
                    } else {
                        showToast(`Order cancelled. Your refund of ${formattedAmount} will be credited within 7 business days.`, 'success');
                    }
                    loadOrders();
                } else {
                    showToast(result.message || 'Failed to cancel order', 'error');
                }
            } catch (error) {
                console.error("Error cancelling order:", error);
                showToast("Connection or processing error. Please refresh and try again.", "error");
            }
        }
    </script>

    <script src="../assets/js/main.js"></script>
</body>

</html>