<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart | Caravan of Flavours</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <script src="../assets/js/custom-ui.js?v=1.4"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF7E21',
                        'primary-hover': '#E66D1A',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-stone-50 text-stone-800 font-['Outfit'] antialiased selection:bg-orange-100 selection:text-orange-600">
    <aside
        style="width: 200px; background: white; border-right: 1px solid #e7e5e4; position: fixed; height: 100vh; padding: 24px; z-index: 50; overflow-y: auto;">
        <div class="logo" style="margin-bottom: 40px; display: flex; align-items: center; gap: 14px;">
            <img src="../assets/images/logo.png" alt="Logo" style="height: 42px; width: auto; object-fit: contain;">
            <div style="display: flex; flex-direction: column;">
                <h3
                    style="font-size: 18px; color: #1c1917; font-weight: 700; line-height: 1.1; letter-spacing: -0.02em;">
                    Caravan</h3>
                <small
                    style="font-size: 10px; color: #a8a29e; letter-spacing: 0.1em; font-weight: 700; text-transform: uppercase;">Of
                    Flavours</small>
            </div>
        </div>

        <nav style="display: flex; flex-direction: column; gap: 4px;">
            <a href="customer-dashboard.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:layout-dashboard.svg?color=%231c1917" width="18" alt="">
                Dashboard
            </a>
            <a href="catalog.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:book-open.svg?color=%231c1917" width="18" alt="">
                Catalog
            </a>
            <a href="orders.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:shopping-bag.svg?color=%231c1917" width="18" alt="">
                Orders
            </a>
            <a href="cart.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: white; background: #FF7E21; font-weight: 700; font-size: 14px; box-shadow: 0 4px 12px rgba(255, 126, 33, 0.25);">
                <img src="https://api.iconify.design/lucide:shopping-cart.svg?color=white" width="18" alt="">
                Cart
            </a>
            <a href="bulk-orders.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:boxes.svg?color=%231c1917" width="18" alt="">
                Bulk Order
            </a>
            <a href="auctions.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:gavel.svg?color=%231c1917" width="18" alt="">
                Auctions
            </a>
            <a href="market-analytics.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:trending-up.svg?color=%231c1917" width="18" alt="">
                Analytics
            </a>

            <a href="profile.html"
                style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; text-decoration: none; color: #1c1917; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                onmouseover="this.style.background='#fafaf9'" onmouseout="this.style.background='transparent'">
                <img src="https://api.iconify.design/lucide:user.svg?color=%231c1917" width="18" alt="">
                Profile
            </a>
        </nav>

        <div style="position: absolute; bottom: 24px; left: 24px; right: 24px;">
            <button onclick="logout()"
                style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #ff0000; background: transparent; border: 2px solid #ff0000; width: 100%; cursor: pointer; font-weight: 700; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:log-out.svg?color=%23ff0000" width="18"
                    style="transform: rotate(180deg);" alt="">
                Sign Out
            </button>
        </div>
        <script>
            async function logout() {
                try {
                    await fetch('../../backend/api/auth/logout.php');
                    window.location.href = '../auth/login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
        </script>
    </aside>

    <main class="ml-[200px] p-10 max-w-7xl mx-auto min-h-screen">
        <header class="flex justify-between items-end mb-8 animate-fade-in">
            <div>
                <h1 class="text-4xl font-bold tracking-tight text-stone-900">Your Cart</h1>
                <p class="text-stone-500 mt-2 font-medium text-base">You're just a few steps away from your order.</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- Left: Cart Items List -->
            <div class="lg:col-span-8 space-y-6" id="cart-items-container">
                <!-- Loading State -->
                <div class="py-24 text-center bg-white rounded-2xl shadow-sm border border-stone-100">
                    <img src="https://api.iconify.design/line-md:loading-loop.svg?color=%23FF7E21"
                        class="w-12 h-12 mx-auto mb-4">
                    <p class="text-stone-400 font-bold uppercase tracking-widest text-xs">Loading your picks...</p>
                </div>
            </div>

            <!-- Right: Sticky Price Details -->
            <div class="lg:col-span-4 sticky top-8 space-y-4">
                <div
                    class="bg-white rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-stone-100 overflow-hidden">
                    <div class="p-6 pb-4 border-b border-stone-100 bg-stone-50/50">
                        <h2 class="text-stone-800 font-bold text-lg">Order Summary</h2>
                    </div>

                    <div class="p-6 space-y-4">
                        <div class="flex justify-between text-stone-600">
                            <span id="price-count-label">Price (0 items)</span>
                            <span id="price-subtotal" class="font-medium text-stone-900">$0.00</span>
                        </div>

                        <!-- List of selected items (Dynamically filled) -->
                        <div id="summary-items-list"
                            class="hidden text-xs text-stone-500 space-y-1 max-h-40 overflow-y-auto border-t border-dashed border-stone-100 pt-2">
                        </div>

                        <div class="border-t border-dashed border-stone-200 my-2 pt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-xl text-stone-900">Total</span>
                                <span id="price-total" class="font-bold text-2xl text-primary">$0.00</span>
                            </div>
                            <p class="text-right text-xs text-stone-400 mt-1">Including all taxes</p>
                        </div>
                    </div>
                </div>

                <div class="bg-green-50/50 border border-green-100 p-4 rounded-xl flex items-center gap-3">
                    <div class="bg-green-100 p-2 rounded-full text-green-600">
                        <img src="https://api.iconify.design/lucide:shield-check.svg" class="w-5 h-5">
                    </div>
                    <p class="text-xs text-green-800 font-medium leading-relaxed">
                        Safe and Secure Payments.<br>100% Authentic Products.
                    </p>
                </div>

                <button onclick="checkout()" id="checkout-btn" disabled
                    class="group w-full bg-gradient-to-r from-[#FF7E21] to-[#ff9f57] hover:from-[#e66d1a] hover:to-[#ff8d3b] text-white py-4 rounded-xl font-bold text-base shadow-[0_4px_14px_rgba(255,126,33,0.4)] transition-all transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:active:scale-100 flex justify-center items-center gap-2">
                    <span>PROCEED TO CHECKOUT</span>
                    <img src="https://api.iconify.design/lucide:arrow-right.svg?color=white"
                        class="w-5 h-5 group-hover:translate-x-1 transition-transform">
                </button>
            </div>
        </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity"></div>

        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <!-- Modal Panel -->
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4 text-center">
                        <div
                            class="mx-auto flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-full bg-orange-50 mb-4">
                            <img src="https://api.iconify.design/lucide:alert-circle.svg?color=%23FF7E21"
                                class="w-8 h-8">
                        </div>
                        <h3 class="text-xl font-bold leading-6 text-stone-900 mb-2" id="modal-title">Confirm Action</h3>
                        <div class="mt-2">
                            <p class="text-sm text-stone-500 leading-relaxed" id="modal-desc">
                                Are you sure you want to proceed?
                            </p>
                        </div>
                    </div>
                    <div class="bg-stone-50 px-4 py-3 sm:flex sm:justify-center sm:px-6 gap-3">
                        <button type="button" onclick="hideModal()"
                            class="mt-3 inline-flex w-full justify-center rounded-xl bg-white px-5 py-3 text-sm font-bold text-stone-900 shadow-sm ring-1 ring-inset ring-stone-300 hover:bg-stone-50 sm:mt-0 sm:w-auto transition-colors">
                            CANCEL
                        </button>
                        <button type="button" onclick="confirmCheckout()"
                            class="inline-flex w-full justify-center rounded-xl bg-[#FF7E21] px-5 py-3 text-sm font-bold text-white shadow-sm hover:bg-[#e66d1a] sm:w-auto transition-colors">
                            CONFIRM
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cartItems = [];
        let selectedItems = new Set(); // Stores IDs of selected items

        async function loadCart() {
            try {
                const response = await fetch('../../backend/api/cart/get-cart.php');
                const result = await response.json();
                const container = document.getElementById('cart-items-container');

                if (result.success && result.items.length > 0) {
                    cartItems = result.items.reverse(); // Newest first
                    container.innerHTML = '';

                    cartItems.forEach(item => {
                        const lineTotal = item.price * item.quantity;
                        const imgSrc = item.image_url ? '../../' + item.image_url : 'https://images.unsplash.com/photo-1596040033229-a9821ebd05ed?auto=format&fit=crop&w=400&q=80';
                        const isChecked = selectedItems.has(item.id) ? 'checked' : '';

                        container.innerHTML += `
                            <div class="group bg-white rounded-2xl p-5 flex gap-6 shadow-sm border border-stone-100 hover:shadow-md transition-all duration-300 relative overflow-hidden">
                                
                                <!-- Checkbox -->
                                <div class="pt-2">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" class="cart-checkbox peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-stone-300 checked:border-primary checked:bg-primary transition-all" 
                                            value="${item.id}" onchange="toggleSelection('${item.id}', this.checked)" ${isChecked}>
                                        <svg class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100 w-3.5 h-3.5" viewBox="0 0 14 14" fill="none">
                                            <path d="M3 8L6 11L11 3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                    </div>
                                </div>

                                <!-- Image -->
                                <div class="w-32 h-32 flex-shrink-0 bg-stone-50 rounded-xl p-2 border border-stone-100">
                                    <img src="${imgSrc}" class="w-full h-full object-contain mx-auto mix-blend-multiply group-hover:scale-105 transition-transform duration-500">
                                </div>
                                
                                <!-- Details -->
                                <div class="flex-1 flex flex-col justify-between">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="text-lg font-bold text-stone-900 mb-1 leading-snug hover:text-primary cursor-pointer transition-colors max-w-sm line-clamp-2">${item.product_name}</h3>
                                            <p class="text-sm text-stone-500 font-medium mb-1">Sold by ${item.shop_name || item.farmer_name}</p>
                                        </div>
                                        <div class="text-right">
                                            <!-- CLEAN PRICE DISPLAY: NO FAKE OFFERS -->
<<<<<<< HEAD
                                            <p class="text-xl font-bold text-stone-900">${formatCurrency(item.price)}</p>
=======
                                            <p class="text-xl font-bold text-stone-900">$${parseFloat(item.price).toFixed(2)}</p>
>>>>>>> 7a93d84e57fb4b8a4284292b9e5f4cf08fc28c30
                                        </div>
                                    </div>

                                    <div class="flex items-end justify-between mt-4">
                                        <!-- Actions -->
                                        <div class="flex items-center gap-6">
                                            <!-- Quantity -->
                                            <!-- Quantity -->
                                            <div class="flex items-center gap-1 bg-stone-100 rounded-lg p-1">
                                                <button onclick="updateQuantity('${item.id}', -1)" 
                                                    class="w-8 h-8 rounded-md flex items-center justify-center bg-white text-stone-600 shadow-sm hover:text-primary hover:shadow transition-all disabled:opacity-40 disabled:hover:text-stone-600" ${item.quantity <= 0.1 ? 'disabled' : ''}>
                                                    <span class="font-bold text-lg leading-none mb-0.5">-</span>
                                                </button>
                                                <input id="qty-${item.id}" type="number" step="0.1" min="0.1" value="${item.quantity}" 
                                                    oninput="updateQuantity('${item.id}', 0)"
                                                    class="w-16 text-center font-bold text-stone-900 text-sm bg-transparent border-none outline-none focus:ring-0 appearance-none p-0">
                                                <button onclick="updateQuantity('${item.id}', 1)" 
                                                    class="w-8 h-8 rounded-md flex items-center justify-center bg-white text-stone-600 shadow-sm hover:text-primary hover:shadow transition-all">
                                                    <span class="font-bold text-lg leading-none mb-0.5">+</span>
                                                </button>
                                            </div>
                                            
                                            <!-- Remove -->
                                            <button onclick="removeItem('${item.id}')" 
                                                class="flex items-center gap-1.5 text-stone-400 hover:text-red-500 transition-colors text-sm font-semibold group/remove px-2 py-1.5 rounded-md hover:bg-red-50">
                                                <img src="https://api.iconify.design/lucide:trash-2.svg" class="w-4 h-4 opacity-70 group-hover/remove:text-red-500 group-hover/remove:opacity-100 transition-opacity">
                                                <span>Remove</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    updateSummary();
                } else {
                    container.innerHTML = `
                        <div class="py-24 text-center bg-white rounded-2xl shadow-sm border border-dashed border-stone-200">
                            <div class="bg-orange-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                                <img src="https://api.iconify.design/lucide:shopping-cart.svg?color=%23FF7E21" class="w-10 h-10 opacity-80">
                            </div>
                            <h3 class="text-xl font-bold text-stone-900 mb-2">Your cart is currently empty</h3>
                            <p class="text-stone-500 mb-8 max-w-xs mx-auto">Looks like you haven't added anything to your cart yet.</p>
                            <button onclick="window.location.href='catalog.html'" 
                                class="bg-primary hover:bg-[#e66d1a] text-white px-8 py-3.5 rounded-xl font-bold shadow-lg shadow-orange-200 transition-all hover:-translate-y-1">
                                Start Shopping
                            </button>
                        </div>
                    `;
                    document.getElementById('checkout-btn').disabled = true;
<<<<<<< HEAD
                    document.getElementById('price-subtotal').innerText = formatCurrency(0);
                    document.getElementById('price-total').innerText = formatCurrency(0);
=======
                    document.getElementById('price-subtotal').innerText = "$0.00";
                    document.getElementById('price-total').innerText = "$0.00";
>>>>>>> 7a93d84e57fb4b8a4284292b9e5f4cf08fc28c30
                }
            } catch (error) { console.error(error); }
        }

        function toggleSelection(id, isChecked) {
            if (isChecked) selectedItems.add(id);
            else selectedItems.delete(id);
            updateSummary();
        }

        function updateSummary() {
            let subtotal = 0;
            let unitTotal = 0;
            let count = 0;
            let nameListHTML = '';

            selectedItems.forEach(id => {
                const item = cartItems.find(i => i.id == id);
                if (item) {
                    subtotal += item.price * item.quantity;
                    unitTotal += parseFloat(item.price);
                    count++;
<<<<<<< HEAD
                    nameListHTML += `<div class="truncate flex justify-between"><span>${item.quantity}kg x ${item.product_name}</span> <span class="font-medium">${formatCurrency(item.price * item.quantity)}</span></div>`;
=======
                    nameListHTML += `<div class="truncate flex justify-between"><span>${item.quantity}kg x ${item.product_name}</span> <span class="font-medium">$${(item.price * item.quantity).toFixed(2)}</span></div>`;
>>>>>>> 7a93d84e57fb4b8a4284292b9e5f4cf08fc28c30
                }
            });

            document.getElementById('price-count-label').innerText = `Price (${count} items)`;
<<<<<<< HEAD
            document.getElementById('price-subtotal').innerText = formatCurrency(unitTotal);
            document.getElementById('price-total').innerText = formatCurrency(subtotal);
=======
            document.getElementById('price-subtotal').innerText = `$${unitTotal.toFixed(2)}`;
            document.getElementById('price-total').innerText = `$${subtotal.toFixed(2)}`;
>>>>>>> 7a93d84e57fb4b8a4284292b9e5f4cf08fc28c30

            const summaryListEl = document.getElementById('summary-items-list');
            if (summaryListEl) {
                if (count > 0) {
                    summaryListEl.innerHTML = nameListHTML;
                    summaryListEl.classList.remove('hidden');
                } else {
                    summaryListEl.classList.add('hidden');
                }
            }

            const checkoutBtn = document.getElementById('checkout-btn');
            checkoutBtn.disabled = count === 0;

            if (count > 0) {
                checkoutBtn.innerHTML = `
                    <span>PROCEED TO CHECKOUT</span>
                    <img src="https://api.iconify.design/lucide:arrow-right.svg?color=white" class="w-5 h-5 group-hover:translate-x-1 transition-transform">
                `;
            } else {
                checkoutBtn.innerText = "PROCEED TO CHECKOUT";
            }
        }

        async function updateQuantity(cartId, change) {
            const item = cartItems.find(i => i.id == cartId);
            if (!item) return;

            const input = document.getElementById(`qty-${cartId}`);
            let currentVal = parseFloat(input ? input.value : item.quantity);
            if (isNaN(currentVal)) currentVal = parseFloat(item.quantity);

            let newQty = currentVal + change;

            // Round to 2 decimals
            newQty = Math.round(newQty * 100) / 100;

            if (newQty < 0.1) newQty = 0.1;

            item.quantity = newQty;

            // Only update input value if it was a button click (change != 0)
            // If manual input (change == 0), let user type freely
            if (input && change !== 0) input.value = newQty;

            // Update button state
            const minusBtn = input ? input.previousElementSibling : null;
            if (minusBtn) minusBtn.disabled = newQty <= 0.1;

            updateSummary();

            try {
                const response = await fetch('../../backend/api/cart/update-cart.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cart_id: cartId, quantity: newQty })
                });

                const text = await response.text();
                let res;
                try {
                    res = JSON.parse(text);
                } catch (err) {
                    console.error('SERVER ERROR:', text);
                    throw new Error('Server returned invalid JSON. See console.');
                }

                if (!res.success) {
                    throw new Error(res.message);
                }
            } catch (e) {
                console.error(e);
                item.quantity = currentVal;
                if (input) input.value = currentVal;
                updateSummary();
                // Debounce toast or only show on significant error to avoid spamming while typing
                if (change !== 0) showToast(e.message || "Failed to update quantity", 'error');
            }
        }

        async function removeItem(id) {
            try {
                const response = await fetch('../../backend/api/cart/remove-from-cart.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cart_id: id })
                });
                const text = await response.text();
                let result;
                try { result = JSON.parse(text); } catch (e) { console.error('Delete error parsing:', text); return; }

                if (result.success) {
                    selectedItems.delete(id);
                    loadCart();
                }
            } catch (error) { console.error(error); }
        }

        // --- Confirmation Modal Logic ---

        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = message;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }

        function checkout() {
            let subtotal = 0;
            let itemDetails = [];

            selectedItems.forEach(id => {
                const item = cartItems.find(i => i.id == id);
                if (item) {
                    subtotal += item.price * item.quantity;
                    // Attempt to use unit 'kg' if we knew it, but here we just list names
                    itemDetails.push(`${item.quantity}kg ${item.product_name}`);
                }
            });

            const itemsStr = itemDetails.join(', ');
            const totalStr = subtotal.toFixed(2);

            // Truncate if too long
            const displayItems = itemsStr.length > 60 ? itemsStr.substring(0, 60) + '...' : itemsStr;

<<<<<<< HEAD
            const msg = `Confirm purchase of ${displayItems} for ${formatCurrency(subtotal)}? The farmer will be instantly notified to accept your order. You can proceed with secure payment once they approve.`;
=======
            const msg = `Confirm purchase of ${displayItems} for $${totalStr}? The farmer will be instantly notified to accept your order. You can proceed with secure payment once they approve.`;
>>>>>>> 7a93d84e57fb4b8a4284292b9e5f4cf08fc28c30

            showModal('Confirm Action', msg);
        }

        async function confirmCheckout() {
            hideModal();
            const address = "Default Address";
            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.innerHTML = `<img src="https://api.iconify.design/line-md:loading-loop.svg?color=white" class="w-5 h-5 animate-spin"> Processing...`;

            const selectedIds = Array.from(selectedItems);

            try {
                const response = await fetch('../../backend/api/cart/checkout.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        delivery_address: address,
                        selected_cart_ids: selectedIds
                    })
                });
                const text = await response.text();
                let result;
                try { result = JSON.parse(text); } catch (e) { throw new Error("Invalid server response at checkout"); }

                if (result.success) {
                    showModal('Order Placed Successfully!', 'SUCCESS! Your order has been placed directly with the farmer. They will review it shortly. You can track its status in the "Orders" page.');

                    // Hide the Confirm/Cancel buttons in the success modal case, or change them to just "OK"
                    // Simpler approach: Just change the confirmCheckout button to "Done" and reload on click, or redirect to Orders
                    const modalBtns = document.querySelector('#confirmation-modal .bg-stone-50');
                    if (modalBtns) {
                        modalBtns.innerHTML = `
                            <button onclick="window.location.href='orders.html'" 
                                class="inline-flex w-full justify-center rounded-xl bg-[#FF7E21] px-5 py-3 text-sm font-bold text-white shadow-sm hover:bg-[#e66d1a] sm:w-auto transition-colors">
                                GO TO ORDERS
                            </button>
                         `;
                        // Center the new button
                        modalBtns.classList.add('justify-center');
                    }

                    // Clear cart UI behind modal
                    document.getElementById('cart-items-container').innerHTML = '';
                    updateSummary();
                } else {
                    showToast(result.message, 'error');
                    btn.disabled = false;
                    updateSummary();
                }
            } catch (error) {
                console.error(error);
                showToast(error.message, 'error');
                btn.disabled = false;
                updateSummary();
            }
        }

        window.onload = loadCart;
    </script>
</body>

</html>