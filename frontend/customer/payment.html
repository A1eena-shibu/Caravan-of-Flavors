<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Caravan of Flavours</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script> <!-- Sandbox ID -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF7E21',
                        'primary-hover': '#E66D1A'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-[#fafaf9] text-stone-900 font-['Outfit'] min-h-screen p-6 flex items-center justify-center">

    <div class="max-w-2xl w-full bg-white rounded-[40px] shadow-2xl overflow-hidden border border-stone-100">
        <!-- Header -->
        <div class="bg-stone-900 p-8 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">Secure Checkout</h1>
                <p class="text-stone-400 text-sm mt-1">Complete your purchase securely</p>
            </div>
            <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center">
                <img src="https://api.iconify.design/lucide:lock.svg?color=white" width="24">
            </div>
        </div>

        <div class="p-8 space-y-8">
            <!-- Order Summary -->
            <div class="bg-stone-50 rounded-2xl p-6 border border-stone-100 flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest mb-1">Order Reference</p>
                    <p id="order-id-display" class="font-mono font-bold text-xl text-stone-900">ORD-...</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest mb-1">Amount to Pay</p>
                    <p id="amount-display" class="font-bold text-xl text-primary">$0.00</p>
                </div>
            </div>

            <!-- Contact & Delivery -->
            <div class="space-y-4">
                <div>
                    <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-widest mb-3">Contact
                        Number</label>
                    <div class="relative">
                        <input type="tel" id="contact-phone" placeholder="e.g. +919876543210" maxlength="16"
                            oninput="validatePhoneInput(this)"
                            class="w-full bg-stone-50 border border-stone-200 rounded-2xl p-4 text-sm font-semibold outline-none focus:border-primary transition-all">
                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-stone-400">
                            <img src="https://api.iconify.design/lucide:phone.svg?color=%23a8a29e" width="18">
                        </div>
                    </div>
                    <p class="text-[10px] text-stone-400 mt-2 ml-1">Format: <strong>+</strong> followed by <strong>10-15
                            digits</strong> (e.g. +919876543210)</p>
                </div>

                <div>
                    <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-widest mb-3">Delivery
                        Address</label>
                    <div class="relative">
                        <textarea id="delivery-address" rows="3"
                            placeholder="e.g. Country, State, District, City, Street Name, House Name/House No..."
                            class="w-full bg-stone-50 border border-stone-200 rounded-2xl p-4 text-sm font-semibold outline-none focus:border-primary transition-all resize-none"></textarea>

                        <button onclick="fetchLocation()"
                            class="absolute bottom-3 right-3 flex items-center gap-2 bg-white border border-stone-200 px-3 py-1.5 rounded-lg text-xs font-bold text-stone-600 hover:bg-stone-50 transition-colors shadow-sm">
                            <img src="https://api.iconify.design/lucide:map-pin.svg?color=%23FF7E21" width="14">
                            Auto-Detect Location
                        </button>
                    </div>
                </div>

                <!-- Payment Method -->
                <div>
                    <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-widest mb-3">Select
                        Payment
                        Method</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Razorpay -->
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="razorpay" class="peer hidden" checked
                                onchange="togglePaymentUI()">
                            <div
                                class="bg-white border-2 border-stone-100 rounded-2xl p-4 flex items-center gap-4 peer-checked:border-[#3399cc] peer-checked:bg-[#f0f8ff] transition-all hover:bg-stone-50 h-full">
                                <div
                                    class="w-10 h-10 bg-white rounded-full flex items-center justify-center border border-stone-100 p-1">
                                    <img src="https://avatars.githubusercontent.com/u/7713209?s=200&v=4"
                                        class="object-contain">
                                </div>
                                <div>
                                    <p class="font-bold text-sm text-stone-900">Razorpay</p>
                                    <p class="text-xs text-stone-400 font-medium">Cards, UPI, Netbanking</p>
                                </div>
                            </div>
                        </label>

                        <!-- PayPal -->
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="paypal" class="peer hidden"
                                onchange="togglePaymentUI()">
                            <div
                                class="bg-white border-2 border-stone-100 rounded-2xl p-4 flex items-center gap-4 peer-checked:border-[#003087] peer-checked:bg-[#e6f2ff] transition-all hover:bg-stone-50 h-full">
                                <div
                                    class="w-10 h-10 bg-white rounded-full flex items-center justify-center border border-stone-100 p-2">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg"
                                        class="object-contain">
                                </div>
                                <div>
                                    <p class="font-bold text-sm text-stone-900">PayPal</p>
                                    <p class="text-xs text-stone-400 font-medium">International Payments</p>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Action Area -->
                <div id="payment-actions" class="mt-8">
                    <!-- Dynamic buttons will appear here -->
                    <button id="razorpay-btn" onclick="startRazorpayPayment()"
                        class="w-full py-4 bg-[#3399cc] text-white font-bold rounded-2xl hover:bg-[#2b82ad] transition-all shadow-xl text-sm tracking-widest uppercase flex items-center justify-center gap-2">
                        Pay with Razorpay
                    </button>

                    <div id="paypal-button-container" class="hidden"></div>
                </div>

                <button onclick="confirmCancel()"
                    class="w-full text-center text-xs font-bold text-stone-400 uppercase tracking-widest hover:text-red-500 hover:bg-red-50 py-3 rounded-xl transition-all mt-4">
                    Cancel Transaction
                </button>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2">
        </div>

        <script>
            const urlParams = new URLSearchParams(window.location.search);
            const orderIds = urlParams.get('order_ids');
            const legacyOrderId = urlParams.get('order_id');
            const auctionId = urlParams.get('auction_id');
            const finalOrderIds = orderIds || legacyOrderId;

            const isAuction = !!auctionId;

            let amount = 0;
            let sourceCurrency = 'USD'; // Default for orders
            let customerName = "Valued Customer";
            let customerEmail = "customer@example.com";

            if (!finalOrderIds && !auctionId) {
                showToast("Invalid Order/Auction ID(s)", "error");
                setTimeout(() => window.location.href = isAuction ? 'auctions.html' : 'orders.html', 2000);
            }

            const displayId = isAuction ? `AUC-${auctionId.toString().padStart(5, '0')}` :
                (orderIds ? `Check Summary (${orderIds.split(',').length} Items)` : `ORD-${(legacyOrderId || '000').toString().padStart(5, '0')}`);

            if (isAuction) {
                document.querySelector('p[class*="text-stone-400 uppercase"]').innerText = 'Auction Reference';
            }
            document.getElementById('order-id-display').innerText = displayId;

            async function fetchOrderDetails() {
                try {
                    let response;
                    if (isAuction) {
                        response = await fetch(`../../backend/api/auctions/get-auction-payment-details.php?auction_id=${auctionId}`);
                    } else {
                        const param = orderIds ? `order_ids=${orderIds}` : `order_id=${legacyOrderId}`;
                        response = await fetch(`../../backend/api/orders/get-order-details.php?${param}`);
                    }
                    const result = await response.json();

                    if (result.success && result.order) {
                        amount = parseFloat(result.order.total_price);
                        if (result.order.customer_name) customerName = result.order.customer_name;
                        if (result.order.customer_email) customerEmail = result.order.customer_email;
                        window.orderDetails = result.order;
                        sourceCurrency = result.order.currency_code || 'USD';

                        renderAmountDisplay();

                        if (result.order.payment_status === 'paid') {
                            showToast("This order is already paid.", "success");
                            setTimeout(() => window.location.href = 'orders.html', 2000);
                        }
                    } else {
                        showToast("Failed to load order details", "error");
                    }
                } catch (error) {
                    console.error("Error fetching order:", error);
                    showToast("Connection error while loading order", "error");
                }
            }

            async function fetchUserProfile() {
                try {
                    const response = await fetch('../../backend/api/auth/get-profile.php');
                    const result = await response.json();
                    if (result.success && result.data) {
                        const user = result.data;
                        const phoneInput = document.getElementById('contact-phone');
                        const addressInput = document.getElementById('delivery-address');

                        // Only pre-fill if empty (priority to user input or order details if any)
                        if (!phoneInput.value && user.phone) phoneInput.value = user.phone;
                        if (!addressInput.value && user.address) {
                            addressInput.value = user.address;
                        }
                    }
                } catch (error) {
                    console.error("Error fetching profile:", error);
                }
            }

            // Load both in parallel
            window.onload = async () => {
                await CurrencyManager.init();
                fetchOrderDetails().then(() => fetchUserProfile());
            };

            function showToast(message, type = 'error') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');

                // Icon based on type
                const icon = type === 'error' ? 'alert-circle' : 'check-circle';
                const colorClass = type === 'error' ? 'bg-red-50 text-red-600 border-red-200' : 'bg-green-50 text-green-600 border-green-200';
                const iconColor = type === 'error' ? '%23dc2626' : '%2316a34a';

                toast.className = `flex items-center gap-3 px-6 py-4 rounded-xl border shadow-xl transform transition-all duration-300 translate-y-[-20px] opacity-0 ${colorClass} min-w-[300px]`;
                toast.innerHTML = `
                <img src="https://api.iconify.design/lucide:${icon}.svg?color=${iconColor}" width="20">
                <span class="font-bold text-sm tracking-wide">${message}</span>
            `;

                container.appendChild(toast);

                // Animate in
                requestAnimationFrame(() => {
                    toast.classList.remove('translate-y-[-20px]', 'opacity-0');
                });

                // Remove after 3s
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-[-20px]');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            function togglePaymentUI() {
                const method = document.querySelector('input[name="payment_method"]:checked').value;
                const rzpBtn = document.getElementById('razorpay-btn');
                const ppContainer = document.getElementById('paypal-button-container');

                if (method === 'razorpay') {
                    rzpBtn.classList.remove('hidden');
                    ppContainer.classList.add('hidden');
                } else {
                    rzpBtn.classList.add('hidden');
                    ppContainer.classList.remove('hidden');
                    renderPayPalButtons();
                }
            }

            // --- Geolocation with Reverse Geocoding ---
            function fetchLocation() {
                const btn = document.querySelector('button[onclick="fetchLocation()"]');
                const originalText = btn.innerHTML;

                if (!navigator.geolocation) {
                    showToast("Geolocation is not supported by your browser", "error");
                    return;
                }

                btn.innerHTML = `<img src="https://api.iconify.design/lucide:loader-2.svg" class="w-3.5 h-3.5 animate-spin"> Detecting...`;

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        try {
                            // Primary API: Nominatim
                            let addressFound = false;
                            try {
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`, {
                                    headers: { 'Accept-Language': 'en' }
                                });
                                const data = await response.json();

                                if (data && (data.address || data.display_name)) {
                                    if (data.address) {
                                        const addr = data.address;
                                        // User logic: Country, State, District, City
                                        // We will force this order strictly
                                        const countyOrDistrict = addr.district || addr.state_district || addr.region || addr.county;
                                        const cityOrTown = addr.city || addr.town || addr.municipality || addr.village || addr.hamlet || addr.suburb || addr.locality || addr.city_district;

                                        const parts = [
                                            addr.country,
                                            addr.state,
                                            countyOrDistrict,
                                            cityOrTown
                                        ];
                                        // Remove duplicates/undefined and join
                                        let uniqueParts = [...new Set(parts.filter(p => p))];
                                        const formatted = uniqueParts.join(', ');

                                        document.getElementById('delivery-address').value = formatted;

                                    } else {
                                        document.getElementById('delivery-address').value = data.display_name;
                                    }
                                    addressFound = true;
                                }
                            } catch (nomError) {
                                console.warn("Nominatim failed, trying backup...", nomError);
                            }

                            // Backup API: BigDataCloud (if Nominatim failed)
                            if (!addressFound) {
                                const backupRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                                const backupData = await backupRes.json();

                                if (backupData) {
                                    const parts = [
                                        backupData.countryName,
                                        backupData.principalSubdivision, // State
                                        backupData.locality || backupData.city, // City/District mix
                                        // Attempt to find district if possible, but BigDataCloud is limited
                                    ];
                                    let uniqueParts = [...new Set(parts.filter(p => p))];
                                    document.getElementById('delivery-address').value = uniqueParts.join(', ') || `Lat: ${lat}, Lng: ${lng}`;

                                } else {
                                    throw new Error("Backup API failed");
                                }
                            }

                        } catch (e) {
                            console.error("All geocoding failed", e);
                            document.getElementById('delivery-address').value = `Lat: ${lat}, Lng: ${lng} (Location detected, but address lookup failed)`;
                            showToast("Address lookup failed. Please type manually.", "error");
                        } finally {
                            btn.innerHTML = originalText;
                        }
                    },
                    (error) => {
                        console.error(error);
                        showToast("Unable to retrieve location. Please check permissions.", "error");
                        btn.innerHTML = originalText;
                    }
                );
            }





            function validatePhoneNumber(phone) {
                const regex = /^\+?[0-9]{10,15}$/;
                return regex.test(phone.trim());
            }

            // --- Database Update Function ---
            async function completeOrder(paymentMethod, details) {
                const address = document.getElementById('delivery-address').value;
                const phone = document.getElementById('contact-phone').value;

                if (!phone.trim()) { showToast("Please enter a contact number!", "error"); return false; }
                if (!validatePhoneNumber(phone)) {
                    showToast("Invalid Phone: Must have 10-15 digits (optional + at start)!", "error");
                    return false;
                }
                if (!address.trim()) { showToast("Please provide a delivery address!", "error"); return false; }

                // Show processing overlay
                const btn = document.getElementById('razorpay-btn');
                const originalText = btn.innerText;
                btn.innerText = "VERIFYING PAYMENT...";
                btn.disabled = true;

                try {
                    const endpoint = isAuction ? '../../backend/api/auctions/pay-auction.php' : '../../backend/api/orders/process-payment.php';
                    const payload = isAuction ? {
                        auction_id: auctionId,
                        address: address,
                        phone: phone,
                        payment_method: paymentMethod,
                        transaction_details: details
                    } : {
                        order_ids: finalOrderIds,
                        address: address,
                        phone: phone,
                        payment_method: paymentMethod,
                        transaction_details: details
                    };

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.success) {
                        btn.innerText = "PAYMENT SUCCESSFUL!";
                        btn.classList.remove('bg-[#3399cc]', 'hover:bg-[#2b82ad]');
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');

                        // Show success toast/modal
                        // Show success toast/modal (Centered on Screen)
                        const overlay = document.createElement('div');
                        overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-6 animate-fade-in';
                        overlay.innerHTML = `
                            <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl transform scale-100 transition-all border border-stone-200">
                                <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <img src="https://api.iconify.design/lucide:check.svg?color=%2316a34a" width="40">
                                </div>
                                <h3 class="text-2xl font-bold text-stone-900 mb-2">Payment Successful!</h3>
                                <p class="text-stone-500 text-sm mb-6">Your transaction has been verified. Redirecting you to ${isAuction ? 'auctions' : 'orders'}...</p>
                                <div class="w-full bg-stone-100 rounded-full h-1.5 overflow-hidden">
                                    <div class="bg-green-500 h-full w-full animate-[loading_2s_ease-in-out]"></div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(overlay);

                        // Clear old button
                        document.getElementById('payment-actions').innerHTML = '';

                        setTimeout(() => {
                            window.location.href = isAuction ? 'auctions.html' : 'orders.html';
                        }, 2000);
                        return true;
                    } else {
                        showToast('Server Error: ' + result.message);
                        btn.innerText = originalText;
                        btn.disabled = false;
                        return false;
                    }
                } catch (e) {
                    console.error(e);
                    showToast("Connection failed", "error");
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return false;
                }
            }

            // --- Razorpay Integration ---
            function startRazorpayPayment() {
                const address = document.getElementById('delivery-address').value;
                const phone = document.getElementById('contact-phone').value;

                if (!phone.trim()) { showToast("Please enter a contact number!", "error"); return; }
                if (!validatePhoneNumber(phone)) {
                    showToast("Invalid Phone: Must start with + and have 8-15 digits.", "error");
                    return;
                }
                if (!address.trim()) { showToast("Please enter delivery address first.", "error"); return; }

                // Calculate correct amount for Razorpay
                const currencyCode = CurrencyManager.settings ? CurrencyManager.settings.code : 'USD';
                let finalAmountValue = 0;

                if (window.orderDetails && window.orderDetails.currency_code === currencyCode && window.orderDetails.exchange_rate) {
                    // Use locked rate for exact match if currency matches
                    const lockedRate = parseFloat(window.orderDetails.exchange_rate);
                    finalAmountValue = CurrencyManager.snap(amount * lockedRate);
                } else {
                    // Standard conversion using CurrencyManager
                    finalAmountValue = CurrencyManager.convert(amount, sourceCurrency, currencyCode);
                    // convert() might already call snap, but let's be safe
                    finalAmountValue = CurrencyManager.snap(finalAmountValue);
                }

                const finalAmount = finalAmountValue.toFixed(2);

                const logoUrl = encodeURI(window.location.origin + window.getProjectRoot() + "/frontend/assets/images/logo.png");
                console.log("Razorpay Logo URL:", logoUrl);

                var options = {
                    "key": "rzp_test_1DP5mmOlF5G5ag", // Generic Test Key
                    "amount": Math.round(finalAmount * 100), // Amount in paise/cents (integer)
                    "currency": currencyCode,
                    "name": "Caravan of Flavours",
                    "description": orderIds ? "Payment for Multiple Orders" : "Payment for Order #" + legacyOrderId,
                    "image": encodeURI(window.location.origin + window.getProjectRoot() + "/frontend/assets/images/logo.png"),
                    "handler": function (response) {
                        // Payment successful
                        completeOrder('Razorpay', {
                            payment_id: response.razorpay_payment_id,
                            amount_paid: finalAmount,
                            currency: currencyCode
                        });
                    },
                    "prefill": {
                        "name": customerName,
                        "email": customerEmail, // Ensure this variable is available globally or fetched
                        "contact": phone.replace(/\s+/g, '')
                    },
                    "theme": {
                        "color": "#FF7E21"
                    }
                };
                var rzp1 = new Razorpay(options);
                rzp1.open();
                rzp1.on('payment.failed', function (response) {
                    showToast("Payment Failed: " + response.error.description, "error");
                });
            }

            // --- PayPal Integration ---
            let paypalRendered = false;
            function renderPayPalButtons() {
                if (paypalRendered) return;

                paypal.Buttons({
                    style: { layout: 'vertical', color: 'blue', shape: 'rect', label: 'paypal' },
                    createOrder: function (data, actions) {
                        const address = document.getElementById('delivery-address').value;
                        const phone = document.getElementById('contact-phone').value;

                        if (!phone.trim()) { showToast("Please enter a contact number!", "error"); return; }
                        if (!validatePhoneNumber(phone)) {
                            showToast("Invalid Phone: Must start with + and have 8-15 digits.", "error");
                            return;
                        }
                        if (!address.trim()) { showToast("Please enter delivery address.", "error"); return; }

                        return actions.order.create({
                            purchase_units: [{
                                amount: { value: amount }
                            }]
                        });
                    },
                    onApprove: function (data, actions) {
                        return actions.order.capture().then(function (details) {
                            completeOrder('PayPal', details);
                        });
                    },
                    onError: function (err) {
                        console.error('PayPal Error', err);
                        showToast("PayPal encountered an error.", "error");
                    }
                }).render('#paypal-button-container');
                paypalRendered = true;
            }
        </script>
        <!-- Confirmation Modal -->
        <div id="confirmation-modal" style="display: none;"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl animate-in zoom-in-95 duration-200">
                <div class="text-center">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <img src="https://api.iconify.design/lucide:alert-triangle.svg?color=%23ef4444" width="24">
                    </div>
                    <h3 class="text-lg font-bold text-stone-900 mb-2">Clear Transaction?</h3>
                    <p class="text-sm text-stone-500 mb-6">Are you sure you want to cancel this transaction? Your order
                        will remain unpaid.</p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="closeConfirmModal()"
                            class="px-4 py-2 rounded-lg bg-stone-100 text-stone-600 font-bold text-sm hover:bg-stone-200 transition-colors">
                            No, Go Back
                        </button>
                        <button onclick="performCancel(event)"
                            class="px-4 py-2 rounded-lg bg-red-500 text-white font-bold text-sm hover:bg-red-600 transition-colors shadow-lg shadow-red-500/30">
                            Yes, Clear It
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function confirmCancel() {
                document.getElementById('confirmation-modal').style.display = 'flex';
            }

            function closeConfirmModal() {
                document.getElementById('confirmation-modal').style.display = 'none';
            }

            async function performCancel(event) {
                // safer button selection
                const btn = event ? event.target.closest('button') : document.querySelector('#confirmation-modal button.bg-red-500');
                if (!btn) {
                    console.error("Cancel button not found");
                    return;
                }

                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerHTML = `<img src="https://api.iconify.design/lucide:loader-2.svg?color=white" class="w-4 h-4 animate-spin inline"> Cancelling...`;

                if (isAuction) {
                    showToast(`Transaction cleared. Returning to auctions...`, 'success');
                    setTimeout(() => {
                        window.location.href = 'auctions.html';
                    }, 1000);
                    return;
                }

                if (!finalOrderIds) {
                    showToast("No Order ID found to cancel", "error");
                    btn.disabled = false;
                    btn.innerText = originalText;
                    return;
                }

                const ids = finalOrderIds.split(',').filter(id => id.trim() !== ''); // Filter empty strings

                if (ids.length === 0) {
                    showToast("Invalid Order IDs", "error");
                    btn.disabled = false;
                    btn.innerText = originalText;
                    return;
                }

                const source = urlParams.get('source');
                const isCart = source === 'cart';

                console.log("Cancelling Orders:", ids, "Source:", source, "Restore:", isCart);
                const apiUrl = '../../backend/api/orders/cancel-order.php';
                console.log("Fetching API:", apiUrl);

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            order_ids: ids,
                            restore_to_cart: isCart
                        })
                    });

                    console.log("Response Status:", response.status, response.statusText);
                    const responseText = await response.text();
                    console.log("Response Text:", responseText);

                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status} ${response.statusText}\nResponse: ${responseText.substring(0, 100)}`);
                    }

                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error("Invalid JSON response from server: " + responseText.substring(0, 50) + "...");
                    }

                    if (result.success) {
                        const targetPage = isCart ? 'cart.html' : 'catalog.html';
                        showToast(`Transaction cleared. Returning to ${isCart ? 'cart' : 'catalog'}...`, 'success');
                        setTimeout(() => {
                            window.location.href = targetPage;
                        }, 1000);
                    } else {
                        showToast(result.message || 'Failed to cancel', 'error');
                        btn.disabled = false;
                        btn.innerText = originalText;
                    }
                } catch (error) {
                    console.error("Cancel error:", error);
                    alert("Cancel Error Details:\n" + error.message); // Use alert for easier debugging by user
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            }

            function renderAmountDisplay() {
                if (amount <= 0) return;

                let displayPrice = "";
                // Use stored rate if currency matches, ensuring EXACT price match for locked orders
                if (window.orderDetails && window.orderDetails.currency_code === CurrencyManager.settings.code && window.orderDetails.exchange_rate) {
                    const lockedRate = parseFloat(window.orderDetails.exchange_rate);
                    const lockedVal = CurrencyManager.snap(amount * lockedRate);
                    displayPrice = CurrencyManager.settings.symbol + lockedVal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                } else {
                    // Standard conversion handling both USD inputs (orders) and non-USD inputs (auctions)
                    displayPrice = CurrencyManager.formatFrom(amount, sourceCurrency);
                }

                const amountDisplay = document.getElementById('amount-display');
                amountDisplay.innerText = displayPrice;
            }

            // Exposed for main.js CurrencyManager
            window.updatePaymentPrice = function () {
                renderAmountDisplay();
            }
        </script>
        <script src="../assets/js/main.js?v=2.2"></script>
</body>

</html>