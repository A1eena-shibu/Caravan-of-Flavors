<!DOCTYPE html>
<html lang="en">
<script>
    // Immediate Session Enforcement
    (async () => {
        const res = await fetch('../../backend/api/auth/check-session.php');
        const data = await res.json();
        if (!data.logged_in) window.location.href = '../auth/login.html';
    })();
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Caravan of Flavours</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF7E21',
                        'primary-hover': '#E66D1A',
                        'bg-dark': '#0C0A09',
                        'bg-dashboard': '#14110F',
                        'card-bg': '#1C1917',
                        'border-color': '#292524',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="../assets/css/country-selector.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../assets/js/main.js?v=2.5"></script>
    <script src="../assets/js/country-selector.js?v=1.2"></script>
    <style>
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            min-width: 320px;
            padding: 16px 20px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 1px solid #e2e8f0;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .toast-success .toast-icon {
            background: #dcfce7;
            color: #16a34a;
        }

        .toast-error .toast-icon {
            background: #fee2e2;
            color: #dc2626;
        }

        .toast-warning .toast-icon {
            background: #fef9c3;
            color: #ca8a04;
        }

        .toast-message {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        @keyframes progress {
            from {
                width: 100%;
            }

            to {
                width: 0%;
            }
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #e2e8f0;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .toast-success .toast-progress {
            background: #22c55e;
        }

        .toast-error .toast-progress {
            background: #ef4444;
        }

        .toast-warning .toast-progress {
            background: #eab308;
        }
    </style>
</head>

<body style="background: #f8fafc; color: #1e293b;">
    <aside style="width: 240px; background: #0f172a; position: fixed; height: 100vh; padding: 24px; color: white;">
        <div class="logo" style="margin-bottom: 40px; display: flex; align-items: center; gap: 14px;">
            <img src="../assets/images/logo.png" alt="Logo" style="height: 42px; width: auto; object-fit: contain;">
            <div style="display: flex; flex-direction: column;">
                <h3
                    style="font-size: 18px; color: #ffffff; font-weight: 700; line-height: 1.1; letter-spacing: -0.02em; margin: 0;">
                    Caravan</h3>
                <span
                    style="font-size: 10px; color: #94a3b8; letter-spacing: 0.1em; font-weight: 700; text-transform: uppercase;">OF
                    FLAVOURS</span>
            </div>
        </div>

        <nav style="display: flex; flex-direction: column; gap: 4px;">
            <a href="#" onclick="switchView('overview')" id="nav-overview"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: white; background: rgba(255, 255, 255, 0.1); font-weight: 700; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:layout-grid.svg?color=white" width="18" alt="">
                Overview
            </a>
            <a href="#" onclick="switchView('users')" id="nav-users"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:users.svg?color=%2394a3b8" width="18" alt="">
                Manage Users
            </a>
            <a href="#" onclick="switchView('delivery')" id="nav-delivery"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:truck.svg?color=%2394a3b8" width="18" alt="">
                Delivery
            </a>
            <a href="#" onclick="switchView('transactions')" id="nav-transactions"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:shopping-cart.svg?color=%2394a3b8" width="20">
                Transactions
            </a>
            <a href="#" onclick="switchView('auctions')" id="nav-auctions"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:gavel.svg?color=%2394a3b8" width="20">
                Auctions
            </a>
            <a href="#" onclick="switchView('activity')" id="nav-activity"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:activity.svg?color=%2394a3b8" width="18" alt="">
                Activity Logs
            </a>
            <a href="#" onclick="switchView('exports')" id="nav-exports"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:file-text.svg?color=%2394a3b8" width="18" alt="">
                Export Logs
            </a>
            <a href="#" onclick="switchView('analysis')" id="nav-analysis"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:pie-chart.svg?color=%2394a3b8" width="18" alt="">
                Analysis
            </a>
            <a href="#" onclick="switchView('add-admins')" id="nav-add-admins"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:user-plus.svg?color=%2394a3b8" width="18" alt="">
                Add Admins
            </a>
            <a href="#" onclick="switchView('profile')" id="nav-profile"
                style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 500; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:user.svg?color=%2394a3b8" width="18" alt="">
                Profile
            </a>
        </nav>
        <!-- Script moved to bottom -->

        <div style="position: absolute; bottom: 24px; left: 24px; right: 24px;">
            <button onclick="logout()"
                style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #ff0000; background: transparent; border: 2px solid #ff0000; width: 100%; cursor: pointer; font-weight: 700; font-size: 14px;">
                <img src="https://api.iconify.design/lucide:log-out.svg?color=%23ff0000" width="18"
                    style="transform: rotate(180deg);" alt="">
                Sign Out
            </button>
        </div>
    </aside>

    <main style="margin-left: 240px; padding: 24px 40px;">
        <header style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px;">
            <div>
                <h1 id="dashboard-title" style="font-size: 28px; font-weight: 700; margin: 0;">System Overview</h1>
                <p style="color: #64748b; margin-top: 4px;">Real-time performance metrics for Caravan of Flavours.</p>
            </div>
            <div style="display: flex; align-items: center; gap: 20px; margin-top: -8px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="text-align: right;">
                        <div id="header-name" style="font-weight: 700; font-size: 14px;">Admin</div>
                        <div id="header-role" style="font-size: 12px; color: #64748b;">Super Administrator</div>
                    </div>
                    <div id="header-avatar"
                        style="width: 44px; height: 44px; background: #ff7e21; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                        AD</div>
                </div>
            </div>
        </header>

        <div id="dashboard-overview">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 40px;">
                <div
                    style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                        <div style="background: #eff6ff; padding: 10px; border-radius: 10px;">
                            <img src="https://api.iconify.design/lucide:users.svg?color=%233b82f6" width="24" alt="">
                        </div>
                        <span style="color: #22c55e; font-size: 12px; font-weight: 700;">Live</span>
                    </div>
                    <div style="font-size: 14px; color: #64748b; font-weight: 500;">Total Users</div>
                    <div id="total-users" style="font-size: 32px; font-weight: 700; margin-top: 8px;">--</div>
                </div>
                <div
                    style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                        <div style="background: #fdf2f8; padding: 10px; border-radius: 10px;">
                            <img src="https://api.iconify.design/lucide:credit-card.svg?color=%23ec4899" width="24"
                                alt="">
                        </div>
                        <span style="color: #22c55e; font-size: 12px; font-weight: 700;">Global</span>
                    </div>
                    <div style="font-size: 14px; color: #64748b; font-weight: 500;">Total Revenue</div>
                    <div style="display: flex; align-items: center; gap: 4px; margin-top: 8px;">
                        <span class="currency-symbol"
                            style="font-size: 20px; color: #1e293b; font-weight: 700; opacity: 0.3;">₹</span>
                        <div id="total-revenue"
                            style="font-size: 32px; font-weight: 700; color: #1e293b; line-height: 1;">--</div>
                    </div>
                </div>
                <div
                    style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                        <div style="background: #f0fdf4; padding: 10px; border-radius: 10px;">
                            <img src="https://api.iconify.design/lucide:shopping-bag.svg?color=%2322c55e" width="24"
                                alt="">
                        </div>
                        <span style="color: #64748b; font-size: 12px;">Active</span>
                    </div>
                    <div style="font-size: 14px; color: #64748b; font-weight: 500;">Active Orders</div>
                    <div id="active-orders" style="font-size: 32px; font-weight: 700; margin-top: 8px;">--</div>
                </div>
            </div>

            <!-- Charts & User Insights -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px; margin-bottom: 40px;">
                <div style="background: white; border-radius: 20px; padding: 32px; border: 1px solid #e2e8f0;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                        <h3 style="font-size: 18px; font-weight: 700; margin: 0;">Global Sales Performance</h3>
                        <select id="period-filter" onchange="updateSalesChart(this.value)"
                            style="background: #f1f5f9; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; color: #475569; outline: none;">
                            <option value="12_months">Last 12 Months</option>
                            <option value="30_days">Last 30 Days</option>
                        </select>
                    </div>
                    <canvas id="salesChart" height="300" style="max-height: 300px;"></canvas>
                </div>

                <div style="background: #0f172a; border-radius: 20px; padding: 32px; color: white;">
                    <h3 style="font-size: 18px; font-weight: 700; margin: 0 0 24px 0;">User Insights</h3>
                    <div style="display: flex; flex-direction: column; gap: 24px;">
                        <!-- Pending Verifications Removed -->

                        <!-- Top Farmers -->
                        <div>
                            <h4 style="font-size: 13px; font-weight: 700; color: #94a3b8; margin: 0 0 12px 0;">Top
                                Farmers
                                (Revenue)</h4>
                            <div id="top-farmers-list" style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="font-size: 12px; color: #64748b;">Loading...</div>
                            </div>
                        </div>

                        <!-- Recent Registrations -->
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                            <h4 style="font-size: 13px; font-weight: 700; color: #94a3b8; margin: 0 0 12px 0;">Newest
                                Registrations</h4>
                            <div id="recent-registrations-list"
                                style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="font-size: 12px; color: #64748b;">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent User Activity -->
            <div
                style="background: white; border-radius: 20px; padding: 32px; border: 1px solid #e2e8f0; margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="font-size: 18px; font-weight: 700; margin: 0;">Recent User Activity</h3>
                    <button id="view-all-logs-btn" onclick="switchView('activity')"
                        style="color: #3b82f6; background: transparent; border: none; font-weight: 700; font-size: 13px; cursor: pointer;">View
                        All Logs</button>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <th
                                style="padding: 16px; text-align: center; font-size: 12px; color: #64748b; font-weight: 700; width: 20%;">
                                TIME</th>
                            <th
                                style="padding: 16px; text-align: center; font-size: 12px; color: #64748b; font-weight: 700; width: 20%;">
                                USER</th>
                            <th
                                style="padding: 16px; text-align: center; font-size: 12px; color: #64748b; font-weight: 700; width: 45%;">
                                ACTION</th>
                            <th
                                style="padding: 16px; text-align: center; font-size: 12px; color: #64748b; font-weight: 700; width: 15%;">
                                TYPE</th>
                        </tr>
                    </thead>
                    <tbody id="activity-list">
                        <tr style="border-bottom: 1px solid #f8fafc;">
                            <td colspan="4" style="padding: 40px; text-align: center;">
                                <img src="https://api.iconify.design/lucide:loader-2.svg"
                                    class="w-8 h-8 animate-spin mx-auto text-orange-500" alt="">
                                <p style="color: #94a3b8; font-size: 13px; margin-top: 10px;">Syncing global logs...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Manage Users Section (Hidden by Default) -->
        <div id="manage-users-view" style="display: none;">
            <!-- User Stats Section -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 24px;">
                <!-- Total Users -->
                <div
                    style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 48px; height: 48px; border-radius: 12px; background: #eff6ff; display: flex; align-items: center; justify-content: center;">
                        <img src="https://api.iconify.design/lucide:users.svg?color=%233b82f6" width="24">
                    </div>
                    <div>
                        <div style="font-size: 13px; color: #64748b; font-weight: 600;">Total Users</div>
                        <div style="font-size: 24px; font-weight: 700; color: #1e293b;" id="stat-total-users">0</div>
                    </div>
                </div>
                <!-- Customers -->
                <div
                    style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 48px; height: 48px; border-radius: 12px; background: #fdf4ff; display: flex; align-items: center; justify-content: center;">
                        <img src="https://api.iconify.design/lucide:user.svg?color=%23c026d3" width="24">
                    </div>
                    <div>
                        <div style="font-size: 13px; color: #64748b; font-weight: 600;">Customers</div>
                        <div style="font-size: 24px; font-weight: 700; color: #1e293b;" id="stat-total-customers">0
                        </div>
                    </div>
                </div>
                <!-- Farmers -->
                <div
                    style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 48px; height: 48px; border-radius: 12px; background: #ecfdf5; display: flex; align-items: center; justify-content: center;">
                        <img src="https://api.iconify.design/lucide:sprout.svg?color=%2310b981" width="24">
                    </div>
                    <div>
                        <div style="font-size: 13px; color: #64748b; font-weight: 600;">Farmers</div>
                        <div style="font-size: 24px; font-weight: 700; color: #1e293b;" id="stat-total-farmers">0</div>
                    </div>
                </div>
                <!-- Delivery Agents -->
                <div
                    style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 48px; height: 48px; border-radius: 12px; background: #fff7ed; display: flex; align-items: center; justify-content: center;">
                        <img src="https://api.iconify.design/lucide:truck.svg?color=%23ea580c" width="24">
                    </div>
                    <div>
                        <div style="font-size: 13px; color: #64748b; font-weight: 600;">Delivery Agents</div>
                        <div style="font-size: 24px; font-weight: 700; color: #1e293b;" id="stat-total-agents">0</div>
                    </div>
                </div>
            </div>

            <div style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 700;">User Management</h2>
                    <input type="text" id="user-search-input" placeholder="Search users..." onkeyup="filterUsers()"
                        style="border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 8px; font-size: 14px;">
                </div>
                <table style="width: 100%; text-align: left; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #f1f5f9;">
                            <th style="padding: 12px; font-size: 13px; color: #64748b; width: 35%; text-align: center;">
                                User</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; width: 20%; text-align: center;">
                                Role</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; width: 20%; text-align: center;">
                                Joined</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; width: 25%; text-align: center;">
                                Action</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Delivery Section (Hidden by Default) -->
        <div id="delivery-view" style="display: none;">
            <div style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 700;">Delivery Management</h2>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="openAddAgentModal()"
                            style="padding: 8px 16px; background: #ff7e21; color: white; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; font-size: 13px;">
                            Add Delivery Agent
                        </button>
                        <button
                            onclick="document.getElementById('delivery-agents-list').scrollIntoView({behavior: 'smooth'})"
                            style="padding: 8px 16px; background: #f1f5f9; color: #475569; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                            <img src="https://api.iconify.design/lucide:users.svg?color=%23475569" width="14">
                            View Delivery Agents
                        </button>
                    </div>
                </div>
            </div>
            <table style="width: 100%; text-align: center; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #f1f5f9;">
                        <th style="padding: 12px; font-size: 13px; color: #64748b; width: 10%;">ID</th>
                        <th style="padding: 12px; font-size: 13px; color: #64748b; width: 25%; text-align: center;">
                            Product</th>
                        <th style="padding: 12px; font-size: 13px; color: #64748b; width: 20%;">Customer</th>
                        <th style="padding: 12px; font-size: 13px; color: #64748b; width: 30%;">Address</th>
                        <th style="padding: 12px; font-size: 13px; color: #64748b; width: 15%;">Agent</th>
                        <th style="padding: 12px; font-size: 13px; color: #64748b; width: 15%;">Status</th>
                    </tr>
                </thead>
                <tbody id="delivery-table-body">
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td colspan="5" style="padding: 40px; text-align: center;">
                            <div style="color: #94a3b8; font-size: 13px;">No active deliveries found</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Delivery Agents Section -->
            <div id="delivery-agents-list"
                style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0; margin-top: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 700;">Delivery Agents</h2>
                    <button onclick="loadAllDeliveryAgents()"
                        style="color: #64748b; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500;">
                        <img src="https://api.iconify.design/lucide:refresh-cw.svg?color=%2364748b" width="14"> Refresh
                    </button>
                </div>
                <table style="width: 100%; text-align: left; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #f1f5f9;">
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Agent</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Phone</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Location
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="agents-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Transactions View -->
        <div id="transactions-view" style="display: none;">
            <div style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">Global Transactions</h2>
                <table style="width: 100%; text-align: center; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #f1f5f9;">
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">ID
                            </th>
                            <th style="padding: 12px 24px; font-size: 13px; color: #64748b; text-align: center;">Product
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Customer
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Farmer</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Amount</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Auctions View (New Dedicated Section) -->
        <div id="auctions-view" style="display: none;">
            <div style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">Auctions Management</h2>
                <table style="width: 100%; text-align: center; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #f1f5f9;">
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">ID</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">
                                Product
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">
                                Farmer</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Winner</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Current Bid
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">End Time
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">
                                Status</th>
                        </tr>
                    </thead>
                    <tbody id="auctions-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export Logs View -->
        <div id="exports-view" style="display: none;">
            <div style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0;">
                <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">Export Log Book</h2>
                <table style="width: 100%; text-align: left; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #f1f5f9;">
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">ID</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Product</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Farmer</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Destination
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Qty</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="exports-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>


        <!-- Activity Logs View -->
        <div id="activity-view" style="display: none;">
            <div style="background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 700;">User Activity Logs</h2>
                    <button onclick="loadActivityLogs()"
                        style="color: #64748b; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500;">
                        <img src="https://api.iconify.design/lucide:refresh-cw.svg?color=%2364748b" width="14"> Refresh
                    </button>
                </div>
                <table style="width: 100%; text-align: left; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #f1f5f9;">
                            <th style="padding: 12px; font-size: 13px; color: #64748b; width: 20%; text-align: center;">
                                Time</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; width: 20%; text-align: center;">
                                User</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; width: 45%; text-align: center;">
                                Action</th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; width: 15%; text-align: center;">
                                Type</th>
                        </tr>
                    </thead>
                    <tbody id="all-activity-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>



        <!-- Add Admins View -->
        <div id="add-admins-view" style="display: none;">
            <div
                style="background: white; border-radius: 20px; padding: 40px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); width: 100%;">
                <h3
                    style="font-size: 20px; font-weight: 700; margin-bottom: 24px; color: #1e293b; display: flex; align-items: center; gap: 10px;">
                    <img src="https://api.iconify.design/lucide:user-plus.svg?color=%23ff7e21" width="24">
                    Create New Administrator
                </h3>

                <form id="add-admin-form" onsubmit="event.preventDefault(); handleAdminCreation();">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <div>
                            <label
                                style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase;">Full
                                Name</label>
                            <input type="text" id="new-admin-name" required placeholder="John Doe"
                                style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase;">Email
                                Address</label>
                            <input type="email" id="new-admin-email" required placeholder="admin@example.com"
                                style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <div>
                            <label
                                style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase;">Phone
                                Number</label>
                            <input type="tel" id="new-admin-phone" required maxlength="16" placeholder="+1234567890"
                                oninput="validatePhoneInput(this)"
                                style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase;">Address</label>
                            <input type="text" id="new-admin-address" required
                                placeholder="e.g. Country, State, District, City, Street Name, House Name/House No..."
                                style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                        </div>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 12px; text-transform: uppercase;">Access
                            Level</label>
                        <div style="display: flex; gap: 24px;">
                            <label
                                style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #1e293b; font-weight: 500;">
                                <input type="checkbox" id="access-delivery-only"
                                    onchange="handleAccessCheckbox('delivery')"
                                    style="width: 18px; height: 18px; accent-color: #ff7e21; cursor: pointer;">
                                Delivery Access Only
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #1e293b; font-weight: 500;">
                                <input type="checkbox" id="access-all" onchange="handleAccessCheckbox('all')"
                                    style="width: 18px; height: 18px; accent-color: #ff7e21; cursor: pointer;">
                                Include All Access
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase;">Country
                            & Currency</label>
                        <button type="button" onclick="openCountrySelectorForNewAdmin()"
                            style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none; text-align: left; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                            <span id="new-admin-country-display" style="color: #94a3b8;">Select Country</span>
                            <img src="https://api.iconify.design/lucide:chevron-down.svg?color=%2394a3b8" width="18">
                        </button>
                        <input type="hidden" id="new-admin-country">
                        <input type="hidden" id="new-admin-currency-code">
                        <input type="hidden" id="new-admin-currency-symbol">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                        <div>
                            <label
                                style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase;">Password</label>
                            <div style="position: relative;">
                                <input type="password" id="new-admin-password" required minlength="8"
                                    placeholder="••••••••"
                                    style="width: 100%; padding: 12px 16px; padding-right: 40px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                                <button type="button" onclick="togglePasswordVisibility('new-admin-password')"
                                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; padding: 4px;">
                                    <img src="https://api.iconify.design/lucide:eye.svg?color=%2394a3b8" width="18"
                                        id="new-admin-password-icon">
                                </button>
                            </div>
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase;">Confirm
                                Password</label>
                            <div style="position: relative;">
                                <input type="password" id="new-admin-confirm" required minlength="8"
                                    placeholder="••••••••"
                                    style="width: 100%; padding: 12px 16px; padding-right: 40px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                                <button type="button" onclick="togglePasswordVisibility('new-admin-confirm')"
                                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; padding: 4px;">
                                    <img src="https://api.iconify.design/lucide:eye.svg?color=%2394a3b8" width="18"
                                        id="new-admin-confirm-icon">
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="admin-error-container"
                        style="display: none; padding: 12px; background: #fef2f2; border: 1px solid #fee2e2; border-radius: 8px; color: #ef4444; font-size: 14px; font-weight: 600; margin-bottom: 24px; align-items: center; gap: 8px;">
                        <img src="https://api.iconify.design/lucide:alert-circle.svg?color=%23ef4444" width="18">
                        <span id="admin-error-message"></span>
                    </div>

                    <div style="display: flex; justify-content: flex-end;">
                        <button type="submit" id="create-admin-btn"
                            style="padding: 14px 40px; background: #ff7e21; color: white; border-radius: 12px; font-weight: 700; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(255, 126, 33, 0.2);"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 8px -1px rgba(255, 126, 33, 0.3)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(255, 126, 33, 0.2)'">
                            Create Admin Account
                        </button>
                    </div>
                </form>
            </div>

            <!-- Existing Admins List Section -->
            <div
                style="background: white; border-radius: 20px; padding: 40px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); width: 100%; margin: 32px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 700; color: #1e293b;">Existing Administrators <span
                            id="existing-admins-count"
                            style="font-size: 14px; font-weight: 500; color: #64748b;">(0)</span></h2>
                    <button onclick="loadAdmins()"
                        style="color: #64748b; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500;">
                        <img src="https://api.iconify.design/lucide:refresh-cw.svg?color=%2364748b" width="14">
                        Refresh
                    </button>
                </div>
                <table style="width: 100%; text-align: left; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #f1f5f9;">
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Admin
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Phone
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Access Level
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Joined
                            </th>
                            <th style="padding: 12px; font-size: 13px; color: #64748b; text-align: center;">Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="admins-list-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>



        <!-- Analysis View -->
        <div id="analysis-view" style="display: none;">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px; margin-bottom: 32px;">
                <!-- User Growth Trend -->
                <div
                    style="background: white; border-radius: 20px; padding: 32px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                    <h3
                        style="font-size: 18px; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
                        <img src="https://api.iconify.design/lucide:trending-up.svg?color=%233b82f6" width="20">
                        User Growth Trend (30 Days)
                    </h3>
                    <div style="height: 350px;">
                        <canvas id="growthTrendChart"></canvas>
                    </div>
                </div>

                <!-- Order Success / Status Funnel -->
                <div
                    style="background: white; border-radius: 20px; padding: 32px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                    <h3
                        style="font-size: 18px; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
                        <img src="https://api.iconify.design/lucide:filter.svg?color=%238b5cf6" width="20">
                        Order Funnel
                    </h3>
                    <div style="height: 350px;">
                        <canvas id="orderFunnelChart"></canvas>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                <!-- Farmer Leaderboard -->
                <div
                    style="background: white; border-radius: 20px; padding: 32px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                    <h3
                        style="font-size: 18px; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
                        <img src="https://api.iconify.design/lucide:award.svg?color=%23f59e0b" width="20">
                        Top Farmers by Revenue
                    </h3>
                    <div style="height: 300px;">
                        <canvas id="farmerLeaderboardChart"></canvas>
                    </div>
                </div>

                <!-- Revenue Trend -->
                <div
                    style="background: white; border-radius: 20px; padding: 32px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                    <h3
                        style="font-size: 18px; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
                        <img src="https://api.iconify.design/lucide:dollar-sign.svg?color=%2310b981" width="20">
                        Daily Revenue Trend (30 Days)
                    </h3>
                    <div style="height: 300px;">
                        <canvas id="revenueTrendChart"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <!-- Profile View -->
        <div id="profile-view" style="display: none;">
            <div style="width: 100%;">
                <div
                    style="background: white; border-radius: 20px; padding: 40px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); width: 100%;">
                    <div
                        style="display: flex; align-items: center; gap: 32px; border-bottom: 2px solid #f1f5f9; padding-bottom: 32px; margin-bottom: 32px;">
                        <div style="width: 100px; height: 100px; background: #ff7e21; border-radius: 24px; display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: 700;"
                            id="profile-avatar-large">
                            AD
                        </div>
                        <div>
                            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;"
                                id="profile-name-display">Admin</h2>
                            <p style="color: #64748b;" id="profile-role-display">Super Administrator</p>
                        </div>
                    </div>

                    <form id="profile-form" onsubmit="event.preventDefault(); handleProfileUpdate();">
                        <!-- Personal Info Section -->
                        <h3
                            style="font-size: 16px; font-weight: 700; margin-bottom: 20px; color: #1e293b; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 8px;">
                            <img src="https://api.iconify.design/lucide:user.svg?color=%2364748b" width="18">
                            Personal Information
                        </h3>

                        <!-- Row 1: Full Name & Account Type -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">Full
                                    Name</label>
                                <input type="text" id="profile-full-name" required
                                    style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">Account
                                    Type</label>
                                <input type="text" id="profile-role" disabled
                                    style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f1f5f9; color: #94a3b8; font-weight: 500; cursor: not-allowed;">
                            </div>
                        </div>

                        <!-- Row 2: Email & Phone -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">Email
                                    Address</label>
                                <input type="email" id="profile-email" required
                                    style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">Phone
                                    Number</label>
                                <input type="tel" id="profile-phone" placeholder="Phone" maxlength="16"
                                    oninput="validatePhoneInput(this)"
                                    style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                                <p class="text-[10px] text-stone-400 mt-1">Format: +1234567890</p>
                            </div>
                        </div>

                        <!-- Row 3: Country & Address -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Country & Currency
                                </label>
                                <button type="button" onclick="openCountrySelectorForProfile()" id="admin-country-btn"
                                    style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none; text-align: left; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                    <span id="admin-country-display">Select Country</span>
                                    <img src="https://api.iconify.design/lucide:chevron-down.svg?color=%2394a3b8"
                                        width="18">
                                </button>
                                <input type="hidden" id="profile-country">
                                <input type="hidden" id="profile-currency-code">
                                <input type="hidden" id="profile-currency-symbol">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">Address</label>
                                <input type="text" id="profile-address" placeholder="Enter Address"
                                    style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none;">
                            </div>
                        </div>

                        <!-- Security Section -->
                        <div
                            style="border-top: 1px solid #f1f5f9; padding-top: 32px; margin-top: 32px; margin-bottom: 32px;">
                            <h3
                                style="font-size: 16px; font-weight: 700; margin-bottom: 8px; color: #1e293b; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 8px;">
                                <img src="https://api.iconify.design/lucide:shield-check.svg?color=%2310b981"
                                    width="18">
                                Security & Password
                            </h3>
                            <p style="font-size: 13px; color: #64748b; margin-bottom: 24px;">Leave password fields
                                blank
                                to keep your current password unchanged.</p>

                            <div style="margin-bottom: 24px;">
                                <label
                                    style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px;">Current
                                    Password</label>
                                <div style="position: relative;">
                                    <input type="password" id="current-password" placeholder="Enter current password"
                                        style="width: 100%; padding: 12px 16px; padding-right: 45px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none; transition: border-color 0.2s;"
                                        onfocus="this.style.borderColor='#ff7e21'"
                                        onblur="this.style.borderColor='#e2e8f0'">
                                    <button type="button" onclick="togglePasswordVisibility('current-password')"
                                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; padding: 4px;">
                                        <img src="https://api.iconify.design/lucide:eye.svg?color=%2394a3b8" width="18"
                                            id="current-password-icon">
                                    </button>
                                </div>
                                <p
                                    style="font-size: 11px; color: #64748b; margin-top: 6px; display: flex; align-items: center; gap: 4px;">
                                    <img src="https://api.iconify.design/lucide:info.svg?color=%2364748b" width="12">
                                    <span>Required only when changing your password</span>
                                </p>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 16px;">
                                <div>
                                    <label
                                        style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px;">New
                                        Password</label>
                                    <div style="position: relative;">
                                        <input type="password" id="new-password" placeholder="Min. 8 characters"
                                            style="width: 100%; padding: 12px 16px; padding-right: 45px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none; transition: border-color 0.2s;"
                                            onfocus="this.style.borderColor='#ff7e21'"
                                            onblur="this.style.borderColor='#e2e8f0'">
                                        <button type="button" onclick="togglePasswordVisibility('new-password')"
                                            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; padding: 4px;">
                                            <img src="https://api.iconify.design/lucide:eye.svg?color=%2394a3b8"
                                                width="18" id="new-password-icon">
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label
                                        style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px;">Confirm
                                        New Password</label>
                                    <div style="position: relative;">
                                        <input type="password" id="confirm-password" placeholder="Repeat new password"
                                            oninput="checkPasswordMatch()"
                                            style="width: 100%; padding: 12px 16px; padding-right: 45px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; outline: none; transition: border-color 0.2s;"
                                            onfocus="this.style.borderColor='#ff7e21'"
                                            onblur="this.style.borderColor='#e2e8f0'">
                                        <button type="button" onclick="togglePasswordVisibility('confirm-password')"
                                            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; padding: 4px;">
                                            <img src="https://api.iconify.design/lucide:eye.svg?color=%2394a3b8"
                                                width="18" id="confirm-password-icon">
                                        </button>
                                    </div>
                                </div>
                            </div>



                            <!-- Password Match Indicator -->
                            <div id="password-match-container" style="display: none;">
                                <p id="password-match-text"
                                    style="font-size: 12px; margin: 0; display: flex; align-items: center; gap: 6px;">
                                    <img id="password-match-icon"
                                        src="https://api.iconify.design/lucide:x-circle.svg?color=%23ef4444" width="14">
                                    <span id="password-match-message"
                                        style="color: #ef4444; font-weight: 600;">Passwords do not match</span>
                                </p>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: flex-end;">
                            <button type="submit"
                                style="padding: 14px 40px; background: #ff7e21; color: white; border-radius: 12px; font-weight: 700; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(255, 126, 33, 0.2);"
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 8px -1px rgba(255, 126, 33, 0.3)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(255, 126, 33, 0.2)'">
                                Save All Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- User Details Modal -->
        <div id="user-modal"
            class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl p-8 max-w-lg w-full shadow-2xl animate-in zoom-in-95 duration-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-stone-900">User Details</h3>
                    <button onclick="closeUserModal()"
                        class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center hover:bg-stone-200">
                        <img src="https://api.iconify.design/lucide:x.svg?color=%231c1917" width="18">
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-16 h-16 bg-stone-100 rounded-full flex items-center justify-center text-2xl font-bold text-stone-500"
                            id="modal-user-avatar">
                            --
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-stone-900" id="modal-user-name">--</h4>
                            <p class="text-sm text-stone-500" id="modal-user-role">--</p>
                            <div id="modal-user-status" class="mt-1"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-stone-50 rounded-xl">
                            <p class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Email
                                Address
                            </p>
                            <p class="text-sm font-semibold text-stone-700 break-all" id="modal-user-email">--</p>
                        </div>
                        <div class="p-4 bg-stone-50 rounded-xl">
                            <p class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Phone
                                Number
                            </p>
                            <p class="text-sm font-semibold text-stone-700" id="modal-user-phone">--</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-stone-50 rounded-xl">
                            <p class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Address
                            </p>
                            <p class="text-sm font-semibold text-stone-700" id="modal-user-address">--</p>
                        </div>
                        <div class="p-4 bg-stone-50 rounded-xl">
                            <p class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">
                                Country/Currency</p>
                            <p class="text-sm font-semibold text-stone-700" id="modal-user-country-currency">--</p>
                        </div>
                    </div>

                    <div class="p-4 bg-stone-50 rounded-xl flex justify-between items-center">
                        <p class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Joined On</p>
                        <p class="text-sm font-semibold text-stone-700" id="modal-user-joined">--</p>
                    </div>

                    <!-- Dynamic Stats Container -->
                    <div id="modal-user-stats-container" class="pt-4 border-t border-stone-100">
                        <!-- Content populated via JS -->
                    </div>
                </div>
            </div>
        </div>



        <!-- Add Delivery Agent Modal -->
        <div id="add-agent-modal" style="display: none;"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl p-8 max-w-lg w-full shadow-2xl animate-in zoom-in-95 duration-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-stone-900">Add Delivery Agent</h3>
                    <button onclick="closeAddAgentModal()"
                        class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center hover:bg-stone-200">
                        <img src="https://api.iconify.design/lucide:x.svg?color=%231c1917" width="18">
                    </button>
                </div>
                <form id="add-agent-form" onsubmit="event.preventDefault(); submitAgentForm();">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-1">Full
                                Name</label>
                            <input type="text" id="agent-name" required placeholder="Full Name"
                                class="w-full px-4 py-2 rounded-xl border border-stone-200 bg-stone-50 focus:border-orange-500 focus:outline-none font-medium">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-1">Email</label>
                                <input type="email" id="agent-email" required placeholder="Email"
                                    class="w-full px-4 py-2 rounded-xl border border-stone-200 bg-stone-50 focus:border-orange-500 focus:outline-none font-medium">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-1">Phone</label>
                                <input type="tel" id="agent-phone" required maxlength="16" placeholder="Phone"
                                    oninput="validatePhoneInput(this)"
                                    class="w-full px-4 py-2 rounded-xl border border-stone-200 bg-stone-50 focus:border-orange-500 focus:outline-none font-medium">
                                <p class="text-[10px] text-stone-400 mt-1">Format: +1234567890</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-1">Password</label>
                                <div class="relative">
                                    <input type="password" id="agent-password" required minlength="8"
                                        placeholder="Password"
                                        class="w-full px-4 py-2 pr-10 rounded-xl border border-stone-200 bg-stone-50 focus:border-orange-500 focus:outline-none font-medium">
                                    <button type="button" onclick="togglePasswordVisibility('agent-password')"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 bg-transparent border-none cursor-pointer p-1">
                                        <img src="https://api.iconify.design/lucide:eye.svg?color=%2394a3b8" width="18"
                                            id="agent-password-icon">
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-1">Confirm
                                    Password</label>
                                <div class="relative">
                                    <input type="password" id="agent-confirm-password" required minlength="8"
                                        placeholder="Confirm Password"
                                        class="w-full px-4 py-2 pr-10 rounded-xl border border-stone-200 bg-stone-50 focus:border-orange-500 focus:outline-none font-medium">
                                    <button type="button" onclick="togglePasswordVisibility('agent-confirm-password')"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 bg-transparent border-none cursor-pointer p-1">
                                        <img src="https://api.iconify.design/lucide:eye.svg?color=%2394a3b8" width="18"
                                            id="agent-confirm-password-icon">
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-1">Country
                                & Currency</label>
                            <button type="button" onclick="openCountrySelectorForAgent()"
                                class="w-full px-4 py-2 rounded-xl border border-stone-200 bg-stone-50 text-left font-medium flex justify-between items-center hover:border-orange-500 focus:outline-none transition-colors">
                                <span id="agent-country-display" class="text-stone-400">Select Country</span>
                                <img src="https://api.iconify.design/lucide:chevron-down.svg?color=%2394a3b8"
                                    width="18">
                            </button>
                            <input type="hidden" id="agent-country">
                            <input type="hidden" id="agent-currency-code">
                            <input type="hidden" id="agent-currency-symbol">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-1">Address</label>
                            <textarea id="agent-address" rows="2"
                                placeholder="e.g. Country, State, District, City, Street Name, House Name/House No..."
                                class="w-full px-4 py-2 rounded-xl border border-stone-200 bg-stone-50 focus:border-orange-500 focus:outline-none font-medium"></textarea>
                        </div>
                        <div id="agent-form-error"
                            class="hidden p-3 bg-red-50 text-red-500 text-xs font-bold rounded-lg flex items-center gap-2">
                            <img src="https://api.iconify.design/lucide:alert-circle.svg?color=%23ef4444" width="14">
                            <span id="agent-form-error-msg">Error message</span>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" onclick="closeAddAgentModal()"
                            class="px-5 py-2.5 rounded-xl bg-stone-100 text-stone-600 font-bold text-sm hover:bg-stone-200 transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-5 py-2.5 rounded-xl bg-orange-500 text-white font-bold text-sm hover:bg-orange-600 transition-colors shadow-lg shadow-orange-500/20">
                            Create Agent
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" style="display: none;"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl animate-in zoom-in-95 duration-200">
                <div class="text-center">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"
                        id="confirm-icon-container">
                        <img src="https://api.iconify.design/lucide:alert-triangle.svg?color=%23ef4444" width="24"
                            id="confirm-icon">
                    </div>
                    <h3 class="text-lg font-bold text-stone-900 mb-2" id="confirm-title">Are you sure?</h3>
                    <p class="text-sm text-stone-500 mb-6" id="confirm-message">Do you really want to perform this
                        action?</p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="closeConfirmModal()"
                            class="px-4 py-2 rounded-lg bg-stone-100 text-stone-600 font-bold text-sm hover:bg-stone-200 transition-colors">
                            Cancel
                        </button>
                        <button id="confirm-action-btn"
                            class="px-4 py-2 rounded-lg bg-red-500 text-white font-bold text-sm hover:bg-red-600 transition-colors shadow-lg shadow-red-500/30">
                            Yes, I'm sure
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Global error handler for debugging
            window.onerror = function (msg, url, lineNo, columnNo, error) {
                console.error('Global Error: ', msg, ' at ', url, ':', lineNo);
                return false;
            };

            function switchView(viewName) {
                // Views
                const views = {
                    overview: document.getElementById('dashboard-overview'),
                    users: document.getElementById('manage-users-view'),
                    delivery: document.getElementById('delivery-view'),
                    transactions: document.getElementById('transactions-view'),
                    auctions: document.getElementById('auctions-view'),
                    exports: document.getElementById('exports-view'),
                    activity: document.getElementById('activity-view'),
                    analysis: document.getElementById('analysis-view'),
                    'add-admins': document.getElementById('add-admins-view'),
                    profile: document.getElementById('profile-view')
                };

                // Nav Items
                const navs = {
                    overview: document.getElementById('nav-overview'),
                    users: document.getElementById('nav-users'),
                    delivery: document.getElementById('nav-delivery'),
                    transactions: document.getElementById('nav-transactions'),
                    auctions: document.getElementById('nav-auctions'),
                    exports: document.getElementById('nav-exports'),
                    activity: document.getElementById('nav-activity'),
                    analysis: document.getElementById('nav-analysis'),
                    'add-admins': document.getElementById('nav-add-admins'),
                    profile: document.getElementById('nav-profile')
                };

                // Hide all, Show selected
                Object.keys(views).forEach(key => {
                    if (views[key]) views[key].style.display = 'none';
                });
                if (views[viewName]) views[viewName].style.display = 'block';

                // Update Title
                const titleEl = document.getElementById('dashboard-title');
                if (titleEl) {
                    const titles = {
                        overview: 'System Overview',
                        users: 'User Management',
                        delivery: 'Delivery Management',
                        transactions: 'Global Transactions',
                        auctions: 'Auctions Management',
                        exports: 'Export Logs',
                        activity: 'User Activity Logs',
                        analysis: 'Platform Analysis',
                        'add-admins': 'Add New Administrator',
                        profile: 'Admin Profile'
                    };
                    titleEl.textContent = titles[viewName] || 'Dashboard';
                }

                // Reset Nav Styles
                Object.keys(navs).forEach(key => {
                    if (navs[key]) {
                        navs[key].style.color = '#94a3b8';
                        navs[key].style.background = 'transparent';
                        // Reset icon color
                        const img = navs[key].querySelector('img');
                        if (img) img.src = img.src.replace('white', '%2394a3b8');
                    }
                });

                // Set Active Nav
                if (navs[viewName]) {
                    navs[viewName].style.color = 'white';
                    navs[viewName].style.background = 'rgba(255, 255, 255, 0.1)';
                    const img = navs[viewName].querySelector('img');
                    if (img) img.src = img.src.replace('%2394a3b8', 'white');
                }

                // Load Data
                if (viewName === 'users') loadUsers();
                if (viewName === 'delivery') {
                    loadDeliveryOrders();
                    loadAllDeliveryAgents();
                }
                if (viewName === 'transactions') loadTransactions();
                if (viewName === 'auctions') loadAdminAuctions();
                if (viewName === 'exports') loadExports();
                if (viewName === 'activity') loadActivityLogs();
                if (viewName === 'analysis') loadAnalysisData();
                if (viewName === 'profile') loadAdminProfile();
                if (viewName === 'overview') loadAdminStats();
                if (viewName === 'add-admins') {
                    document.getElementById('add-admin-form').reset();
                    document.getElementById('admin-error-container').style.display = 'none';
                    loadAdmins();
                }
            }

            async function loadAllDeliveryAgents() {
                try {
                    const response = await fetch('../../backend/api/admin/get-delivery-agents.php');
                    const result = await response.json();
                    if (result.success) {
                        renderDeliveryAgents(result.agents);
                    }
                } catch (error) {
                    console.error('Error loading agents:', error);
                }
            }

            function renderDeliveryAgents(agents) {
                const tbody = document.getElementById('agents-table-body');
                tbody.innerHTML = '';
                if (agents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding:20px; text-align:center; color: #94a3b8;">No agents found.</td></tr>';
                    return;
                }
                agents.forEach(agent => {
                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #f8fafc;">
                            <td style="padding: 16px; text-align: center;">
                                <div style="font-weight:600;">${agent.full_name}</div>
                                <div style="font-size:12px; color:#64748b;">${agent.email}</div>
                            </td>
                            <td style="padding: 16px; text-align: center; color:#64748b;">${agent.phone}</td>
                            <td style="padding: 16px; text-align: center; color:#64748b;">${agent.address}</td>
                            <td style="padding: 16px; text-align: center;">
                                <span style="color:#22c55e; font-weight:600; font-size:12px;">ACTIVE</span>
                            </td>
                        </tr>
                    `;
                });
            }

            async function loadAdmins() {
                try {
                    const response = await fetch('../../backend/api/admin/get-admins.php');
                    const result = await response.json();
                    if (result.success) {
                        renderAdminsList(result.admins);
                    }
                } catch (error) {
                    console.error('Error loading admins:', error);
                }
            }

            async function viewAdmin(admin) {
                document.getElementById('modal-user-name').textContent = admin.full_name;
                document.getElementById('modal-user-email').textContent = admin.email;
                document.getElementById('modal-user-phone').textContent = admin.phone || 'N/A';
                document.getElementById('modal-user-address').textContent = admin.address || 'N/A';
                document.getElementById('modal-user-role').textContent = 'ADMINISTRATOR';
                document.getElementById('modal-user-joined').textContent = new Date(admin.created_at).toLocaleString();

                const userLangCountry = admin.country || 'N/A';
                const userCurrency = admin.currency_code ? `${admin.currency_code} ` : '';
                document.getElementById('modal-user-country-currency').textContent = userCurrency ? `${userLangCountry} (${userCurrency})` : userLangCountry;

                document.getElementById('modal-user-avatar').textContent = admin.full_name.charAt(0);

                let badge = '';
                if (admin.is_active == 0) badge = '<span class="px-2 py-1 bg-red-100 text-red-600 rounded-md text-xs font-bold">DISABLED</span>';
                else badge = '<span class="px-2 py-1 bg-green-100 text-green-600 rounded-md text-xs font-bold">ACTIVE</span>';
                document.getElementById('modal-user-status').innerHTML = badge;

                const statsContainer = document.getElementById('modal-user-stats-container');
                statsContainer.innerHTML = '<p class="text-center text-sm text-stone-500 py-4">Loading stats...</p>';

                document.getElementById('user-modal').classList.remove('hidden');

                try {
                    const response = await fetch(`../../backend/api/admin/get-user-activity-logs.php?user_id=${admin.id}`);
                    const result = await response.json();

                    // Activity Logs Only
                    let html = `<h4 class="text-sm font-bold text-stone-900 mb-2">Recent Administrator Activity</h4>`;

                    if (result.success && result.data && result.data.length > 0) {
                        html += `
                        <div class="overflow-y-auto max-h-60 border rounded-lg border-stone-100">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-stone-50 sticky top-0">
                                    <tr>
                                        <th class="p-2 text-[10px] font-bold text-stone-500">Time</th>
                                        <th class="p-2 text-[10px] font-bold text-stone-500">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    `;
                        result.data.forEach(log => {
                            const date = new Date(log.timestamp).toLocaleString();
                            html += `
                                    <tr class="border-b border-stone-50">
                                        <td class="p-2 text-[10px] text-stone-500 whitespace-nowrap">${date}</td>
                                        <td class="p-2">
                                            <div class="text-xs font-bold text-stone-700">${log.action}</div>
                                            <div class="text-[10px] text-stone-500 truncate max-w-[200px]">${log.details}</div>
                                        </td>
                                    </tr>
                                    `;
                        });
                        html += `</tbody></table></div>`;
                    } else {
                        html += `<p class="text-xs text-stone-500 italic">No recent activity found.</p>`;
                    }
                    statsContainer.innerHTML = html;
                } catch (err) {
                    console.error(err);
                    statsContainer.innerHTML = '<p class="text-red-500 text-xs text-center">Connection error.</p>';
                }
            }

            function renderAdminsList(admins) {
                // Update Count
                const countEl = document.getElementById('existing-admins-count');
                if (countEl) countEl.innerText = `(${admins.length})`;

                const tbody = document.getElementById('admins-list-table-body');
                tbody.innerHTML = '';
                if (admins.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding:24px; text-align:center; color: #94a3b8; font-weight: 500;">No other administrators found.</td></tr>';
                    return;
                }
                admins.forEach(admin => {
                    const statusText = admin.is_active == 1 ? 'ACTIVE' : 'DISABLED';
                    const statusColor = admin.is_active == 1 ? '#22c55e' : '#ef4444';
                    const toggleAction = admin.is_active == 1 ? 'block' : 'unblock';
                    const toggleLabel = admin.is_active == 1 ? 'Disable' : 'Enable';

                    // Style logic: 
                    // If Active (action is Disable) -> Orange/Warning style
                    // If Inactive (action is Enable) -> Green/Success style
                    const toggleBtnStyle = admin.is_active == 1
                        ? 'background: #fff7ed; border: 1px solid #ffedd5; color: #ea580c;'
                        : 'background: #f0fdf4; border: 1px solid #bbf7d0; color: #16a34a;';

                    // Access Badge Logic
                    const accessLabel = admin.admin_access === 'delivery_only' ? 'Delivery Only' : 'Full Access';
                    const accessStyle = admin.admin_access === 'delivery_only'
                        ? 'background: #fef9c3; color: #ca8a04; border: 1px solid #fde047;' // Yellow/Orange
                        : 'background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd;'; // Blue

                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #f8fafc;">
                            <td style="padding: 16px; text-align: center;">
                                <div style="font-weight:600;">${admin.full_name}</div>
                                <div style="font-size:12px; color:#64748b;">${admin.email}</div>
                            </td>
                            <td style="padding: 16px; text-align: center; color:#64748b;">${admin.phone}</td>
                            <td style="padding: 16px; text-align: center;">
                                <span style="padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; ${accessStyle}">
                                    ${accessLabel}
                                </span>
                            </td>
                            <td style="padding: 16px; text-align: center; color:#64748b;">${new Date(admin.created_at).toLocaleDateString()}</td>
                            <td style="padding: 16px; text-align: center;">
                                    <button onclick='viewAdmin(${JSON.stringify(admin)})'
                                        style="padding: 8px 16px; font-size: 13px; font-weight: 700; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0;">
                                        View
                                    </button>
                                    <button onclick="toggleAdminStatus(${admin.id}, '${toggleAction}')"
                                        style="padding: 8px 16px; font-size: 13px; font-weight: 700; border-radius: 8px; cursor: pointer; transition: all 0.2s; ${toggleBtnStyle}">
                                        ${toggleLabel}
                                    </button>
                                    <button onclick="deleteAdmin(${admin.id}, '${admin.email}')"
                                        style="padding: 8px 16px; font-size: 13px; font-weight: 700; background: #fff1f2; border: 1px solid #fecaca; border-radius: 8px; cursor: pointer; color: #e11d48; transition: all 0.2s;">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }

            function handleAccessCheckbox(type) {
                const deliveryOnly = document.getElementById('access-delivery-only');
                const accessAll = document.getElementById('access-all');

                if (type === 'delivery' && deliveryOnly.checked) {
                    accessAll.checked = false;
                } else if (type === 'all' && accessAll.checked) {
                    deliveryOnly.checked = false;
                } else if (!deliveryOnly.checked && !accessAll.checked) {
                    if (type === 'delivery') deliveryOnly.checked = true;
                    if (type === 'all') accessAll.checked = true;
                }
            }

            async function handleAdminCreation() {
                const errorContainer = document.getElementById('admin-error-container');
                const errorMessage = document.getElementById('admin-error-message');
                const submitBtn = document.getElementById('create-admin-btn');

                // Reset Error
                errorContainer.style.display = 'none';

                const name = document.getElementById('new-admin-name').value.trim();
                const email = document.getElementById('new-admin-email').value.trim();
                const phone = document.getElementById('new-admin-phone').value.trim();
                const address = document.getElementById('new-admin-address').value.trim();
                const country = document.getElementById('new-admin-country').value.trim();
                const currency_code = document.getElementById('new-admin-currency-code').value.trim();
                const currency_symbol = document.getElementById('new-admin-currency-symbol').value.trim();
                const password = document.getElementById('new-admin-password').value;
                const confirm = document.getElementById('new-admin-confirm').value;

                // Validate Fill All Fields
                if (!name || !email || !phone || !address || !country || !password || !confirm) {
                    errorMessage.textContent = 'Please fill in all fields.';
                    errorContainer.style.display = 'flex';
                    return;
                }

                // Determine Access Level
                const isDeliveryOnly = document.getElementById('access-delivery-only').checked;
                const isAllAccess = document.getElementById('access-all').checked;

                if (!isDeliveryOnly && !isAllAccess) {
                    errorMessage.textContent = 'Please select an Access Level';
                    errorContainer.style.display = 'flex';
                    return;
                }

                const adminAccess = isDeliveryOnly ? 'delivery_only' : 'all';

                // Basic Validation
                if (password !== confirm) {
                    errorMessage.textContent = 'Passwords do not match';
                    errorContainer.style.display = 'flex';
                    return;
                }

                if (password.length < 8) {
                    errorMessage.textContent = 'Password must be at least 8 characters';
                    errorContainer.style.display = 'flex';
                    return;
                }

                if (!country) {
                    errorMessage.textContent = 'Please select a country';
                    errorContainer.style.display = 'flex';
                    return;
                }

                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating...';

                    const response = await fetch('../../backend/api/admin/create-admin.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name, email, phone, address, country, currency_code, currency_symbol, password,
                            admin_access: adminAccess
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast('Admin account created successfully!', 'success');
                        document.getElementById('add-admin-form').reset();
                        // Reset checkboxes
                        document.getElementById('access-all').checked = false;
                        document.getElementById('access-delivery-only').checked = false;
                        // Reset Country Display
                        const display = document.getElementById('new-admin-country-display');
                        display.textContent = 'Select Country';
                        display.style.color = '#94a3b8';
                        document.getElementById('new-admin-country').value = '';
                        document.getElementById('new-admin-currency-code').value = '';
                        document.getElementById('new-admin-currency-symbol').value = '';
                        switchView('overview');
                    } else {
                        errorMessage.textContent = result.message || 'Failed to create admin';
                        errorContainer.style.display = 'flex';
                    }
                } catch (error) {
                    console.error('Admin creation error:', error);
                    errorMessage.textContent = 'Connection error. Please try again.';
                    errorContainer.style.display = 'flex';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Admin Account';
                }
            }

            function toggleAdminStatus(adminId, action) {
                const isDestructive = action === 'block';
                const actionLabel = action === 'block' ? 'Disable' : 'Enable';

                showConfirmModal(
                    `Confirm ${actionLabel}`,
                    `Are you sure you want to ${actionLabel.toLowerCase()} this administrator?`,
                    isDestructive,
                    async () => {
                        try {
                            const response = await fetch('../../backend/api/admin/update-user-status.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ user_id: adminId, action: action })
                            });
                            const result = await response.json();
                            if (result.success) {
                                showToast(result.message, 'success');
                                loadAdmins(); // Refresh list
                            } else {
                                showToast(result.message, 'error');
                            }
                        } catch (error) {
                            console.error('Toggle status error:', error);
                            showToast('Connection failed', 'error');
                        }
                    }
                );
            }

            function deleteAdmin(adminId, email) {
                showConfirmModal(
                    'Delete Administrator',
                    `Are you sure you want to PERMANENTLY DELETE the administrator account for ${email}? This action cannot be undone.`,
                    true, // isDestructive
                    async () => {
                        try {
                            const response = await fetch('../../backend/api/admin/delete-admin.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ admin_id: adminId })
                            });
                            const result = await response.json();
                            if (result.success) {
                                showToast(result.message, 'success');
                                loadAdmins(); // Refresh list
                            } else {
                                showToast(result.message, 'error');
                            }
                        } catch (error) {
                            console.error('Delete admin error:', error);
                            showToast('Connection failed', 'error');
                        }
                    }
                );
            }

            async function loadTransactions() {
                const tbody = document.getElementById('transactions-table-body');
                tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center;">Loading transactions...</td></tr>';

                try {
                    const response = await fetch('../../backend/api/admin/get-all-orders.php');
                    const result = await response.json();

                    if (result.success) {
                        tbody.innerHTML = '';
                        if (!result.data || result.data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center;">No transactions found.</td></tr>';
                            return;
                        }

                        result.data.forEach(order => {
                            let statusColor = 'bg-stone-100 text-stone-600';
                            const s = (order.status || order.STATUS || '').trim().toLowerCase();
                            let displayStatus = s.toUpperCase() || 'ORDERED';
                            const p = (order.payment_status || order.PAYMENT_STATUS || '').toLowerCase();

                            // 1. Determine Color & Label Overrides
                            if (s === 'delivered') {
                                statusColor = 'bg-green-100 text-green-700';
                            } else if (s === 'cancelled' || s === 'cancel' || s === 'canceled') {
                                statusColor = 'bg-red-100 text-red-700';
                                displayStatus = 'CANCELLED';
                            } else if (s === 'rejected' || s === 'declined') {
                                statusColor = 'bg-red-100 text-red-700';
                                displayStatus = 'REJECTED';
                            } else if (s === 'shipped') {
                                statusColor = 'bg-blue-100 text-blue-700';
                            } else if (s === 'confirmed' || s === 'approved') {
                                statusColor = 'bg-cyan-100 text-cyan-700';
                                displayStatus = 'APPROVED';
                            } else if (s === 'processing') {
                                statusColor = 'bg-orange-100 text-orange-700';
                            } else if (s === 'pending') {
                                statusColor = 'bg-yellow-100 text-yellow-700';
                            }

                            // 2. Check Payment Status override (unless already shipped/delivered/cancelled/rejected/declined)
                            // Crucial Fix: Ensure SHIPPED always shows for Auctions if true, even if PAID.
                            if ((p === 'paid' || p === 'completed') &&
                                !['shipped', 'delivered', 'cancelled', 'cancel', 'canceled', 'rejected', 'declined'].includes(s)) {
                                statusColor = 'bg-teal-100 text-teal-700';
                                displayStatus = 'PAID';
                            }

                            // Explicitly force SHIPPED for auctions if status is shipped (Double check)
                            if (order.type === 'auction' && s === 'shipped') {
                                statusColor = 'bg-blue-100 text-blue-700';
                                displayStatus = 'SHIPPED';
                            }

                            // 3. Fix Image Path (uploads is in project root, so ../../uploads/...)
                            const imagePath = order.product_image ? `../../${order.product_image}` : 'https://placehold.co/100x100?text=No+Image';

                            // Badge Logic
                            let typeBadge = '';
                            let idPrefix = '';

                            if (order.type === 'auction') {
                                typeBadge = '<span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-purple-100 text-purple-700 uppercase border border-purple-200 mr-2">Auction</span>';
                                idPrefix = '<span class="text-stone-900 font-bold">AUC-' + String(order.id).padStart(5, '0') + '</span>';
                            } else {
                                typeBadge = '<span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600 uppercase border border-blue-100 mr-2">Order</span>';
                                idPrefix = '<span class="text-stone-900 font-bold">ORD-' + String(order.id).padStart(5, '0') + '</span>';
                            }

                            tbody.innerHTML += `
                            <tr style="border-bottom: 1px solid #f8fafc;">
                                <td style="padding: 16px; font-weight: 700; text-align: center;">${idPrefix}</td>
                                <td style="padding: 12px; text-align: center;">
                                    <div style="display: inline-flex; width: 240px; align-items: center; gap: 12px; justify-content: flex-start; text-align: left;">
                                        <img src="${imagePath}" style="width: 32px; height: 32px; border-radius: 4px; object-fit: cover; border:1px solid #f1f5f9; flex-shrink: 0;">
                                        <div style="min-width: 60px; display:flex; align-items:center;">${typeBadge}</div>
                                        <span style="font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;">${order.product_name}</span>
                                    </div>
                                </td>
                                <td style="padding: 16px; font-size: 13px; color: #57534e; text-align: center;">${order.customer_name}</td>
                                <td style="padding: 16px; font-size: 13px; color: #57534e; text-align: center;">${order.farmer_name}</td>
                                <td style="padding: 16px; font-weight: 700; text-align: center;">${CurrencyManager.formatFrom(order.total_price, 'INR')}</td>
                                <td style="padding: 16px; text-align: center;">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${statusColor}">${displayStatus}</span>
                                </td>
                            </tr>
                        `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center; color:red;">Failed: ' + result.message + '</td></tr>';
                    }
                } catch (error) {
                    console.error(error);
                    tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center; color:red;">Connection Error</td></tr>';
                }
            }

            async function loadAdminAuctions() {
                const tbody = document.getElementById('auctions-table-body');
                tbody.innerHTML = '<tr><td colspan="7" style="padding:20px; text-align:center;">Loading auctions...</td></tr>';

                try {
                    const response = await fetch('../../backend/api/admin/get-admin-auctions.php');
                    const result = await response.json();

                    if (result.success) {
                        tbody.innerHTML = '';
                        if (!result.data || result.data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" style="padding:20px; text-align:center;">No auctions found.</td></tr>';
                            return;
                        }

                        result.data.forEach(auction => {
                            // Status Logic
                            let statusColor = 'bg-stone-100 text-stone-600';
                            let displayStatus = (auction.status || '').toUpperCase();
                            const now = new Date();
                            const end = new Date(auction.end_time);

                            if (auction.status === 'active') {
                                if (now > end) {
                                    displayStatus = 'ENDING SOON'; // Or Process
                                    statusColor = 'bg-yellow-100 text-yellow-700';
                                } else {
                                    statusColor = 'bg-green-100 text-green-700';
                                }
                            } else if (auction.status === 'completed') {
                                displayStatus = 'WON';
                                statusColor = 'bg-blue-100 text-blue-700';
                                if (auction.payment_status === 'paid') {
                                    displayStatus = 'PAID';
                                    statusColor = 'bg-teal-100 text-teal-700';
                                }
                                if (auction.shipping_status === 'shipped') {
                                    displayStatus = 'SHIPPED';
                                    statusColor = 'bg-cyan-100 text-cyan-700';
                                }
                            } else if (auction.status === 'cancelled') {
                                statusColor = 'bg-red-100 text-red-700';
                            }

                            // Formatting
                            const imagePath = auction.image_url ? `../../${auction.image_url}` : 'https://placehold.co/100x100?text=No+Image';
                            const formattedId = '<span class="text-stone-900 font-bold">AUC-' + String(auction.id).padStart(5, '0') + '</span>';
                            const winnerDisplay = auction.winner_name ? `<div class="font-medium text-stone-900">${auction.winner_name}</div><div class="text-xs text-stone-400">${auction.winner_email || ''}</div>` : '<span class="text-stone-400 italic">No Winner</span>';

                            tbody.innerHTML += `
                            <tr style="border-bottom: 1px solid #f8fafc;">
                                <td style="padding: 16px; font-weight: 700; text-align: center;">${formattedId}</td>
                                <td style="padding: 12px; text-align: center;">
                                    <div style="display: inline-flex; align-items: center; gap: 12px; justify-content: flex-start;">
                                        <img src="${imagePath}" style="width: 32px; height: 32px; border-radius: 4px; object-fit: cover; border:1px solid #f1f5f9;">
                                        <span style="font-size: 14px; font-weight: 500;">${auction.product_name}</span>
                                    </div>
                                </td>
                                <td style="padding: 16px; font-size: 13px; color: #57534e; text-align: center;">${auction.farmer_name}</td>
                                <td style="padding: 16px; font-size: 13px; text-align: center;">${winnerDisplay}</td>
                                <td style="padding: 16px; font-weight: 700; text-align: center;">
                                    ${CurrencyManager.formatFrom(auction.current_bid, 'INR')}
                                    <div class="text-[10px] font-normal text-stone-400">${auction.bid_count} Bids</div>
                                </td>
                                <td style="padding: 16px; font-size: 12px; color: #57534e; text-align: center;">
                                    ${new Date(auction.end_time).toLocaleString()}
                                </td>
                                <td style="padding: 16px; text-align: center;">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${statusColor}">${displayStatus}</span>
                                </td>
                            </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" style="padding:20px; text-align:center; color:red;">' + result.message + '</td></tr>';
                    }
                } catch (error) {
                    console.error(error);
                    tbody.innerHTML = '<tr><td colspan="7" style="padding:20px; text-align:center; color:red;">Connection Error</td></tr>';
                }
            }

            // Init
            loadTransactions();
            loadAdminAuctions();
            loadAdminProfile();

            async function loadExports() {
                const tbody = document.getElementById('exports-table-body');
                tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center;">Loading exports...</td></tr>';

                try {
                    const response = await fetch('../../backend/api/admin/get-export-logs.php');
                    const result = await response.json();

                    if (result.success) {
                        tbody.innerHTML = '';
                        if (!result.data || result.data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center;">No export logs found.</td></tr>';
                            return;
                        }

                        result.data.forEach(log => {
                            let statusColor = 'bg-stone-100 text-stone-600';
                            if (log.status === 'delivered') statusColor = 'bg-green-100 text-green-700';
                            else if (log.status === 'shipped') statusColor = 'bg-blue-100 text-blue-700';
                            else if (log.status === 'customs') statusColor = 'bg-purple-100 text-purple-700';
                            else if (log.status === 'packaged') statusColor = 'bg-orange-100 text-orange-700';

                            tbody.innerHTML += `
                            <tr style="border-bottom: 1px solid #f8fafc;">
                                <td style="padding: 16px; font-weight: 700; text-align: center;">#${log.id}</td>
                                <td style="padding: 16px; font-weight: 600; color:#444; text-align: center;">${log.product_name}</td>
                                <td style="padding: 16px; font-size: 13px; color: #57534e; text-align: center;">${log.farmer_name}</td>
                                <td style="padding: 16px; font-size: 13px; font-weight:600; text-align: center;">${log.destination_country}</td>
                                <td style="padding: 16px; text-align: center;">${parseFloat(log.quantity)} ${log.unit}</td>
                                <td style="padding: 16px; text-align: center;">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${statusColor}">${log.status}</span>
                                </td>
                            </tr>
                        `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center; color:red;">Failed: ' + result.message + '</td></tr>';
                    }
                } catch (error) {
                    console.error(error);
                    tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center; color:red;">Connection Error</td></tr>';
                }
            }

            async function loadActivityLogs() {
                const tbody = document.getElementById('all-activity-table-body');
                tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center;">Loading activity logs...</td></tr>';

                try {
                    const response = await fetch('../../backend/api/admin/get-all-activity.php');
                    const result = await response.json();

                    if (result.success) {
                        tbody.innerHTML = '';
                        if (!result.data || result.data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center;">No activity found.</td></tr>';
                            return;
                        }

                        result.data.forEach(log => {
                            const date = new Date(log.timestamp).toLocaleString();
                            let typeColor = 'bg-gray-100 text-gray-600';
                            if (log.type === 'order') typeColor = 'bg-blue-50 text-blue-600';
                            if (log.type === 'product') typeColor = 'bg-orange-50 text-orange-600';
                            if (log.type === 'user') typeColor = 'bg-green-50 text-green-600';
                            if (log.type === 'review') typeColor = 'bg-purple-50 text-purple-600';

                            let typeStyle = '';
                            if (log.type === 'auction') {
                                typeColor = '';
                                typeStyle = 'background-color: #fce7f3; color: #be185d;'; // Pink-100/700
                            }
                            if (log.type === 'bid') {
                                typeColor = '';
                                typeStyle = 'background-color: #e0e7ff; color: #4338ca;'; // Indigo-100/700
                            }

                            tbody.innerHTML += `
                            <tr style="border-bottom: 1px solid #f8fafc;">
                                <td style="padding: 16px; font-size: 13px; color: #64748b; text-align: center;">${date}</td>
                                <td style="padding: 16px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 13px;">${log.user_name}</div>
                                    <div style="font-size: 11px; color: #94a3b8; text-transform:uppercase;">${log.user_role.replace(/_/g, ' ')}</div>
                                </td>
                                <td style="padding: 16px; text-align: center;">
                                    <div style="font-size: 13px; font-weight: 600; color: #1f2937;">${log.action.replace(/_/g, ' ')}</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                        ${log.details
                                    .replace(/@\s*(\d+(\.\d+)?)\s*\//, (match, price) => `@ ${CurrencyManager.formatFrom(price, 'INR')}/`)
                                    .replace(/Starting Price:\s*(\d+(\.\d+)?)/, (match, price) => `Starting Price: ${CurrencyManager.formatFrom(price, 'INR')}`)
                                    .replace(/Winning Bid:\s*(\d+(\.\d+)?)/, (match, price) => `Winning Bid: ${CurrencyManager.formatFrom(price, 'INR')}`)
                                    .replace(/Bid\s*(\d+(\.\d+)?)\s*on/, (match, price) => `Bid ${CurrencyManager.formatFrom(price, 'INR')} on`)
                                }
                                    </div>
                                </td>
                                <td style="padding: 16px; text-align: center;">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${typeColor}" style="${typeStyle}">${log.type}</span>
                                </td>
                            </tr>
                                `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center; color:red;">Failed: ' + result.message + '</td></tr>';
                    }
                } catch (error) {
                    console.error(error);
                    tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center; color:red;">Connection Error</td></tr>';
                }
            }

            let globalUsers = [];

            function updateUserStats(users) {
                const total = users.length;
                const customers = users.filter(u => u.role === 'customer').length;
                const farmers = users.filter(u => u.role === 'farmer').length;
                const agents = users.filter(u => u.role === 'delivery_agent').length;

                document.getElementById('stat-total-users').textContent = total;
                document.getElementById('stat-total-customers').textContent = customers;
                document.getElementById('stat-total-farmers').textContent = farmers;
                document.getElementById('stat-total-agents').textContent = agents;
            }

            async function loadUsers() {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center;">Loading users...</td></tr>';

                try {
                    const response = await fetch('../../backend/api/admin/get-users.php');
                    const result = await response.json();

                    if (result.success) {
                        globalUsers = result.users;
                        renderUsers(globalUsers);
                        updateUserStats(globalUsers);
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center; color:red;">Failed: ' + result.message + '</td></tr>';
                    }
                } catch (error) {
                    console.error("Error loading users:", error);
                    tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center; color:red;">Connection Error</td></tr>';
                }
            }

            function validatePhoneInput(input) {
                // 1. Remove invalid characters (only allow 0-9 and +)
                let value = input.value.replace(/[^0-9+]/g, '');

                // 2. Ensure + is only at the start
                value = value.replace(/(?!^)\+/g, '');

                // 3. Count digits and enforce max 15 digits
                const digits = value.replace(/[^0-9]/g, '');
                if (digits.length > 15) {
                    // Truncate to keep only first 15 digits (preserving + if present)
                    // If it starts with +, max length is 16. If not, max length is 15.
                    const maxLen = value.startsWith('+') ? 16 : 15;
                    value = value.slice(0, maxLen);
                }

                input.value = value;
            }

            function openCountrySelectorForProfile() {
                CountrySelector.onSelectCallback = (country) => {
                    document.getElementById('profile-country').value = country.name;
                    document.getElementById('profile-currency-code').value = country.currency_code;
                    document.getElementById('profile-currency-symbol').value = country.currency_symbol;
                    document.getElementById('admin-country-display').innerHTML = `${country.name} (${country.currency_symbol} ${country.currency_code})`;
                };
                CountrySelector.show();
            }

            function openCountrySelectorForAgent() {
                CountrySelector.onSelectCallback = (country) => {
                    document.getElementById('agent-country').value = country.name;
                    document.getElementById('agent-currency-code').value = country.currency_code;
                    document.getElementById('agent-currency-symbol').value = country.currency_symbol;

                    const display = document.getElementById('agent-country-display');
                    display.textContent = `${country.name} (${country.currency_symbol} ${country.currency_code})`;
                    display.classList.remove('text-stone-400');
                    display.classList.add('text-stone-900');
                };
                CountrySelector.show();
            }

            function openCountrySelectorForNewAdmin() {
                CountrySelector.onSelectCallback = (country) => {
                    document.getElementById('new-admin-country').value = country.name;
                    document.getElementById('new-admin-currency-code').value = country.currency_code;
                    document.getElementById('new-admin-currency-symbol').value = country.currency_symbol;

                    const display = document.getElementById('new-admin-country-display');
                    display.textContent = `${country.name} (${country.currency_symbol} ${country.currency_code})`;
                    display.style.color = '#1e293b';
                };
                CountrySelector.show();
            }

            function openAddAgentModal() {
                document.getElementById('add-agent-modal').style.display = 'flex';
                document.getElementById('add-agent-form').reset();
                document.getElementById('agent-form-error').classList.add('hidden');

                // Reset Country Display
                const display = document.getElementById('agent-country-display');
                display.textContent = 'Select Country';
                display.classList.add('text-stone-400');
                display.classList.remove('text-stone-900');
                document.getElementById('agent-country').value = '';
                document.getElementById('agent-currency-code').value = '';
                document.getElementById('agent-currency-symbol').value = '';
            }

            function closeAddAgentModal() {
                document.getElementById('add-agent-modal').style.display = 'none';
            }

            async function submitAgentForm() {
                const name = document.getElementById('agent-name').value;
                const email = document.getElementById('agent-email').value;
                const phone = document.getElementById('agent-phone').value;
                const password = document.getElementById('agent-password').value;
                const confirmPassword = document.getElementById('agent-confirm-password').value;
                const address = document.getElementById('agent-address').value;

                const country = document.getElementById('agent-country').value;
                const currency_code = document.getElementById('agent-currency-code').value;
                const currency_symbol = document.getElementById('agent-currency-symbol').value;

                const errorDiv = document.getElementById('agent-form-error');
                const errorMsg = document.getElementById('agent-form-error-msg');

                // Validate Fill All Fields
                if (!name || !email || !phone || !password || !confirmPassword || !address || !country) {
                    errorMsg.textContent = 'Please fill in all fields.';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // Reset Error State
                errorDiv.classList.add('hidden');
                errorMsg.textContent = '';

                // 1. Required Fields Check
                if (!name.trim()) {
                    errorMsg.textContent = "Full Name is required";
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!email.trim()) {
                    errorMsg.textContent = "Email is required";
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!phone.trim()) {
                    errorMsg.textContent = "Phone number is required";
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!country) {
                    errorMsg.textContent = "Please select a country";
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (!address.trim()) {
                    errorMsg.textContent = "Address is required";
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // 2. Email Validation (Strict)
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (!emailRegex.test(email)) {
                    errorMsg.textContent = "Please enter a valid email address";
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // 3. Phone Validation (Strict: + optional at start, digits only)
                const phoneRegex = /^\+?[0-9]{10,15}$/;
                if (!phoneRegex.test(phone)) {
                    errorMsg.textContent = "Phone format invalid. Allowed: + at start, 10-15 digits.";
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // 4. Password Validation
                if (password.length < 8) {
                    errorMsg.textContent = "Password must be at least 8 characters";
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (password !== confirmPassword) {
                    errorMsg.textContent = "Passwords do not match";
                    errorDiv.classList.remove('hidden');
                    return;
                }

                try {
                    const response = await fetch('../../backend/api/admin/create-delivery-agent.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            email,
                            phone,
                            password,
                            address,
                            country,
                            currency_code,
                            currency_symbol
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast('Delivery Agent created successfully!', 'success');
                        closeAddAgentModal();

                        // Force Refresh Lists
                        if (typeof loadUsers === 'function') loadUsers();
                        if (typeof loadAllDeliveryAgents === 'function') loadAllDeliveryAgents();

                    } else {
                        errorMsg.textContent = result.message || "Failed to create agent";
                        errorDiv.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error creating agent:', error);
                    errorMsg.textContent = "Connection error. Please try again.";
                    errorDiv.classList.remove('hidden');
                }
            }

            async function loadDeliveryOrders() {
                const tbody = document.getElementById('delivery-table-body');
                tbody.innerHTML = '<tr><td colspan="6" style="padding:40px; text-align:center;"><img src="https://api.iconify.design/lucide:loader-2.svg" class="w-8 h-8 animate-spin mx-auto text-orange-500"><p class="text-stone-400 text-sm mt-2">Loading deliveries...</p></td></tr>';

                try {
                    const response = await fetch('../../backend/api/admin/get-delivery-orders.php');
                    const result = await response.json();

                    if (result.success) {
                        const items = result.data;
                        if (items.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" style="padding:40px; text-align:center;"><p class="text-stone-400 text-sm">No active deliveries found.</p></td></tr>';
                            return;
                        }

                        tbody.innerHTML = '';
                        items.forEach(item => {
                            let statusColor = 'bg-stone-100 text-stone-600';
                            if (item.status === 'shipped') statusColor = 'bg-blue-100 text-blue-700';
                            if (item.status === 'delivered') statusColor = 'bg-green-100 text-green-700';

                            let typeBadgeColor = item.type === 'auction' ? 'bg-pink-100 text-pink-700' : 'bg-indigo-100 text-indigo-700';

                            let idPrefix = '';
                            if (item.type === 'auction') {
                                idPrefix = 'AUC-' + String(item.id).padStart(5, '0');
                            } else {
                                idPrefix = 'ORD-' + String(item.id).padStart(5, '0');
                            }

                            tbody.innerHTML += `
                            <tr style="border-bottom: 1px solid #f1f5f9; hover:bg-stone-50;">
                                    <td style="padding: 16px; font-size: 14px; font-weight: 700; color: #1e293b; text-align: center; white-space: nowrap;">${idPrefix}</td>
                                    <td style="padding: 16px; text-align: center;">
                                        <div style="display: flex; align-items: center; width: 100%;">
                                            <div style="flex: 0 0 42%; display: flex; justify-content: flex-end; padding-right: 12px;">
                                                <img src="${item.product_image ? '../../' + item.product_image : 'https://api.iconify.design/lucide:package.svg'}" 
                                                     style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                            </div>
                                            <div style="flex: 0 0 58%; display: flex; justify-content: flex-start; text-align: left;">
                                                <div style="font-size: 13px; font-weight: 700; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">${item.product_name || 'Unknown Product'}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 16px; text-align: center;">
                                        <div style="font-size: 14px; font-weight: 600; color: #1e293b;">${item.customer_name}</div>
                                        <div style="font-size: 12px; color: #64748b;">${item.customer_phone || 'No Phone'}</div>
                                    </td>
                                    <td style="padding: 16px; font-size: 13px; color: #64748b; max-width: 250px; text-align: center;">
                                        ${item.delivery_address ? item.delivery_address.replace(/Contact:.*/, '') : 'No Address'}
                                    </td>
                                    <td style="padding: 16px; text-align: center;">
                                        ${item.delivery_agent_id ?
                                    `<div class="flex flex-col items-center">
                                                <span class="text-sm font-bold text-stone-700">${item.agent_name || 'Assigned'}</span>
                                                <button onclick="openAssignModal(${item.id}, '${item.type}')" class="text-[10px] text-orange-500 font-bold hover:underline mt-1">Reassign</button>
                                            </div>` :
                                    `<button onclick="openAssignModal(${item.id}, '${item.type}')" class="px-3 py-1.5 bg-stone-900 text-white text-xs font-bold rounded-lg hover:bg-black shadow-lg shadow-stone-900/10 transition-all">Assign Agent</button>`
                                }
                                    </td>
                                    <td style="padding: 16px; text-align: center;">
                                        <span class="px-2 py-1 rounded-md text-xs font-bold uppercase ${statusColor}">${item.status}</span>
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = `<tr><td colspan="6" style="padding:40px; text-align:center; color:red;">Error: ${result.message}</td></tr>`;
                    }
                } catch (error) {
                    console.error('Error loading deliveries:', error);
                    tbody.innerHTML = '<tr><td colspan="6" style="padding:40px; text-align:center; color:red;">Connection Failed</td></tr>';
                }
            }

            function filterUsers() {
                const input = document.getElementById('user-search-input').value.toLowerCase();
                const filtered = globalUsers.filter(user =>
                    user.full_name.toLowerCase().startsWith(input)
                );
                renderUsers(filtered);
            }

            function renderUsers(users) {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center; color: #94a3b8;">No users found.</td></tr>';
                    return;
                }

                users.forEach(user => {
                    let roleColor = '#3b82f6';
                    if (user.role === 'farmer') roleColor = '#22c55e';
                    else if (user.role === 'admin') roleColor = '#ff0000';
                    else if (user.role === 'delivery_agent') roleColor = '#f97316'; // Orange

                    const isActive = user.is_active == 1;

                    // safely stringify the user object for the View button
                    const userString = JSON.stringify(user).replace(/"/g, '&quot;');

                    const initials = user.full_name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    const profileImageUrl = user.profile_image ? `../../${user.profile_image}` : null;

                    tbody.innerHTML += `
                            <tr style="border-bottom: 1px solid #f8fafc; hover:background:#f1f5f9;">
                            <td style="padding: 16px;">
                                <div style="display: flex; align-items: center; gap: 12px; width: 240px; margin: 0 auto;">
                                    ${profileImageUrl ?
                            `<img src="${profileImageUrl}" alt="${user.full_name}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover; border: 2px solid #e2e8f0;">` :
                            `<div style="width: 40px; height: 40px; background: ${roleColor}; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px;">${initials}</div>`
                        }
                                    <div>
                                        <div style="font-weight:600;">${user.full_name}</div>
                                        <div style="font-size:12px; color:#64748b;">${user.email}</div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                <span style="color:${roleColor}; font-weight:600; text-transform:uppercase; font-size:12px;">${user.role.replace('_', ' ')}</span>
                            </td>
                            <td style="padding: 16px; color:#64748b; font-size:13px; text-align: center;">${new Date(user.created_at).toLocaleDateString()}</td>
                            <td style="padding: 16px;">
                                <div class="flex gap-2" style="justify-content: center;">
                                    <button onclick="viewUser(${userString})" style="background:#eff6ff; color:#3b82f6; border:none; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:700; cursor:pointer;">View</button>
                                    
                                    ${isSuperAdmin ? (isActive ?
                            `<button onclick="updateUserStatus(${user.id}, 'block')" style="background:#fef2f2; color:#ef4444; border:none; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:700; cursor:pointer;">Block</button>` :
                            `<button onclick="updateUserStatus(${user.id}, 'unblock')" style="background:#f0fdf4; color:#22c55e; border:none; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:700; cursor:pointer;">Unblock</button>`) : ''
                        }
                                </div>                            </td>
                        </tr>
                            `;
                });
            }



            function closeConfirmModal() {
                document.getElementById('confirmation-modal').style.display = 'none';
            }

            function showConfirmModal(title, message, isDestructive, onConfirm) {
                const modal = document.getElementById('confirmation-modal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-action-btn');
                const iconContainer = document.getElementById('confirm-icon-container');
                const icon = document.getElementById('confirm-icon');

                titleEl.textContent = title;
                messageEl.textContent = message;

                if (isDestructive) {
                    iconContainer.className = "w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4";
                    icon.src = "https://api.iconify.design/lucide:alert-triangle.svg?color=%23ef4444";
                    confirmBtn.className = "px-4 py-2 rounded-lg bg-red-500 text-white font-bold text-sm hover:bg-red-600 transition-colors shadow-lg shadow-red-500/30";
                } else {
                    iconContainer.className = "w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4";
                    icon.src = "https://api.iconify.design/lucide:check-circle.svg?color=%2322c55e";
                    confirmBtn.className = "px-4 py-2 rounded-lg bg-green-500 text-white font-bold text-sm hover:bg-green-600 transition-colors shadow-lg shadow-green-500/30";
                }

                confirmBtn.onclick = () => {
                    onConfirm();
                    closeConfirmModal();
                };

                modal.style.display = 'flex';
            }

            async function updateUserStatus(userId, action) {
                const isBlock = action === 'block';

                showConfirmModal(
                    isBlock ? 'Block User?' : 'Unblock User?',
                    isBlock ? 'Are you sure you want to block this user? They will not be able to log in.' : 'Are you sure you want to unblock this user? Access will be restored.',
                    isBlock, // true = destructive (red), false = safe (green)
                    async () => {
                        try {
                            const response = await fetch('../../backend/api/admin/update-user-status.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ user_id: userId, action: action })
                            });
                            const result = await response.json();

                            if (result.success) {
                                loadUsers(); // Reload table
                            } else {
                                showToast('Error: ' + result.message, 'error');
                            }
                        } catch (error) {
                            showToast('Connection failed', 'error');
                        }
                    }
                );
            }

            async function viewUser(user) {
                document.getElementById('modal-user-name').textContent = user.full_name;
                document.getElementById('modal-user-email').textContent = user.email;
                document.getElementById('modal-user-phone').textContent = user.phone || 'N/A';
                document.getElementById('modal-user-address').textContent = user.address || 'N/A';
                document.getElementById('modal-user-role').textContent = user.role.replace(/_/g, ' ').toUpperCase();
                document.getElementById('modal-user-joined').textContent = new Date(user.created_at).toLocaleString();

                // Set Country/Currency
                const userLangCountry = user.country || 'N/A';
                const userCurrency = user.currency_code ? `${user.currency_code} ` : '';
                document.getElementById('modal-user-country-currency').textContent = userCurrency ? `${userLangCountry} (${userCurrency})` : userLangCountry;

                document.getElementById('modal-user-avatar').textContent = user.full_name.charAt(0);

                // Re-use logic for status badge in modal
                const isVerified = user.is_verified == 1;
                let badge = '';
                if (user.is_active == 0) badge = '<span class="px-2 py-1 bg-red-100 text-red-600 rounded-md text-xs font-bold">BLOCKED</span>';
                else badge = '';

                document.getElementById('modal-user-status').innerHTML = badge;

                const statsContainer = document.getElementById('modal-user-stats-container');
                statsContainer.innerHTML = '<p class="text-center text-sm text-stone-500 py-4">Loading history...</p>';

                document.getElementById('user-modal').classList.remove('hidden');

                try {
                    // Parallel fetch: Stats + Activity Logs
                    const [statsRes, logsRes] = await Promise.all([
                        fetch(`../../backend/api/admin/get-user-history.php?id=${user.id}&role=${user.role}`),
                        fetch(`../../backend/api/admin/get-user-activity-logs.php?user_id=${user.id}`)
                    ]);

                    const statsResult = await statsRes.json();
                    const logsResult = await logsRes.json();

                    if (statsResult.success && statsResult.data) {
                        const data = statsResult.data;
                        let html = '';

                        // Render Stats Cards (Same as before)
                        if (user.role === 'farmer') {
                            html += `
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <p class="text-[10px] text-stone-500 uppercase font-bold">Total Earnings</p>
                                    <p class="text-lg font-bold text-green-700">${CurrencyManager.formatFrom(data.total_earnings, 'INR')}</p>
                                </div>
                                <div class="p-3 bg-orange-50 rounded-lg">
                                    <p class="text-[10px] text-stone-500 uppercase font-bold">Products Listed</p>
                                    <p class="text-lg font-bold text-orange-700">${data.total_products}</p>
                                </div>
                            </div>
                            `;
                        } else {
                            html += `
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="p-3 bg-blue-50 rounded-lg">
                                    <p class="text-[10px] text-stone-500 uppercase font-bold">Total Spent</p>
                                    <p class="text-lg font-bold text-blue-700">${CurrencyManager.formatFrom(data.total_spending, 'INR')}</p>
                                </div>
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <p class="text-[10px] text-stone-500 uppercase font-bold">Total Orders</p>
                                    <p class="text-lg font-bold text-purple-700">${data.total_orders}</p>
                                </div>
                            </div>
                            `;
                        }

                        // Render Activity Logs (Granular)
                        html += `<h4 class="text-sm font-bold text-stone-900 mb-2">Recent Activity</h4>`;

                        if (logsResult.success && logsResult.data && logsResult.data.length > 0) {
                            html += `
                            <div class="overflow-y-auto max-h-40 border rounded-lg border-stone-100">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-stone-50 sticky top-0">
                                        <tr>
                                            <th class="p-2 text-[10px] font-bold text-stone-500">Time</th>
                                            <th class="p-2 text-[10px] font-bold text-stone-500">Action</th>
                                            <th class="p-2 text-[10px] font-bold text-stone-500">Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        `;

                            logsResult.data.forEach(log => {
                                const date = new Date(log.timestamp).toLocaleString();
                                let typeColor = 'bg-gray-100 text-gray-600';
                                let typeStyle = '';

                                if (log.type === 'order') typeColor = 'bg-blue-50 text-blue-600';
                                if (log.type === 'product') typeColor = 'bg-orange-50 text-orange-600';
                                if (log.type === 'user') typeColor = 'bg-green-50 text-green-600';
                                if (log.type === 'review') typeColor = 'bg-purple-50 text-purple-600';

                                if (log.type === 'auction') {
                                    typeColor = '';
                                    typeStyle = 'background-color: #fce7f3; color: #be185d;';
                                }
                                if (log.type === 'bid') {
                                    typeColor = '';
                                    typeStyle = 'background-color: #e0e7ff; color: #4338ca;';
                                }

                                html += `
                                        <tr class="border-b border-stone-50">
                                            <td class="p-2 text-[10px] text-stone-500 whitespace-nowrap">${date}</td>
                                            <td class="p-2">
                                                <div class="text-xs font-bold text-stone-700">${log.action}</div>
                                                <div class="text-[10px] text-stone-500 truncate max-w-[150px]">
                                                    ${log.details
                                        .replace(/@\s*(\d+(\.\d+)?)\s*\//, (match, price) => `@ ${CurrencyManager.formatFrom(price, 'INR')}/`)
                                        .replace(/Starting Price:\s*(\d+(\.\d+)?)/, (match, price) => `Starting Price: ${CurrencyManager.formatFrom(price, 'INR')}`)
                                        .replace(/Winning Bid:\s*(\d+(\.\d+)?)/, (match, price) => `Winning Bid: ${CurrencyManager.formatFrom(price, 'INR')}`)
                                        .replace(/Bid\s*(\d+(\.\d+)?)\s*on/, (match, price) => `Bid ${CurrencyManager.formatFrom(price, 'INR')} on`)
                                    }
                                                </div>
                                            </td>
                                            <td class="p-2 text-center">
                                                <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase ${typeColor}" style="${typeStyle}">${log.type}</span>
                                            </td>
                                        </tr>
                                        `;
                            });
                            html += `</tbody></table></div>`;
                        } else {
                            html += `<p class="text-xs text-stone-500 italic">No recent activity found.</p>`;
                        }

                        statsContainer.innerHTML = html;
                    } else {
                        statsContainer.innerHTML = '<p class="text-red-500 text-xs text-center">Failed to load stats.</p>';
                    }
                } catch (err) {
                    console.error(err);
                    statsContainer.innerHTML = '<p class="text-red-500 text-xs text-center">Connection error.</p>';
                }
            }

            function closeUserModal() {
                document.getElementById('user-modal').classList.add('hidden');
            }

            // Check Admin Auth (Simple client-side check, real protection is on backend)
            // In a real app, we'd check a session token or cookie.


            // Toast Notification System
            function showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;

                const icon = type === 'success' ? 'lucide:check-circle' : (type === 'error' ? 'lucide:alert-circle' : 'lucide:alert-triangle');
                const iconColor = type === 'success' ? '%2316a34a' : (type === 'error' ? '%23dc2626' : '%23ca8a04');

                toast.innerHTML = `
                    <div class="toast-icon">
                        <img src="https://api.iconify.design/${icon}.svg?color=${iconColor}" width="20">
                    </div>
                    <div class="toast-message">${message}</div>
                    <div class="toast-progress" style="animation: progress 3s linear forwards;"></div>
                `;

                container.appendChild(toast);

                // Force reflow for transform animation
                setTimeout(() => toast.classList.add('show'), 10);

                // Remove after 3s
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 400);
                }, 3000);
            }

            async function loadAdminStats(period = '12_months') {
                const activityList = document.getElementById('activity-list');
                const totalUsersEl = document.getElementById('total-users');
                const totalRevenueEl = document.getElementById('total-revenue');
                const activeOrdersEl = document.getElementById('active-orders');

                try {
                    console.log('Fetching admin stats...');
                    const url = `../../backend/api/analytics/get-admin-stats.php?period=${period}`;
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} `);
                    }

                    const result = await response.json();
                    console.log('Admin stats result:', result);

                    if (result.success) {
                        // 1. Update Top Cards
                        const stats = result.stats || {};

                        if (totalUsersEl) totalUsersEl.innerText = (stats.total_users || 0).toLocaleString();
                        if (totalRevenueEl) {
                            // Backend sends data in INR (Base Currency), so we convert FROM INR to User Pref
                            totalRevenueEl.innerText = CurrencyManager.formatFrom(stats.revenue || 0, 'INR');
                            // Also hide the separate currency symbol span since format() includes it
                            const symbolParams = totalRevenueEl.parentElement.querySelector('.currency-symbol');
                            if (symbolParams) symbolParams.style.display = 'none';
                        }
                        if (activeOrdersEl) activeOrdersEl.innerText = (stats.active_orders || 0).toLocaleString();

                        // 2. Top Farmers
                        const topFarmersList = document.getElementById('top-farmers-list');
                        if (topFarmersList) {
                            topFarmersList.innerHTML = '';
                            if (result.top_farmers && result.top_farmers.length > 0) {
                                result.top_farmers.forEach(farmer => {
                                    topFarmersList.innerHTML += `
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="width: 32px; height: 32px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #94a3b8; font-size: 12px;">
                                            ${farmer.full_name.charAt(0)}
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 13px; font-weight: 700; color: white;">${farmer.full_name}</div>
                                            <div style="font-size: 11px; color: #64748b;">${CurrencyManager.formatFrom(farmer.total_sales, 'INR')} Sales</div>
                                        </div>
                                    </div>
                                    `;
                                });
                            } else {
                                topFarmersList.innerHTML = '<div style="font-size: 12px; color: #64748b;">No sales data yet.</div>';
                            }
                        }

                        // 3. Recent Registrations
                        const recentRegList = document.getElementById('recent-registrations-list');
                        if (recentRegList) {
                            recentRegList.innerHTML = '';
                            if (result.recent_registrations && result.recent_registrations.length > 0) {
                                result.recent_registrations.forEach(user => {
                                    const roleColor = user.role === 'farmer' ? '#22c55e' : '#3b82f6';
                                    const timeAgo = new Date(user.created_at).toLocaleDateString();

                                    recentRegList.innerHTML += `
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 6px; height: 6px; border-radius: 50%; background: ${roleColor};"></div>
                                            <span style="font-size: 12px; font-weight: 500; color: #cbd5e1;">${user.full_name} <span style="color: #64748b; font-size: 10px; margin-left: 4px;">${user.role.replace(/_/g, ' ').toUpperCase()}</span></span>
                                        </div>
                                        <span style="font-size: 10px; color: #64748b;">${timeAgo}</span>
                                    </div>
                                    `;
                                });
                            } else {
                                recentRegList.innerHTML = '<div style="font-size: 12px; color: #64748b;">No recent users.</div>';
                            }
                        }

                        if (result.sales_chart) {
                            renderSalesChart(result.sales_chart.labels, result.sales_chart.data);
                        }

                        // 4. Render Recent Activity
                        if (activityList) {
                            activityList.innerHTML = '';

                            if (result.recent_activity && result.recent_activity.length > 0) {
                                result.recent_activity.forEach(log => {
                                    const date = new Date(log.timestamp).toLocaleString();
                                    let typeColor = 'bg-gray-100 text-gray-600';
                                    let typeStyle = ''; // Add explicit style string

                                    if (log.type === 'order') typeColor = 'bg-blue-50 text-blue-600';
                                    if (log.type === 'product') typeColor = 'bg-orange-50 text-orange-600';
                                    if (log.type === 'user') typeColor = 'bg-green-50 text-green-600';
                                    if (log.type === 'review') typeColor = 'bg-purple-50 text-purple-600';

                                    // Force styles for new types
                                    if (log.type === 'auction') {
                                        typeColor = '';
                                        typeStyle = 'background-color: #fce7f3; color: #be185d;'; // Pink-100/700
                                    }
                                    if (log.type === 'bid') {
                                        typeColor = '';
                                        typeStyle = 'background-color: #e0e7ff; color: #4338ca;'; // Indigo-100/700
                                    }

                                    activityList.innerHTML += `
                                    <tr style="border-bottom: 1px solid #f8fafc;">
                                        <td style="padding: 16px; font-size: 13px; color: #64748b; text-align: center;">${date}</td>
                                        <td style="padding: 16px; text-align: center;">
                                            <div style="font-weight: 600; font-size: 13px;">${log.user_name}</div>
                                            <div style="font-size: 11px; color: #94a3b8; text-transform:uppercase;">${log.user_role.replace(/_/g, ' ')}</div>
                                        </td>
                                        <td style="padding: 16px; text-align: center;">
                                            <div style="font-size: 13px; font-weight: 600; color: #1f2937;">${log.action.replace(/_/g, ' ')}</div>
                                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                                ${log.details
                                            .replace(/@\s*(\d+(\.\d+)?)\s*\//, (match, price) => `@ ${CurrencyManager.formatFrom(price, 'INR')}/`)
                                            .replace(/Starting Price:\s*(\d+(\.\d+)?)/, (match, price) => `Starting Price: ${CurrencyManager.formatFrom(price, 'INR')}`)
                                            .replace(/Winning Bid:\s*(\d+(\.\d+)?)/, (match, price) => `Winning Bid: ${CurrencyManager.formatFrom(price, 'INR')}`)
                                            .replace(/Bid\s*(\d+(\.\d+)?)\s*on/, (match, price) => `Bid ${CurrencyManager.formatFrom(price, 'INR')} on`)
                                        }
                                            </div>
                                        </td>
                                        <td style="padding: 16px; text-align: center;">
                                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${typeColor}" style="${typeStyle}">${log.type}</span>
                                        </td>
                                    </tr>
                                    `;
                                });
                            } else {
                                activityList.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #94a3b8;">No recent activity found.</td></tr>';
                            }
                        }

                    } else {
                        console.error('Failed to load stats:', result.message);
                        if (activityList) activityList.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px; color: red;">Failed: ${result.message}</td></tr>`;
                    }
                } catch (error) {
                    console.error('Connection error:', error);
                    if (activityList) activityList.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px; color: red;">Error: ${error.message}</td></tr>`;
                }
            }

            let salesChart;

            function renderSalesChart(labels, data) {
                const ctx = document.getElementById('salesChart').getContext('2d');

                if (salesChart) {
                    salesChart.destroy();
                }

                salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.length > 0 ? labels : ['No Data'],
                        datasets: [{
                            label: 'Revenue (' + CurrencyManager.getSymbol() + ')',
                            data: data.length > 0 ? data.map(val => CurrencyManager.snap(CurrencyManager.convert(val, 'INR', CurrencyManager.getCode()))) : [0],
                            borderColor: '#ff7e21',
                            backgroundColor: 'rgba(255, 126, 33, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => 'Revenue: ' + CurrencyManager.getSymbol() + CurrencyManager.snap(context.parsed.y).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 })
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#f1f5f9' },
                                ticks: {
                                    callback: function (value) {
                                        const symbol = CurrencyManager.getSymbol();
                                        if (value >= 1000000) return symbol + (value / 1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return symbol + (value / 1000).toFixed(0) + 'k';
                                        return symbol + CurrencyManager.snap(value).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                                    }
                                }
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            let analysisCharts = {};

            async function loadAnalysisData() {
                try {
                    const response = await fetch('../../backend/api/admin/get-admin-analytics.php');
                    const result = await response.json();

                    if (result.success) {
                        renderAnalysisCharts(result.data);
                    } else {
                        console.error('Failed to load analysis data:', result.message);
                    }
                } catch (error) {
                    console.error('Error in analysis fetch:', error);
                }
            }

            function renderAnalysisCharts(data) {
                const colors = ['#3b82f6', '#ff7e21', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#475569'];

                // Common legend config for dot style and no filtering
                const dotLegendConfig = {
                    onClick: (e) => e.stopPropagation(),
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 20,
                        color: '#444',
                        font: { size: 12, weight: '600' }
                    }
                };

                // 1. User Growth Chart
                if (analysisCharts.growth) analysisCharts.growth.destroy();
                const growthCtx = document.getElementById('growthTrendChart').getContext('2d');
                const dates = [];
                for (let i = 29; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    dates.push(d.toISOString().split('T')[0]);
                }
                let customerTotal = 0, farmerTotal = 0;
                const customers = dates.map(d => {
                    const found = data.user_growth.find(i => i.date === d && i.role === 'customer');
                    customerTotal += found ? parseInt(found.count) : 0;
                    return customerTotal;
                });
                const farmers = dates.map(d => {
                    const found = data.user_growth.find(i => i.date === d && i.role === 'farmer');
                    farmerTotal += found ? parseInt(found.count) : 0;
                    return farmerTotal;
                });

                analysisCharts.growth = new Chart(growthCtx, {
                    type: 'line',
                    data: {
                        labels: dates.map(d => new Date(d).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })),
                        datasets: [
                            { label: 'Customers', data: customers, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3 },
                            { label: 'Farmers', data: farmers, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: dotLegendConfig, tooltip: { mode: 'index', intersect: false } },
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { ticks: { autoSkip: true, maxRotation: 0 } } }
                    }
                });

                // 2. Order Funnel
                if (analysisCharts.funnel) analysisCharts.funnel.destroy();
                const funnelCtx = document.getElementById('orderFunnelChart').getContext('2d');
                analysisCharts.funnel = new Chart(funnelCtx, {
                    type: 'doughnut',
                    data: {
                        labels: data.order_status.map(i => {
                            const statusMap = {
                                'ordered': 'New Orders',
                                'pending': 'Place Orders',
                                'confirmed': 'Confirmed',
                                'paid': 'Payment Confirmed',
                                'processing': 'Processing',
                                'shipped': 'Shipped',
                                'delivered': 'Completed',
                                'cancelled': 'Cancelled',
                                'rejected': 'Rejected'
                            };
                            const statusKey = window.normalizeStatus(i.status || i.STATUS);
                            const displayStatus = statusMap[statusKey] || statusKey.charAt(0).toUpperCase() + statusKey.slice(1);
                            return `${displayStatus} (${i.count || i.COUNT || 0})`;
                        }),
                        datasets: [{
                            data: data.order_status.map(i => i.count || i.COUNT || 0),
                            backgroundColor: colors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { ...dotLegendConfig, position: 'bottom' } }
                    }
                });

                // 3. Farmer Leaderboard
                if (analysisCharts.leaderboard) analysisCharts.leaderboard.destroy();
                const leadCtx = document.getElementById('farmerLeaderboardChart').getContext('2d');
                analysisCharts.leaderboard = new Chart(leadCtx, {
                    type: 'bar',
                    data: {
                        labels: data.farmer_leaderboard.map(i => i.farmer_name),
                        datasets: [{
                            label: 'Revenue',
                            data: data.farmer_leaderboard.map(i => CurrencyManager.snap(CurrencyManager.convert(i.total_revenue, 'INR', CurrencyManager.getCode()))),
                            backgroundColor: '#ff7e21',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => 'Revenue: ' + CurrencyManager.getSymbol() + CurrencyManager.snap(context.parsed.x).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 })
                                }
                            }
                        },
                        scales: { x: { ticks: { callback: v => CurrencyManager.getSymbol() + CurrencyManager.snap(v).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }) } } }
                    }
                });

                // 4. Revenue Trend
                if (analysisCharts.revenue) analysisCharts.revenue.destroy();
                const revCtx = document.getElementById('revenueTrendChart').getContext('2d');
                const revenueData = dates.map(d => {
                    const found = data.revenue_trend.find(i => i.date === d);
                    return found ? parseFloat(found.daily_revenue) : 0;
                });
                analysisCharts.revenue = new Chart(revCtx, {
                    type: 'line',
                    data: {
                        labels: dates.map(d => new Date(d).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })),
                        datasets: [{
                            label: 'Revenue',
                            data: revenueData.map(val => CurrencyManager.snap(CurrencyManager.convert(val, 'INR', CurrencyManager.getCode()))),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => 'Revenue: ' + CurrencyManager.getSymbol() + CurrencyManager.snap(context.parsed.y).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 })
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: v => CurrencyManager.getSymbol() + CurrencyManager.snap(v).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 })
                                }
                            },
                            x: { ticks: { autoSkip: true, maxRotation: 0 } }
                        }
                    }
                });
            }

            let isSuperAdmin = false;

            async function loadAdminProfile() {
                try {
                    const response = await fetch('../../backend/api/admin/get-profile.php');
                    const result = await response.json();

                    if (result.success) {
                        const user = result.data;
                        isSuperAdmin = (user.email === 'admin@gmail.com');

                        document.getElementById('profile-full-name').value = user.full_name || '';
                        document.getElementById('profile-email').value = user.email || '';
                        document.getElementById('profile-phone').value = user.phone || '';
                        document.getElementById('profile-address').value = user.address || '';
                        document.getElementById('profile-role').value = user.role.charAt(0).toUpperCase() + user.role.slice(1);

                        document.getElementById('profile-name-display').textContent = user.full_name || 'Admin';
                        document.getElementById('profile-role-display').textContent = isSuperAdmin ? 'Super Administrator' : 'Administrator';

                        // Header Updates
                        document.getElementById('header-name').textContent = user.full_name || 'Admin';
                        document.getElementById('header-role').textContent = isSuperAdmin ? 'Super Administrator' : 'Administrator';

                        // Nav link visibility
                        const addAdminsNav = document.getElementById('nav-add-admins');
                        if (addAdminsNav) {
                            addAdminsNav.style.display = isSuperAdmin ? 'flex' : 'none';
                        }

                        // Set Avatar Initial
                        if (user.full_name) {
                            const initials = user.full_name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                            document.getElementById('profile-avatar-large').textContent = initials;
                            document.getElementById('header-avatar').textContent = initials;
                        }

                        // Set Country/Currency inputs
                        if (user.country) {
                            document.getElementById('profile-country').value = user.country;
                            document.getElementById('profile-currency-code').value = user.currency_code;
                            document.getElementById('profile-currency-symbol').value = user.currency_symbol;
                            document.getElementById('admin-country-display').innerHTML = `${user.country} (${user.currency_symbol} ${user.currency_code})`;
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            }

            // Password Helper Functions
            function togglePasswordVisibility(fieldId) {
                const field = document.getElementById(fieldId);
                const icon = document.getElementById(fieldId + '-icon');

                if (field.type === 'password') {
                    field.type = 'text';
                    icon.src = 'https://api.iconify.design/lucide:eye-off.svg?color=%2394a3b8';
                } else {
                    field.type = 'password';
                    icon.src = 'https://api.iconify.design/lucide:eye.svg?color=%2394a3b8';
                }
            }



            function checkPasswordMatch() {
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const container = document.getElementById('password-match-container');
                const icon = document.getElementById('password-match-icon');
                const message = document.getElementById('password-match-message');

                if (!confirmPassword) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';

                if (newPassword === confirmPassword) {
                    icon.src = 'https://api.iconify.design/lucide:check-circle.svg?color=%2322c55e';
                    message.textContent = 'Passwords match';
                    message.style.color = '#22c55e';
                } else {
                    icon.src = 'https://api.iconify.design/lucide:x-circle.svg?color=%23ef4444';
                    message.textContent = 'Passwords do not match';
                    message.style.color = '#ef4444';
                }
            }

            async function handleProfileUpdate() {
                const submitBtn = document.querySelector('#profile-form button[type="submit"]');
                const originalText = submitBtn.textContent;

                // Field values
                const fullName = document.getElementById('profile-full-name').value.trim();
                const email = document.getElementById('profile-email').value.trim();
                const phone = document.getElementById('profile-phone').value.trim();
                const address = document.getElementById('profile-address').value.trim();
                const country = document.getElementById('profile-country').value;
                const currencyCode = document.getElementById('profile-currency-code').value;
                const currencySymbol = document.getElementById('profile-currency-symbol').value;

                // Security values
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                // 1. Basic Field Validations
                if (fullName.length < 3) {
                    showToast('Full name must be at least 3 characters long.', 'error');
                    return;
                }
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showToast('Please enter a valid email address.', 'error');
                    return;
                }

                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';

                    // 2. Profile Update
                    const profileResponse = await fetch('../../backend/api/admin/update-profile.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            full_name: fullName,
                            email,
                            phone,
                            address,
                            country,
                            currency_code: currencyCode,
                            currency_symbol: currencySymbol
                        })
                    });
                    const profileResult = await profileResponse.json();

                    if (!profileResult.success) {
                        throw new Error(profileResult.message);
                    }

                    // 3. Optional Password Update
                    if (currentPassword || newPassword || confirmPassword) {
                        if (!currentPassword || !newPassword || !confirmPassword) {
                            throw new Error('To change your password, please fill in all security fields.');
                        }
                        if (newPassword.length < 8) {
                            throw new Error('New password must be at least 8 characters long.');
                        }
                        if (newPassword !== confirmPassword) {
                            throw new Error('New passwords do not match.');
                        }

                        const passResponse = await fetch('../../backend/api/admin/update-password.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                current_password: currentPassword,
                                new_password: newPassword,
                                confirm_password: confirmPassword
                            })
                        });
                        const passResult = await passResponse.json();
                        if (!passResult.success) {
                            throw new Error('Profile updated, but password change failed: ' + passResult.message);
                        }
                        // Reset pass fields on success
                        document.getElementById('current-password').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-password').value = '';
                        // Hide indicators
                        document.getElementById('password-match-container').style.display = 'none';

                        showToast('Profile and password updated successfully!', 'success');
                    } else {
                        showToast('Profile updated successfully!', 'success');
                    }
                    loadAdminProfile(); // Refresh displays

                    // FORCE REFRESH CURRENCY SETTINGS & UI
                    await CurrencyManager.fetchSettings();
                    CurrencyManager.refreshUI();

                } catch (error) {
                    console.error('Update error:', error);
                    showToast(error.message || 'An error occurred while saving.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }

            async function updateSalesChart(period) {
                await loadAdminStats(period);
            }

            async function initAccessControl() {
                try {
                    const response = await fetch('../../backend/api/auth/check-session.php');
                    const data = await response.json();

                    if (data.logged_in && data.role === 'admin') {
                        const accessLevel = data.admin_access || 'all';
                        if (accessLevel === 'delivery_only') {
                            // Hide restricted sections
                            const restrictedIds = [
                                'nav-users',
                                'nav-transactions',
                                'nav-auctions',
                                'nav-activity',
                                'nav-exports',
                                'nav-analysis',
                                'nav-add-admins',
                                'view-all-logs-btn'
                            ];
                            restrictedIds.forEach(id => {
                                const el = document.getElementById(id);
                                if (el) el.style.display = 'none';
                            });
                        }
                    }
                } catch (e) {
                    console.error('Access control check failed', e);
                }
            }

            async function logout() {
                try {
                    await fetch('../../backend/api/auth/logout.php');
                    window.location.href = '../auth/login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Failed to logout', 'error');
                }
            }

            window.onload = function () {
                // Initialize Access Control
                initAccessControl();

                // Init Country Selector
                CountrySelector.init((country) => {
                    document.getElementById('profile-country').value = country.name;
                    document.getElementById('profile-currency-code').value = country.currency_code;
                    document.getElementById('profile-currency-symbol').value = country.currency_symbol;
                    document.getElementById('admin-country-display').innerHTML = `${country.name} (${country.currency_symbol} ${country.currency_code})`;
                });

                // Init currency in background - FORCE DEFAULT TO INR IF NOT SET
                if (!CurrencyManager.settings.code) {
                    CurrencyManager.settings = {
                        code: 'INR',
                        symbol: '₹',
                        rate: 1
                    };
                    localStorage.setItem('currency_settings', JSON.stringify(CurrencyManager.settings));
                }

                // If it was already set but we want to ensure Admin sees their profile currency (or INR if none)
                // We rely on CurrencyManager.init() which fetches session if available.
                // But specifically for the requirement: "make every currency as automatically to be as rupees"
                // Check if session has currency, if not, force INR.
                // Since this is JS, we can't directly check session here easily without an API.
                // However, CurrencyManager.init usually syncs with session. 
                // Let's add an explicit override if it's currently USD (default) and we want INR default.

                CurrencyManager.init().then(() => {
                    // Refetch profile to check actual user preference from DB (which init might have missed if session expired)
                    // Actually, loadAdminStats calls APIs that might use session currency.

                    // Force UI update
                    const currencySymbolElements = document.querySelectorAll('.currency-symbol');
                    currencySymbolElements.forEach(el => el.textContent = CurrencyManager.getSymbol());

                    loadAdminStats();
                });
            };
        </script>
        <div id="toast-container" class="toast-container"></div>

        <!-- Assign Agent Modal -->
        <div id="assign-agent-modal" style="display: none;"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl animate-in zoom-in-95 duration-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-stone-900">Assign Delivery Agent</h3>
                    <button onclick="closeAssignAgentModal()"
                        class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center hover:bg-stone-200">
                        <img src="https://api.iconify.design/lucide:x.svg?color=%231c1917" width="18">
                    </button>
                </div>
                <div class="mb-4">
                    <input type="text" id="agent-search-input" placeholder="Search agents..." onkeyup="filterAgents()"
                        class="w-full px-4 py-2 rounded-xl border border-stone-200 bg-stone-50 focus:border-orange-500 focus:outline-none font-medium text-sm">
                </div>
                <div id="agent-list-container" class="max-h-60 overflow-y-auto space-y-2 mb-6 pr-2">
                    <!-- Agent list populated by JS -->
                    <div class="text-center py-4 text-stone-400 text-sm">Loading agents...</div>
                </div>
                <input type="hidden" id="assign-order-id">
            </div>
        </div>

        <script>
            // ... existing scripts ...

            let currentAssignOrderId = null;
            let currentAssignType = 'order';
            let availableAgents = [];

            async function openAssignModal(orderId, type = 'order') {
                currentAssignOrderId = orderId;
                currentAssignType = type;
                document.getElementById('assign-order-id').value = orderId;
                document.getElementById('assign-agent-modal').style.display = 'flex';
                document.getElementById('agent-search-input').value = '';
                await loadDeliveryAgents();
            }

            function closeAssignAgentModal() {
                document.getElementById('assign-agent-modal').style.display = 'none';
                currentAssignOrderId = null;
            }

            async function loadDeliveryAgents() {
                const container = document.getElementById('agent-list-container');
                container.innerHTML = '<div class="text-center py-4 text-stone-400 text-sm">Loading agents...</div>';

                try {
                    // Re-use get-users.php but filter for agents client-side
                    const response = await fetch('../../backend/api/admin/get-users.php');
                    const result = await response.json();

                    if (result.success) {
                        availableAgents = result.users.filter(u => u.role === 'delivery_agent' && u.is_active == 1);
                        renderAgentsList(availableAgents);
                    } else {
                        container.innerHTML = `<div class="text-center py-4 text-red-400 text-sm">${result.message}</div>`;
                    }
                } catch (error) {
                    container.innerHTML = `<div class="text-center py-4 text-red-400 text-sm">Connection failed</div>`;
                }
            }

            function renderAgentsList(agents) {
                const container = document.getElementById('agent-list-container');
                container.innerHTML = '';

                if (agents.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-stone-400 text-sm">No active delivery agents found.</div>';
                    return;
                }

                agents.forEach(agent => {
                    container.innerHTML += `
                        <div class="flex items-center gap-4 p-4 rounded-xl border border-stone-100 hover:bg-stone-50 hover:border-orange-200 transition-all cursor-pointer group" onclick="selectAgent(${agent.id})">
                            <div class="w-12 h-12 rounded-full bg-orange-100 flex-shrink-0 flex items-center justify-center text-orange-600 font-bold text-lg">
                                ${agent.full_name.charAt(0)}
                            </div>
                            <div class="flex-grow">
                                <div class="text-base font-bold text-stone-800 group-hover:text-orange-600 transition-colors">${agent.full_name}</div>
                                <div class="text-sm text-stone-500 mt-1 leading-tight flex items-start gap-2">
                                    <img src="https://api.iconify.design/lucide:map-pin.svg?color=%2378716c" width="14" class="mt-0.5 flex-shrink-0">
                                    <span class="flex-grow">${agent.address || 'No Address'}</span>
                                </div>
                                <div class="text-sm text-stone-400 mt-2 flex items-center gap-2">
                                    <img src="https://api.iconify.design/lucide:phone.svg?color=%23a8a29e" width="14" class="flex-shrink-0">
                                    <span>${agent.phone || 'No Phone'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            function filterAgents() {
                const query = document.getElementById('agent-search-input').value.toLowerCase();
                const filtered = availableAgents.filter(a => a.full_name.toLowerCase().includes(query) || (a.phone && a.phone.includes(query)));
                renderAgentsList(filtered);
            }

            async function selectAgent(agentId) {
                if (!currentAssignOrderId) return;

                const btn = document.querySelector(`button[onclick = "selectAgent(${agentId})"]`);
                if (btn) btn.textContent = '...';

                try {
                    const response = await fetch('../../backend/api/admin/assign-delivery-agent.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            order_id: currentAssignOrderId,
                            agent_id: agentId,
                            type: currentAssignType
                        })
                    });
                    const result = await response.json();

                    if (result.success) {
                        showToast('Agent assigned successfully', 'success');
                        closeAssignAgentModal();
                        loadDeliveryOrders(); // Refresh table
                    } else {
                        showToast(result.message || 'Assignment failed', 'error');
                        if (btn) btn.textContent = 'Select';
                    }
                } catch (error) {
                    console.error('Assignment error:', error);
                    showToast('Connection error', 'error');
                    if (btn) btn.textContent = 'Select';
                }
            }
        </script>
</body>

</html>